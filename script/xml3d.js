var XML3D=XML3D||{};XML3D.version="DEVELOPMENT SNAPSHOT (12.04.2013 09:48:16 MESZ)";XML3D.xml3dNS="http://www.xml3d.org/2009/xml3d";XML3D.xhtmlNS="http://www.w3.org/1999/xhtml";XML3D.webglNS="http://www.xml3d.org/2009/xml3d/webgl";XML3D._xml3d=document.createElementNS(XML3D.xml3dNS,"xml3d");XML3D._native=!!XML3D._xml3d.style;XML3D._parallel=void 0!=XML3D._parallel?XML3D._parallel:!1;XML3D.createElement=function(b){return document.createElementNS(XML3D.xml3dNS,b)};
XML3D.extend=function(b,a){for(var f in a)if(void 0===a[f])delete b[f];else if("constructor"!==f||b!==window)b[f]=a[f];return b};XML3D.isSuperclassOf=function(b,a){for(;a&&a.superclass;){if(a.superclass===b.prototype)return!0;a=a.superclass.constructor}return!1};
XML3D.createClass=function(b,a,f){f=f||{};if(a){var d=function(){};d.prototype=a.prototype;b.prototype=new d;b.prototype.constructor=b;b.superclass=a.prototype}b.isSuperclassOf=XML3D.isSuperclassOf.bind(b,b);for(var e in f)b.prototype[e]=f[e];return b};
(function(){var b=function(){if(XML3D.document)XML3D.document.onunload()};window.addEventListener("DOMContentLoaded",function(){XML3D.css.init();var a=XML3D.debug.setup();a&&XML3D.debug.logInfo("xml3d.js version: "+XML3D.version);var b=document.querySelectorAll("xml3d"),b=Array.map(b,function(k){return k});a&&XML3D.debug.logInfo("Found "+b.length+" xml3d nodes...");if(b.length&&XML3D._native)a&&XML3D.debug.logInfo("Using native implementation.");else if(!XML3D.webgl||!XML3D.webgl.supported()){a&&
XML3D.debug.logWarning("Could not initialise WebGL, sorry :-(");for(var d=0;d<b.length;d++){var a=document.createElementNS(XML3D.xhtmlNS,"div"),e=b[d];e.parentNode.insertBefore(a,e);a.appendChild(e);a.style.display="none";var c=document.createElementNS(XML3D.xhtmlNS,"div");c.setAttribute("class",e.getAttribute("class"));c.setAttribute("style",e.getAttribute("style"));c.style.border="2px solid red";c.style.color="red";c.style.padding="10px";c.style.backgroundColor="rgba(255, 0, 0, 0.3)";var h=e.getAttribute("width");
null!==h&&(c.style.width=h);e=e.getAttribute("height");null!==e&&(c.style.height=e);e=document.createElement("h3");h=document.createTextNode("Your browser doesn't appear to support XML3D.");e.appendChild(h);h=document.createElement("p");h.appendChild(document.createTextNode("Please visit "));var g=document.createElement("a");g.setAttribute("href","http://www.xml3d.org");g.appendChild(document.createTextNode("http://www.xml3d.org"));h.appendChild(g);h.appendChild(document.createTextNode(" to get information about browsers supporting XML3D."));
c.appendChild(e);c.appendChild(h);a.parentNode.insertBefore(c,a)}}else{try{XML3D.config.configure(b)}catch(i){a&&XML3D.debug.logException(i)}try{XML3D.webgl.configure(b)}catch(k){a&&XML3D.debug.logException(k)}for(d in b)XML3D.base.sendAdapterEvent(b[d],{onConfigured:[]})}},!1);window.addEventListener("unload",b,!1);window.addEventListener("reload",b,!1)})();XML3D.setParameter=function(b,a,f){if(b=document.getElementById(b))for(var b=b.childNodes,d=0;d<b.length;d++){var e=b[d];if(e.nodeType===Node.ELEMENT_NODE&&e.name==a&&"string"===typeof f){for(;e.hasChildNodes();)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(f));return!0}}return!1};
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){window.setTimeout(b,1E3/a)}}();
(function(){XML3D.util||(XML3D.util={});var b=XML3D.util;b.dispatchEvent=function(a,d){var e=null;if(document.createEvent){e=document.createEvent("Events");e.initEvent(d,true,true);a.dispatchEvent(e)}else if(document.createEventObject){e=document.createEventObject();a.fireEvent("on"+d,e)}};b.dispatchCustomEvent=function(a,d,e,c,b){var g=document.createEvent("CustomEvent");g.initCustomEvent(d,e,c,b);a.dispatchEvent(g)};b.getStyle=function(a,d){var e="";if(document.defaultView&&document.defaultView.getComputedStyle)e=
document.defaultView.getComputedStyle(a,"").getPropertyValue(d);else if(a.currentStyle){d=d.replace(/\-(\w)/g,function(a,d){return d.toUpperCase()});e=a.currentStyle[d]}return e};b.evaluateXPathExpr=function(a,d){return document.evaluate(d,a,function(){return XML3D.xml3dNS},XPathResult.FIRST_ORDERED_NODE_TYPE,null)};var a=0;b.getOrCreateActiveView=function(b){var d=b.activeView;if(d){var e=XML3D.URIResolver.resolveLocal(d);if(!e)throw"XML3D Error: xml3d references view that is not defined: '"+d+"'.";
return e}if(e=XML3D.util.evaluateXPathExpr(b,".//xml3d:view[1]").singleNodeValue){if(e.id&&e.id.length>0)b.activeView="#"+e.id;return e}XML3D.debug.logWarning("xml3d element has no view defined: creating one.");d="xml3d.autocreatedview_"+a++;e=XML3D.createElement("view");e.setAttribute("id",d);b.appendChild(e);b.setAttribute("activeView","#"+d);return e}})();Array.forEach||(Array.forEach=function(b,a,f){for(var d=b.length,e=0;e<d;e++)e in b&&a.call(f,b[e],e,b)});
Array.map||(Array.map=function(b,a,f){for(var d=b.length,e=[],c=0;c<d;c++)c in b&&(e[c]=a.call(f,b[c],c,b));return e});Array.filter||(Array.filter=function(b,a,f){for(var d=b.length,e=[],c=0;c<d;c++)if(c in b){var h=b[c];a.call(f,h,c,b)&&e.push(h)}return e});Array.erase||(Array.erase=function(b,a){for(var f=false,d=-1;(d=b.indexOf(a))!=-1;){b.splice(d,1);f=true}return f});Array.set||(Array.set=function(b,a,f){for(var d=0;d<f.length;d++)b[a+d]=f[d]});
Array.isArray||(Array.isArray=function(b){return Object.prototype.toString.call(b)=="[object Array]"});
XML3D.debug={ALL:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4,EXCEPTION:5,params:{},isSetup:!1,loglevel:4,loglevels:{all:0,debug:1,info:2,warning:3,error:4,exception:5},setup:function(){var b=XML3D.debug;if(!b.isSetup){window.location.search.substr(1).split("&").forEach(function(a){a=a.split("=");b.params[a[0].toLowerCase()]=decodeURIComponent(a[1])});b.loglevel=b.loglevels[b.params.xml3d_loglevel]||b.params.xml3d_loglevel||b.loglevels.error;XML3D.debug.isSetup=true}return!XML3D.debug.params.xml3d_nolog},doLog:function(b,
a){if(!(XML3D.debug.params.xml3d_nolog||b<XML3D.debug.loglevel)){a=Array.prototype.slice.call(a);if(window.console)switch(b){case XML3D.debug.INFO:window.console.info.apply(window.console,a);break;case XML3D.debug.WARNING:window.console.warn.apply(window.console,a);break;case XML3D.debug.ERROR:window.console.error.apply(window.console,a);break;case XML3D.debug.EXCEPTION:window.console.error(XML3D.debug.printStackTrace({e:a[0],guess:true}).join("\n"));break;case XML3D.debug.DEBUG:window.console.debug.apply(window.console,
a)}}},logDebug:function(){XML3D.debug.doLog(XML3D.debug.DEBUG,arguments)},logInfo:function(){XML3D.debug.doLog(XML3D.debug.INFO,arguments)},logWarning:function(){XML3D.debug.doLog(XML3D.debug.WARNING,arguments)},logError:function(){XML3D.debug.doLog(XML3D.debug.ERROR,arguments)},logException:function(){XML3D.debug.doLog(XML3D.debug.EXCEPTION,arguments)},assert:function(b,a){b||XML3D.debug.doLog(XML3D.debug.WARNING,["Assertion failed in "+XML3D.debug.assert.caller.name,a])},trace:function(b,a){a=a!==
void 0?a:XML3D.debug.ERROR;if(window.console.trace){b&&XML3D.debug.doLog(a,[b]);window.console.trace()}else{var f=XML3D.debug.printStackTrace();b&&f.splice(0,0,b);XML3D.debug.doLog(a,f)}}};
XML3D.URI=function(b){b=b||"";if(b.indexOf("blob:")==0){var a=/^(?:([^:\/?\#]+):)?([^\#]*)(?:\#(.*))?/,b=b.match(a);this.valid=b!=null;this.scheme=b[1]||null;this.query=this.path=this.authority=null;this.opaqueString=b[2]||null;this.fragment=b[3]||null}else{a=/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/;b=b.match(a);this.valid=b!=null;this.scheme=b[1]||null;this.authority=b[2]||null;this.path=b[3]||null;this.query=b[4]||null;this.opaqueString=null;this.fragment=b[5]||
null}};XML3D.URI.prototype.isLocal=function(){return this.scheme!="blob"&&!this.authority&&!this.path};XML3D.URI.prototype.getAbsoluteURI=function(b){if(!this.valid||this.authority||this.scheme=="blob")return this;b=new XML3D.URI(b);if(this.path){b.path=this.path.indexOf("/")==0?this.path:b.path.substr(0,b.path.lastIndexOf("/")+1)+this.path;b.query=this.query}else if(this.query)b.query=this.query;b.fragment=this.fragment;return b};
XML3D.URI.prototype.toString=function(){var b="";if(this.scheme=="blob"){b="blob:"+this.opaqueString;this.fragment&&(b=b+("#"+this.fragment));return b}this.scheme&&(b=b+(this.scheme+":"));this.authority&&(b=b+("//"+this.authority));this.path&&(b=b+this.path);this.query&&(b=b+("?"+this.query));this.fragment&&(b=b+("#"+this.fragment));return b};
XML3D.URI.prototype.toStringWithoutFragment=function(){var b="";if(this.scheme=="blob")return b="blob:"+this.opaqueString;this.scheme&&(b=b+(this.scheme+":"));this.authority&&(b=b+("//"+this.authority));this.path&&(b=b+this.path);this.query&&(b=b+("?"+this.query));return b};XML3D.URIResolver=function(){};
XML3D.URIResolver.resolveLocal=function(b,a){typeof b=="string"&&(b=new XML3D.URI(b));a=a||window.document;return b.scheme=="urn"||b.scheme=="blob"?null:!b.path&&b.fragment?a.getElementById(b.fragment):null};XML3D.URIResolver.resolve=function(b,a){XML3D.debug.logWarning("You are using deprecated XML3D.URIResolver.resolve. Use XML3D.URIResolver.resolveLocal instead.");return XML3D.URIResolver.resolveLocal(b,a)};
(function(){XML3D.css={};XML3D.css.TRANSFORM_PROPERTY=null;XML3D.css.init=function(){"transform"in document.body.style?XML3D.css.TRANSFORM_PROPERTY="transform":"WebkitTransform"in document.body.style?XML3D.css.TRANSFORM_PROPERTY="-webkit-transform":"MozTransform"in document.body.style?XML3D.css.TRANSFORM_PROPERTY="-moz-transform":XML3D.debug.logWarning("No supported transform css property found")};XML3D.css.getInlinePropertyValue=function(b,a){var f=b.getAttribute("style");if(f)if(f=RegExp(a+"s*:([^;]+)",
"i").exec(f))return f[1].trim();return null};XML3D.css.getPropertyValue=function(b,a){var f=this.getInlinePropertyValue(b,a);return f?f:window.getComputedStyle(b).getPropertyValue(a)};XML3D.css.getCSSMatrix=function(b){if(!XML3D.css.TRANSFORM_PROPERTY||!XML3D.css.CSSMatrix)return null;var a=null;XML3D.css.TRANSFORM_PROPERTY!="transform"&&(a=XML3D.css.getInlinePropertyValue(b,"transform"));a||(a=XML3D.css.getPropertyValue(b,XML3D.css.TRANSFORM_PROPERTY));if(!a||a=="none")return null;b=null;try{b=new XML3D.css.CSSMatrix(a)}catch(f){XML3D.debug.logException(f,
"Error parsing transform property: "+a)}return b}})();var FirminCSSMatrix=function(b){this.m11=this.m22=this.m33=this.m44=1;this.m12=this.m13=this.m14=this.m21=this.m23=this.m24=this.m31=this.m32=this.m34=this.m41=this.m42=this.m43=0;typeof b=="string"&&this.setMatrixValue(b)};FirminCSSMatrix.displayName="FirminCSSMatrix";FirminCSSMatrix.degreesToRadians=function(b){return b*Math.PI/180};FirminCSSMatrix.determinant2x2=function(b,a,f,d){return b*d-a*f};
FirminCSSMatrix.determinant3x3=function(b,a,f,d,e,c,h,g,i){var k=FirminCSSMatrix.determinant2x2;return b*k(e,c,g,i)-d*k(a,f,g,i)+h*k(a,f,e,c)};FirminCSSMatrix.determinant4x4=function(b){var a=FirminCSSMatrix.determinant3x3,f=b.m21,d=b.m31,e=b.m41,c=b.m12,h=b.m22,g=b.m32,i=b.m42,k=b.m13,j=b.m23,l=b.m33,m=b.m43,x=b.m14,w=b.m24,o=b.m34,q=b.m44;return b.m11*a(h,j,w,g,l,o,i,m,q)-f*a(c,k,x,g,l,o,i,m,q)+d*a(c,k,x,h,j,w,i,m,q)-e*a(c,k,x,h,j,w,g,l,o)};
FirminCSSMatrix.toMatrixString=function(b){var a=/(\w+)\(([^\)]+)\)/i,f=b.match(/(\w+)\([^\)]+\)/ig),d=f&&f.every(function(a){return/^matrix/.test(a)});if(!f||d)return b;var e=function(a){return a.value},c={matrix:function(a,c){var d=new FirminCSSMatrix(c.unparsed);return a.multiply(d)},matrix3d:function(a,c){var d=new FirminCSSMatrix(c.unparsed);return a.multiply(d)},perspective:function(a,c){var d=new FirminCSSMatrix;d.m34=d.m34-1/c.value[0].value;return a.multiply(d)},rotate:function(a,c){return a.rotate.apply(a,
c.value.map(e))},rotate3d:function(a,c){return a.rotateAxisAngle.apply(a,c.value.map(e))},rotateX:function(a,c){return a.rotate.apply(a,[c.value[0].value,0,0])},rotateY:function(a,c){return a.rotate.apply(a,[0,c.value[0].value,0])},rotateZ:function(a,c){return a.rotate.apply(a,[0,0,c.value[0].value])},scale:function(a,c){return a.scale.apply(a,c.value.map(e))},scale3d:function(a,c){return a.scale.apply(a,c.value.map(e))},scaleX:function(a,c){return a.scale.apply(a,c.value.map(e))},scaleY:function(a,
c){return a.scale.apply(a,[0,c.value[0].value,0])},scaleZ:function(a,c){return a.scale.apply(a,[0,0,c.value[0].value])},skew:function(a,c){var d=new FirminCSSMatrix("skewX("+c.value[0].unparsed+")"),d="matrix(1.00000, "+(new FirminCSSMatrix("skewY("+c.value[1].unparsed+")")).b+", "+d.c+", 1.000000, 0.000000, 0.000000)",d=new FirminCSSMatrix(d);return a.multiply(d)},skewX:function(a,c){return a.skewX.apply(a,[c.value[0].value])},skewY:function(a,c){return a.skewY.apply(a,[c.value[0].value])},translate:function(a,
c){return a.translate.apply(a,c.value.map(e))},translate3d:function(a,c){return a.translate.apply(a,c.value.map(e))},translateX:function(a,c){return a.translate.apply(a,[c.value[0].value,0,0])},translateY:function(a,c){return a.translate.apply(a,[0,c.value[0].value,0])},translateZ:function(a,c){return a.translate.apply(a,[0,0,c.value[0].value])}},b=f.map(function(c){var d=c.match(a).slice(1);return{key:d[0],value:d[1].split(/, ?/).map(function(a){var k=a.match(/([-\+]?[0-9]+[\.0-9]*)(deg|rad|grad|px|%)*/)||
[];return{value:parseFloat(k[1]),units:k[2],unparsed:a}}),unparsed:c}}),f=new FirminCSSMatrix;return b.reduce(function(a,d){d.value=d.value.map(function(a){if(a.units=="rad"){a.value=a.value*(180/Math.PI);a.units="deg"}else if(a.units=="grad"){a.value=a.value/(400/360);a.units="deg"}return a});return(0,c[d.key])(a,d)||a},f).toString()};
[["m11","a"],["m12","b"],["m21","c"],["m22","d"],["m41","e"],["m42","f"]].forEach(function(b){var a=b[0];Object.defineProperty(FirminCSSMatrix.prototype,b[1],{set:function(b){this[a]=b},get:function(){return this[a]},enumerable:true,configurable:true})});FirminCSSMatrix.prototype.isAffine=function(){return this.m13===0&&this.m14===0&&this.m23===0&&this.m24===0&&this.m31===0&&this.m32===0&&this.m33===1&&this.m34===0&&this.m43===0&&this.m44===1};
FirminCSSMatrix.prototype.multiply=function(b){if(!b)return null;var a=new FirminCSSMatrix;a.m11=b.m11*this.m11+b.m12*this.m21+b.m13*this.m31+b.m14*this.m41;a.m12=b.m11*this.m12+b.m12*this.m22+b.m13*this.m32+b.m14*this.m42;a.m13=b.m11*this.m13+b.m12*this.m23+b.m13*this.m33+b.m14*this.m43;a.m14=b.m11*this.m14+b.m12*this.m24+b.m13*this.m34+b.m14*this.m44;a.m21=b.m21*this.m11+b.m22*this.m21+b.m23*this.m31+b.m24*this.m41;a.m22=b.m21*this.m12+b.m22*this.m22+b.m23*this.m32+b.m24*this.m42;a.m23=b.m21*this.m13+
b.m22*this.m23+b.m23*this.m33+b.m24*this.m43;a.m24=b.m21*this.m14+b.m22*this.m24+b.m23*this.m34+b.m24*this.m44;a.m31=b.m31*this.m11+b.m32*this.m21+b.m33*this.m31+b.m34*this.m41;a.m32=b.m31*this.m12+b.m32*this.m22+b.m33*this.m32+b.m34*this.m42;a.m33=b.m31*this.m13+b.m32*this.m23+b.m33*this.m33+b.m34*this.m43;a.m34=b.m31*this.m14+b.m32*this.m24+b.m33*this.m34+b.m34*this.m44;a.m41=b.m41*this.m11+b.m42*this.m21+b.m43*this.m31+b.m44*this.m41;a.m42=b.m41*this.m12+b.m42*this.m22+b.m43*this.m32+b.m44*this.m42;
a.m43=b.m41*this.m13+b.m42*this.m23+b.m43*this.m33+b.m44*this.m43;a.m44=b.m41*this.m14+b.m42*this.m24+b.m43*this.m34+b.m44*this.m44;return a};FirminCSSMatrix.prototype.isIdentityOrTranslation=function(){return this.m11===1&&this.m12===0&&this.m13===0&&this.m14===0&&this.m21===0&&this.m22===1&&this.m23===0&&this.m24===0&&this.m31===0&&this.m31===0&&this.m33===1&&this.m34===0&&this.m44===1};
FirminCSSMatrix.prototype.adjoint=function(){var b=new FirminCSSMatrix,a=FirminCSSMatrix.determinant3x3,f=this.m11,d=this.m12,e=this.m13,c=this.m14,h=this.m21,g=this.m22,i=this.m23,k=this.m24,j=this.m31,l=this.m32,m=this.m33,x=this.m34,w=this.m41,o=this.m42,q=this.m43,s=this.m44;b.m11=a(g,l,o,i,m,q,k,x,s);b.m21=-a(h,j,w,i,m,q,k,x,s);b.m31=a(h,j,w,g,l,o,k,x,s);b.m41=-a(h,j,w,g,l,o,i,m,q);b.m12=-a(d,l,o,e,m,q,c,x,s);b.m22=a(f,j,w,e,m,q,c,x,s);b.m32=-a(f,j,w,d,l,o,c,x,s);b.m42=a(f,j,w,d,l,o,e,m,q);b.m13=
a(d,g,o,e,i,q,c,k,s);b.m23=-a(f,h,w,e,i,q,c,k,s);b.m33=a(f,h,w,d,g,o,c,k,s);b.m43=-a(f,h,w,d,g,o,e,i,q);b.m14=-a(d,g,l,e,i,m,c,k,x);b.m24=a(f,h,j,e,i,m,c,k,x);b.m34=-a(f,h,j,d,g,l,c,k,x);b.m44=a(f,h,j,d,g,l,e,i,m);return b};
FirminCSSMatrix.prototype.inverse=function(){var b,a,f,d;if(this.isIdentityOrTranslation()){b=new FirminCSSMatrix;if(!(this.m41===0&&this.m42===0&&this.m43===0)){b.m41=-this.m41;b.m42=-this.m42;b.m43=-this.m43}return b}a=this.adjoint();b=FirminCSSMatrix.determinant4x4(this);if(Math.abs(b)<1.0E-8)return null;for(f=1;f<5;f++)for(d=1;d<5;d++)a["m"+f+d]=a["m"+f+d]/b;return a};
FirminCSSMatrix.prototype.rotate=function(b,a,f){var d=FirminCSSMatrix.degreesToRadians;if(typeof b!="number"||isNaN(b))b=0;if((typeof a!="number"||isNaN(a))&&(typeof f!="number"||isNaN(f))){f=b;a=b=0}if(typeof a!="number"||isNaN(a))a=0;if(typeof f!="number"||isNaN(f))f=0;var b=d(b),a=d(a),f=d(f),d=new FirminCSSMatrix,e=new FirminCSSMatrix,c=new FirminCSSMatrix,h,f=f/2;h=Math.sin(f);f=Math.cos(f);c.m11=c.m22=1-2*h*h;c.m12=c.m21=2*h*f;c.m21=c.m21*-1;a=a/2;h=Math.sin(a);f=Math.cos(a);e.m11=e.m33=1-
2*h*h;e.m13=e.m31=2*h*f;e.m13=e.m13*-1;b=b/2;h=Math.sin(b);f=Math.cos(b);d.m22=d.m33=1-2*h*h;d.m23=d.m32=2*h*f;d.m32=d.m32*-1;return this.toString()===(new FirminCSSMatrix).toString()?c.multiply(e).multiply(d):this.multiply(d).multiply(e).multiply(c)};
FirminCSSMatrix.prototype.rotateAxisAngle=function(b,a,f,d){if(typeof b!="number"||isNaN(b))b=0;if(typeof a!="number"||isNaN(a))a=0;if(typeof f!="number"||isNaN(f))f=0;if(typeof d!="number"||isNaN(d))d=0;b===0&&a===0&&f===0&&(f=1);var e=new FirminCSSMatrix,c=Math.sqrt(b*b+a*a+f*f),h,g,i,d=(FirminCSSMatrix.degreesToRadians(d)||0)/2;h=Math.cos(d);g=Math.sin(d);d=g*g;if(c===0){a=b=0;f=1}else if(c!==1){b=b/c;a=a/c;f=f/c}if(b===1&&a===0&&f===0){e.m22=e.m33=1-2*d;e.m23=e.m32=2*h*g;e.m32=e.m32*-1}else if(b===
0&&a===1&&f===0){e.m11=e.m33=1-2*d;e.m13=e.m31=2*h*g;e.m13=e.m13*-1}else if(b===0&&a===0&&f===1){e.m11=e.m22=1-2*d;e.m12=e.m21=2*h*g;e.m21=e.m21*-1}else{c=g*h;h=b*b;g=a*a;i=f*f;e.m11=1-2*(g+i)*d;e.m12=2*(b*a*d+f*c);e.m13=2*(b*f*d-a*c);e.m21=2*(a*b*d-f*c);e.m22=1-2*(i+h)*d;e.m23=2*(a*f*d+b*c);e.m31=2*(f*b*d+a*c);e.m32=2*(f*a*d-b*c);e.m33=1-2*(h+g)*d}return this.multiply(e)};
FirminCSSMatrix.prototype.scale=function(b,a,f){var d=new FirminCSSMatrix;if(typeof b!="number"||isNaN(b))b=1;if(typeof a!="number"||isNaN(a))a=b;if(typeof f!="number"||isNaN(f))f=1;d.m11=b;d.m22=a;d.m33=f;return this.multiply(d)};FirminCSSMatrix.prototype.skewX=function(b){var b=FirminCSSMatrix.degreesToRadians(b),a=new FirminCSSMatrix;a.c=Math.tan(b);return this.multiply(a)};
FirminCSSMatrix.prototype.skewY=function(b){var b=FirminCSSMatrix.degreesToRadians(b),a=new FirminCSSMatrix;a.b=Math.tan(b);return this.multiply(a)};FirminCSSMatrix.prototype.translate=function(b,a,f){var d=new FirminCSSMatrix;if(typeof b!="number"||isNaN(b))b=0;if(typeof a!="number"||isNaN(a))a=0;if(typeof f!="number"||isNaN(f))f=0;d.m41=b;d.m42=a;d.m43=f;return this.multiply(d)};
FirminCSSMatrix.prototype.setMatrixValue=function(b){var b=FirminCSSMatrix.toMatrixString(b.trim()),a=b.match(/^matrix(3d)?\(\s*(.+)\s*\)$/),f,d,e,c;if(a){b=!!a[1];a=a[2].split(/\s*,\s*/);f=a.length;d=Array(f);if(!(b&&f!==16)&&(b||f===6)){for(e=0;e<f;e++){c=a[e];if(c.match(/^-?\d+(\.\d+)?$/))d[e]=parseFloat(c);else return}for(e=0;e<f;e++)this[b?"m"+(Math.floor(e/4)+1)+(e%4+1):String.fromCharCode(e+97)]=d[e]}}};
FirminCSSMatrix.prototype.toString=function(){var b=this,a,f;if(this.isAffine()){f="matrix(";a=["a","b","c","d","e","f"]}else{f="matrix3d(";a=["m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44"]}return f+a.map(function(a){return b[a].toFixed(6)}).join(", ")+")"};XML3D.css.CSSMatrix=FirminCSSMatrix;
XML3D.css.convertCssToMat4=function(b,a){var f=a||XML3D.math.mat4.create();f[0]=b.m11;f[1]=b.m12;f[2]=b.m13;f[3]=b.m14;f[4]=b.m21;f[5]=b.m22;f[6]=b.m23;f[7]=b.m24;f[8]=b.m31;f[9]=b.m32;f[10]=b.m33;f[11]=b.m34;f[12]=b.m41;f[13]=b.m42;f[14]=b.m43;f[15]=b.m44;return f};XML3D.math={};var exports=XML3D.math,define={},GLU={};
(function(b){b.unProject=function(a,f,d,e,c,h,g){a=[a,f,d,1];f=[];b.multMatrices(e,c,f);if(!b.invertMatrix(f,f))return!1;a[0]=(a[0]-h[0])/h[2];a[1]=(a[1]-h[1])/h[3];a[0]=2*a[0]-1;a[1]=2*a[1]-1;a[2]=2*a[2]-1;e=[];b.multMatrixVec(f,a,e);if(0===e[3])return!1;e[0]/=e[3];e[1]/=e[3];e[2]/=e[3];g[0]=e[0];g[1]=e[1];g[2]=e[2];return!0};b.multMatrixVec=function(a,b,d){for(var e=0;4>e;e+=1)d[e]=b[0]*a[0+e]+b[1]*a[4+e]+b[2]*a[8+e]+b[3]*a[12+e]};b.multMatrices=function(a,b,d){for(var e=0;4>e;e+=1)for(var c=0;4>
c;c+=1)d[4*e+c]=a[4*e+0]*b[0+c]+a[4*e+1]*b[4+c]+a[4*e+2]*b[8+c]+a[4*e+3]*b[12+c]};b.invertMatrix=function(a,b){var d=[];d[0]=a[5]*a[10]*a[15]-a[5]*a[11]*a[14]-a[9]*a[6]*a[15]+a[9]*a[7]*a[14]+a[13]*a[6]*a[11]-a[13]*a[7]*a[10];d[4]=-a[4]*a[10]*a[15]+a[4]*a[11]*a[14]+a[8]*a[6]*a[15]-a[8]*a[7]*a[14]-a[12]*a[6]*a[11]+a[12]*a[7]*a[10];d[8]=a[4]*a[9]*a[15]-a[4]*a[11]*a[13]-a[8]*a[5]*a[15]+a[8]*a[7]*a[13]+a[12]*a[5]*a[11]-a[12]*a[7]*a[9];d[12]=-a[4]*a[9]*a[14]+a[4]*a[10]*a[13]+a[8]*a[5]*a[14]-a[8]*a[6]*a[13]-
a[12]*a[5]*a[10]+a[12]*a[6]*a[9];d[1]=-a[1]*a[10]*a[15]+a[1]*a[11]*a[14]+a[9]*a[2]*a[15]-a[9]*a[3]*a[14]-a[13]*a[2]*a[11]+a[13]*a[3]*a[10];d[5]=a[0]*a[10]*a[15]-a[0]*a[11]*a[14]-a[8]*a[2]*a[15]+a[8]*a[3]*a[14]+a[12]*a[2]*a[11]-a[12]*a[3]*a[10];d[9]=-a[0]*a[9]*a[15]+a[0]*a[11]*a[13]+a[8]*a[1]*a[15]-a[8]*a[3]*a[13]-a[12]*a[1]*a[11]+a[12]*a[3]*a[9];d[13]=a[0]*a[9]*a[14]-a[0]*a[10]*a[13]-a[8]*a[1]*a[14]+a[8]*a[2]*a[13]+a[12]*a[1]*a[10]-a[12]*a[2]*a[9];d[2]=a[1]*a[6]*a[15]-a[1]*a[7]*a[14]-a[5]*a[2]*a[15]+
a[5]*a[3]*a[14]+a[13]*a[2]*a[7]-a[13]*a[3]*a[6];d[6]=-a[0]*a[6]*a[15]+a[0]*a[7]*a[14]+a[4]*a[2]*a[15]-a[4]*a[3]*a[14]-a[12]*a[2]*a[7]+a[12]*a[3]*a[6];d[10]=a[0]*a[5]*a[15]-a[0]*a[7]*a[13]-a[4]*a[1]*a[15]+a[4]*a[3]*a[13]+a[12]*a[1]*a[7]-a[12]*a[3]*a[5];d[14]=-a[0]*a[5]*a[14]+a[0]*a[6]*a[13]+a[4]*a[1]*a[14]-a[4]*a[2]*a[13]-a[12]*a[1]*a[6]+a[12]*a[2]*a[5];d[3]=-a[1]*a[6]*a[11]+a[1]*a[7]*a[10]+a[5]*a[2]*a[11]-a[5]*a[3]*a[10]-a[9]*a[2]*a[7]+a[9]*a[3]*a[6];d[7]=a[0]*a[6]*a[11]-a[0]*a[7]*a[10]-a[4]*a[2]*
a[11]+a[4]*a[3]*a[10]+a[8]*a[2]*a[7]-a[8]*a[3]*a[6];d[11]=-a[0]*a[5]*a[11]+a[0]*a[7]*a[9]+a[4]*a[1]*a[11]-a[4]*a[3]*a[9]-a[8]*a[1]*a[7]+a[8]*a[3]*a[5];d[15]=a[0]*a[5]*a[10]-a[0]*a[6]*a[9]-a[4]*a[1]*a[10]+a[4]*a[2]*a[9]+a[8]*a[1]*a[6]-a[8]*a[2]*a[5];var e=a[0]*d[0]+a[1]*d[4]+a[2]*d[8]+a[3]*d[12];if(0===e)return!1;for(var e=1/e,c=0;16>c;c+=1)b[c]=d[c]*e;return!0}})(GLU);
(function(){var b;"undefined"===typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(b={},define(function(){return b})):b=window:b=exports;(function(a){if(!b)var b=1.0E-6;if(!d)var d=typeof Float32Array!=="undefined"?Float32Array:Array;var e={setMatrixArrayType:function(a){d=a}};if(typeof a!=="undefined")a.glMatrix=e;var c={create:function(){var a=new d(2);a[0]=0;a[1]=0;return a},clone:function(a){var c=new d(2);c[0]=a[0];c[1]=a[1];return c},fromValues:function(a,c){var e=
new d(2);e[0]=a;e[1]=c;return e},copy:function(a,c){a[0]=c[0];a[1]=c[1];return a},set:function(a,c,d){a[0]=c;a[1]=d;return a},add:function(a,c,d){a[0]=c[0]+d[0];a[1]=c[1]+d[1];return a},subtract:function(a,c,d){a[0]=c[0]-d[0];a[1]=c[1]-d[1];return a}};c.sub=c.subtract;c.multiply=function(a,c,d){a[0]=c[0]*d[0];a[1]=c[1]*d[1];return a};c.mul=c.multiply;c.divide=function(a,c,d){a[0]=c[0]/d[0];a[1]=c[1]/d[1];return a};c.div=c.divide;c.min=function(a,c,d){a[0]=Math.min(c[0],d[0]);a[1]=Math.min(c[1],d[1]);
return a};c.max=function(a,c,d){a[0]=Math.max(c[0],d[0]);a[1]=Math.max(c[1],d[1]);return a};c.scale=function(a,c,d){a[0]=c[0]*d;a[1]=c[1]*d;return a};c.distance=function(a,c){var d=c[0]-a[0],e=c[1]-a[1];return Math.sqrt(d*d+e*e)};c.dist=c.distance;c.squaredDistance=function(a,c){var d=c[0]-a[0],e=c[1]-a[1];return d*d+e*e};c.sqrDist=c.squaredDistance;c.length=function(a){var c=a[0],a=a[1];return Math.sqrt(c*c+a*a)};c.len=c.length;c.squaredLength=function(a){var c=a[0],a=a[1];return c*c+a*a};c.sqrLen=
c.squaredLength;c.negate=function(a,c){a[0]=-c[0];a[1]=-c[1];return a};c.normalize=function(a,c){var d=c[0],e=c[1],d=d*d+e*e;if(d>0){d=1/Math.sqrt(d);a[0]=c[0]*d;a[1]=c[1]*d}return a};c.dot=function(a,c){return a[0]*c[0]+a[1]*c[1]};c.cross=function(a,c,d){c=c[0]*d[1]-c[1]*d[0];a[0]=a[1]=0;a[2]=c;return a};c.lerp=function(a,c,d,e){var b=c[0],c=c[1];a[0]=b+e*(d[0]-b);a[1]=c+e*(d[1]-c);return a};c.transformMat2=function(a,c,d){var e=c[0],c=c[1];a[0]=e*d[0]+c*d[1];a[1]=e*d[2]+c*d[3];return a};c.forEach=
function(){var a=c.create();return function(c,d,e,b,f,h){d||(d=2);e||(e=0);for(b=b?Math.min(b*d+e,c.length):c.length;e<b;e=e+d){a[0]=c[e];a[1]=c[e+1];f(a,a,h);c[e]=a[0];c[e+1]=a[1]}return c}}();c.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof a!=="undefined")a.vec2=c;var h={create:function(){var a=new d(3);a[0]=0;a[1]=0;a[2]=0;return a},clone:function(a){var c=new d(3);c[0]=a[0];c[1]=a[1];c[2]=a[2];return c},fromValues:function(a,c,e){var b=new d(3);b[0]=a;b[1]=c;b[2]=e;return b},copy:function(a,
c){a[0]=c[0];a[1]=c[1];a[2]=c[2];return a},set:function(a,c,d,e){a[0]=c;a[1]=d;a[2]=e;return a},add:function(a,c,d){a[0]=c[0]+d[0];a[1]=c[1]+d[1];a[2]=c[2]+d[2];return a},subtract:function(a,c,d){a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];return a}};h.sub=h.subtract;h.multiply=function(a,c,d){a[0]=c[0]*d[0];a[1]=c[1]*d[1];a[2]=c[2]*d[2];return a};h.mul=h.multiply;h.divide=function(a,c,d){a[0]=c[0]/d[0];a[1]=c[1]/d[1];a[2]=c[2]/d[2];return a};h.div=h.divide;h.min=function(a,c,d){a[0]=Math.min(c[0],
d[0]);a[1]=Math.min(c[1],d[1]);a[2]=Math.min(c[2],d[2]);return a};h.max=function(a,c,d){a[0]=Math.max(c[0],d[0]);a[1]=Math.max(c[1],d[1]);a[2]=Math.max(c[2],d[2]);return a};h.scale=function(a,c,d){a[0]=c[0]*d;a[1]=c[1]*d;a[2]=c[2]*d;return a};h.distance=function(a,c){var d=c[0]-a[0],e=c[1]-a[1],b=c[2]-a[2];return Math.sqrt(d*d+e*e+b*b)};h.dist=h.distance;h.squaredDistance=function(a,c){var d=c[0]-a[0],e=c[1]-a[1],b=c[2]-a[2];return d*d+e*e+b*b};h.sqrDist=h.squaredDistance;h.length=function(a){var c=
a[0],d=a[1],a=a[2];return Math.sqrt(c*c+d*d+a*a)};h.len=h.length;h.squaredLength=function(a){var c=a[0],d=a[1],a=a[2];return c*c+d*d+a*a};h.sqrLen=h.squaredLength;h.negate=function(a,c){a[0]=-c[0];a[1]=-c[1];a[2]=-c[2];return a};h.normalize=function(a,c){var d=c[0],e=c[1],b=c[2],d=d*d+e*e+b*b;if(d>0){d=1/Math.sqrt(d);a[0]=c[0]*d;a[1]=c[1]*d;a[2]=c[2]*d}return a};h.dot=function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]};h.cross=function(a,c,d){var e=c[0],b=c[1],c=c[2],f=d[0],h=d[1],d=d[2];a[0]=b*d-
c*h;a[1]=c*f-e*d;a[2]=e*h-b*f;return a};h.lerp=function(a,c,d,e){var b=c[0],f=c[1],c=c[2];a[0]=b+e*(d[0]-b);a[1]=f+e*(d[1]-f);a[2]=c+e*(d[2]-c);return a};h.transformMat4=function(a,c,d){var e=c[0],b=c[1],c=c[2];a[0]=d[0]*e+d[4]*b+d[8]*c+d[12];a[1]=d[1]*e+d[5]*b+d[9]*c+d[13];a[2]=d[2]*e+d[6]*b+d[10]*c+d[14];return a};h.transformQuat=function(a,c,d){var e=c[0],b=c[1],f=c[2],c=d[0],h=d[1],g=d[2],d=d[3],i=d*e+h*f-g*b,n=d*b+g*e-c*f,p=d*f+c*b-h*e,e=-c*e-h*b-g*f;a[0]=i*d+e*-c+n*-g-p*-h;a[1]=n*d+e*-h+p*-c-
i*-g;a[2]=p*d+e*-g+i*-h-n*-c;return a};h.forEach=function(){var a=h.create();return function(c,d,e,b,f,h){d||(d=3);e||(e=0);for(b=b?Math.min(b*d+e,c.length):c.length;e<b;e=e+d){a[0]=c[e];a[1]=c[e+1];a[2]=c[e+2];f(a,a,h);c[e]=a[0];c[e+1]=a[1];c[e+2]=a[2]}return c}}();h.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof a!=="undefined")a.vec3=h;var g={create:function(){var a=new d(4);a[0]=0;a[1]=0;a[2]=0;a[3]=0;return a},clone:function(a){var c=new d(4);c[0]=a[0];c[1]=a[1];c[2]=a[2];
c[3]=a[3];return c},fromValues:function(a,c,e,b){var f=new d(4);f[0]=a;f[1]=c;f[2]=e;f[3]=b;return f},copy:function(a,c){a[0]=c[0];a[1]=c[1];a[2]=c[2];a[3]=c[3];return a},set:function(a,c,d,e,b){a[0]=c;a[1]=d;a[2]=e;a[3]=b;return a},add:function(a,c,d){a[0]=c[0]+d[0];a[1]=c[1]+d[1];a[2]=c[2]+d[2];a[3]=c[3]+d[3];return a},subtract:function(a,c,d){a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];a[3]=c[3]-d[3];return a}};g.sub=g.subtract;g.multiply=function(a,c,d){a[0]=c[0]*d[0];a[1]=c[1]*d[1];a[2]=c[2]*
d[2];a[3]=c[3]*d[3];return a};g.mul=g.multiply;g.divide=function(a,c,d){a[0]=c[0]/d[0];a[1]=c[1]/d[1];a[2]=c[2]/d[2];a[3]=c[3]/d[3];return a};g.div=g.divide;g.min=function(a,c,d){a[0]=Math.min(c[0],d[0]);a[1]=Math.min(c[1],d[1]);a[2]=Math.min(c[2],d[2]);a[3]=Math.min(c[3],d[3]);return a};g.max=function(a,c,d){a[0]=Math.max(c[0],d[0]);a[1]=Math.max(c[1],d[1]);a[2]=Math.max(c[2],d[2]);a[3]=Math.max(c[3],d[3]);return a};g.scale=function(a,c,d){a[0]=c[0]*d;a[1]=c[1]*d;a[2]=c[2]*d;a[3]=c[3]*d;return a};
g.distance=function(a,c){var d=c[0]-a[0],e=c[1]-a[1],b=c[2]-a[2],f=c[3]-a[3];return Math.sqrt(d*d+e*e+b*b+f*f)};g.dist=g.distance;g.squaredDistance=function(a,c){var d=c[0]-a[0],e=c[1]-a[1],b=c[2]-a[2],f=c[3]-a[3];return d*d+e*e+b*b+f*f};g.sqrDist=g.squaredDistance;g.length=function(a){var c=a[0],d=a[1],e=a[2],a=a[3];return Math.sqrt(c*c+d*d+e*e+a*a)};g.len=g.length;g.squaredLength=function(a){var c=a[0],d=a[1],e=a[2],a=a[3];return c*c+d*d+e*e+a*a};g.sqrLen=g.squaredLength;g.negate=function(a,c){a[0]=
-c[0];a[1]=-c[1];a[2]=-c[2];a[3]=-c[3];return a};g.normalize=function(a,c){var d=c[0],e=c[1],b=c[2],f=c[3],d=d*d+e*e+b*b+f*f;if(d>0){d=1/Math.sqrt(d);a[0]=c[0]*d;a[1]=c[1]*d;a[2]=c[2]*d;a[3]=c[3]*d}return a};g.dot=function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3]*c[3]};g.lerp=function(a,c,d,e){var b=c[0],f=c[1],h=c[2],c=c[3];a[0]=b+e*(d[0]-b);a[1]=f+e*(d[1]-f);a[2]=h+e*(d[2]-h);a[3]=c+e*(d[3]-c);return a};g.transformMat4=function(a,c,d){var e=c[0],b=c[1],f=c[2],c=c[3];a[0]=d[0]*e+d[4]*b+d[8]*
f+d[12]*c;a[1]=d[1]*e+d[5]*b+d[9]*f+d[13]*c;a[2]=d[2]*e+d[6]*b+d[10]*f+d[14]*c;a[3]=d[3]*e+d[7]*b+d[11]*f+d[15]*c;return a};g.transformQuat=function(a,c,d){var e=c[0],b=c[1],f=c[2],c=d[0],h=d[1],g=d[2],d=d[3],i=d*e+h*f-g*b,n=d*b+g*e-c*f,p=d*f+c*b-h*e,e=-c*e-h*b-g*f;a[0]=i*d+e*-c+n*-g-p*-h;a[1]=n*d+e*-h+p*-c-i*-g;a[2]=p*d+e*-g+i*-h-n*-c;return a};g.forEach=function(){var a=g.create();return function(c,d,e,b,f,h){d||(d=4);e||(e=0);for(b=b?Math.min(b*d+e,c.length):c.length;e<b;e=e+d){a[0]=c[e];a[1]=
c[e+1];a[2]=c[e+2];a[3]=c[e+3];f(a,a,h);c[e]=a[0];c[e+1]=a[1];c[e+2]=a[2];c[e+3]=a[3]}return c}}();g.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof a!=="undefined")a.vec4=g;e={};new Float32Array([1,0,0,1]);e.create=function(){var a=new d(4);a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a};e.clone=function(a){var c=new d(4);c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];return c};e.copy=function(a,c){a[0]=c[0];a[1]=c[1];a[2]=c[2];a[3]=c[3];return a};e.identity=function(a){a[0]=1;a[1]=
0;a[2]=0;a[3]=1;return a};e.transpose=function(a,c){if(a===c){var d=c[1];a[1]=c[2];a[2]=d}else{a[0]=c[0];a[1]=c[2];a[2]=c[1];a[3]=c[3]}return a};e.invert=function(a,c){var d=c[0],e=c[1],b=c[2],f=c[3],h=d*f-b*e;if(!h)return null;h=1/h;a[0]=f*h;a[1]=-e*h;a[2]=-b*h;a[3]=d*h;return a};e.adjoint=function(a,c){var d=c[0];a[0]=c[3];a[1]=-c[1];a[2]=-c[2];a[3]=d;return a};e.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};e.multiply=function(a,c,d){var e=c[0],b=c[1],f=c[2],c=c[3],h=d[0],g=d[1],i=d[2],d=
d[3];a[0]=e*h+b*i;a[1]=e*g+b*d;a[2]=f*h+c*i;a[3]=f*g+c*d;return a};e.mul=e.multiply;e.rotate=function(a,c,d){var e=c[0],b=c[1],f=c[2],c=c[3],h=Math.sin(d),d=Math.cos(d);a[0]=e*d+b*h;a[1]=e*-h+b*d;a[2]=f*d+c*h;a[3]=f*-h+c*d;return a};e.scale=function(a,c,d){var e=c[1],b=c[2],f=c[3],h=d[0],d=d[1];a[0]=c[0]*h;a[1]=e*d;a[2]=b*h;a[3]=f*d;return a};e.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof a!=="undefined")a.mat2=e;e={};new Float32Array([1,0,0,0,1,0,0,0,1]);e.create=
function(){var a=new d(9);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};e.clone=function(a){var c=new d(9);c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[8]=a[8];return c};e.copy=function(a,c){a[0]=c[0];a[1]=c[1];a[2]=c[2];a[3]=c[3];a[4]=c[4];a[5]=c[5];a[6]=c[6];a[7]=c[7];a[8]=c[8];return a};e.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};e.transpose=function(a,c){if(a===c){var d=c[1],e=c[2],
b=c[5];a[1]=c[3];a[2]=c[6];a[3]=d;a[5]=c[7];a[6]=e;a[7]=b}else{a[0]=c[0];a[1]=c[3];a[2]=c[6];a[3]=c[1];a[4]=c[4];a[5]=c[7];a[6]=c[2];a[7]=c[5];a[8]=c[8]}return a};e.invert=function(a,c){var d=c[0],e=c[1],b=c[2],f=c[3],h=c[4],g=c[5],i=c[6],n=c[7],p=c[8],r=p*h-g*n,v=-p*f+g*i,t=n*f-h*i,u=d*r+e*v+b*t;if(!u)return null;u=1/u;a[0]=r*u;a[1]=(-p*e+b*n)*u;a[2]=(g*e-b*h)*u;a[3]=v*u;a[4]=(p*d-b*i)*u;a[5]=(-g*d+b*f)*u;a[6]=t*u;a[7]=(-n*d+e*i)*u;a[8]=(h*d-e*f)*u;return a};e.adjoint=function(a,c){var d=c[0],e=
c[1],b=c[2],f=c[3],h=c[4],g=c[5],i=c[6],n=c[7],p=c[8];a[0]=h*p-g*n;a[1]=b*n-e*p;a[2]=e*g-b*h;a[3]=g*i-f*p;a[4]=d*p-b*i;a[5]=b*f-d*g;a[6]=f*n-h*i;a[7]=e*i-d*n;a[8]=d*h-e*f;return a};e.determinant=function(a){var c=a[3],d=a[4],e=a[5],b=a[6],f=a[7],h=a[8];return a[0]*(h*d-e*f)+a[1]*(-h*c+e*b)+a[2]*(f*c-d*b)};e.multiply=function(a,c,d){var e=c[0],b=c[1],f=c[2],h=c[3],g=c[4],i=c[5],n=c[6],p=c[7],c=c[8],r=d[0],v=d[1],t=d[2],u=d[3],y=d[4],z=d[5],A=d[6],B=d[7],d=d[8];a[0]=r*e+v*h+t*n;a[1]=r*b+v*g+t*p;a[2]=
r*f+v*i+t*c;a[3]=u*e+y*h+z*n;a[4]=u*b+y*g+z*p;a[5]=u*f+y*i+z*c;a[6]=A*e+B*h+d*n;a[7]=A*b+B*g+d*p;a[8]=A*f+B*i+d*c;return a};e.mul=e.multiply;e.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};if(typeof a!=="undefined")a.mat3=e;var i={};new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);i.create=function(){var a=new d(16);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=
0;a[15]=1;return a};i.clone=function(a){var c=new d(16);c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[8]=a[8];c[9]=a[9];c[10]=a[10];c[11]=a[11];c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c};i.copy=function(a,c){a[0]=c[0];a[1]=c[1];a[2]=c[2];a[3]=c[3];a[4]=c[4];a[5]=c[5];a[6]=c[6];a[7]=c[7];a[8]=c[8];a[9]=c[9];a[10]=c[10];a[11]=c[11];a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15];return a};i.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=
1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};i.transpose=function(a,c){if(a===c){var d=c[1],e=c[2],b=c[3],f=c[6],h=c[7],g=c[11];a[1]=c[4];a[2]=c[8];a[3]=c[12];a[4]=d;a[6]=c[9];a[7]=c[13];a[8]=e;a[9]=f;a[11]=c[14];a[12]=b;a[13]=h;a[14]=g}else{a[0]=c[0];a[1]=c[4];a[2]=c[8];a[3]=c[12];a[4]=c[1];a[5]=c[5];a[6]=c[9];a[7]=c[13];a[8]=c[2];a[9]=c[6];a[10]=c[10];a[11]=c[14];a[12]=c[3];a[13]=c[7];a[14]=c[11];a[15]=c[15]}return a};i.invert=function(a,c){var d=c[0],
e=c[1],b=c[2],f=c[3],h=c[4],g=c[5],i=c[6],n=c[7],p=c[8],r=c[9],v=c[10],t=c[11],u=c[12],y=c[13],z=c[14],A=c[15],B=d*g-e*h,E=d*i-b*h,C=d*n-f*h,D=e*i-b*g,G=e*n-f*g,H=b*n-f*i,I=p*y-r*u,J=p*z-v*u,K=p*A-t*u,L=r*z-v*y,M=r*A-t*y,N=v*A-t*z,F=B*N-E*M+C*L+D*K-G*J+H*I;if(!F)return null;F=1/F;a[0]=(g*N-i*M+n*L)*F;a[1]=(b*M-e*N-f*L)*F;a[2]=(y*H-z*G+A*D)*F;a[3]=(v*G-r*H-t*D)*F;a[4]=(i*K-h*N-n*J)*F;a[5]=(d*N-b*K+f*J)*F;a[6]=(z*C-u*H-A*E)*F;a[7]=(p*H-v*C+t*E)*F;a[8]=(h*M-g*K+n*I)*F;a[9]=(e*K-d*M-f*I)*F;a[10]=(u*G-
y*C+A*B)*F;a[11]=(r*C-p*G-t*B)*F;a[12]=(g*J-h*L-i*I)*F;a[13]=(d*L-e*J+b*I)*F;a[14]=(y*E-u*D-z*B)*F;a[15]=(p*D-r*E+v*B)*F;return a};i.adjoint=function(a,c){var d=c[0],e=c[1],b=c[2],f=c[3],h=c[4],g=c[5],i=c[6],n=c[7],p=c[8],r=c[9],v=c[10],t=c[11],u=c[12],y=c[13],z=c[14],A=c[15];a[0]=g*(v*A-t*z)-r*(i*A-n*z)+y*(i*t-n*v);a[1]=-(e*(v*A-t*z)-r*(b*A-f*z)+y*(b*t-f*v));a[2]=e*(i*A-n*z)-g*(b*A-f*z)+y*(b*n-f*i);a[3]=-(e*(i*t-n*v)-g*(b*t-f*v)+r*(b*n-f*i));a[4]=-(h*(v*A-t*z)-p*(i*A-n*z)+u*(i*t-n*v));a[5]=d*(v*
A-t*z)-p*(b*A-f*z)+u*(b*t-f*v);a[6]=-(d*(i*A-n*z)-h*(b*A-f*z)+u*(b*n-f*i));a[7]=d*(i*t-n*v)-h*(b*t-f*v)+p*(b*n-f*i);a[8]=h*(r*A-t*y)-p*(g*A-n*y)+u*(g*t-n*r);a[9]=-(d*(r*A-t*y)-p*(e*A-f*y)+u*(e*t-f*r));a[10]=d*(g*A-n*y)-h*(e*A-f*y)+u*(e*n-f*g);a[11]=-(d*(g*t-n*r)-h*(e*t-f*r)+p*(e*n-f*g));a[12]=-(h*(r*z-v*y)-p*(g*z-i*y)+u*(g*v-i*r));a[13]=d*(r*z-v*y)-p*(e*z-b*y)+u*(e*v-b*r);a[14]=-(d*(g*z-i*y)-h*(e*z-b*y)+u*(e*i-b*g));a[15]=d*(g*v-i*r)-h*(e*v-b*r)+p*(e*i-b*g);return a};i.determinant=function(a){var c=
a[0],d=a[1],e=a[2],b=a[3],f=a[4],h=a[5],g=a[6],i=a[7],n=a[8],p=a[9],r=a[10],v=a[11],t=a[12],u=a[13],y=a[14],a=a[15];return(c*h-d*f)*(r*a-v*y)-(c*g-e*f)*(p*a-v*u)+(c*i-b*f)*(p*y-r*u)+(d*g-e*h)*(n*a-v*t)-(d*i-b*h)*(n*y-r*t)+(e*i-b*g)*(n*u-p*t)};i.multiply=function(a,c,d){var e=c[0],b=c[1],f=c[2],h=c[3],g=c[4],i=c[5],n=c[6],p=c[7],r=c[8],v=c[9],t=c[10],u=c[11],y=c[12],z=c[13],A=c[14],c=c[15],B=d[0],E=d[1],C=d[2],D=d[3];a[0]=B*e+E*g+C*r+D*y;a[1]=B*b+E*i+C*v+D*z;a[2]=B*f+E*n+C*t+D*A;a[3]=B*h+E*p+C*u+D*
c;B=d[4];E=d[5];C=d[6];D=d[7];a[4]=B*e+E*g+C*r+D*y;a[5]=B*b+E*i+C*v+D*z;a[6]=B*f+E*n+C*t+D*A;a[7]=B*h+E*p+C*u+D*c;B=d[8];E=d[9];C=d[10];D=d[11];a[8]=B*e+E*g+C*r+D*y;a[9]=B*b+E*i+C*v+D*z;a[10]=B*f+E*n+C*t+D*A;a[11]=B*h+E*p+C*u+D*c;B=d[12];E=d[13];C=d[14];D=d[15];a[12]=B*e+E*g+C*r+D*y;a[13]=B*b+E*i+C*v+D*z;a[14]=B*f+E*n+C*t+D*A;a[15]=B*h+E*p+C*u+D*c;return a};i.mul=i.multiply;i.translate=function(a,c,d){var e=d[0],b=d[1],d=d[2],f,h,g,i,n,p,r,v,t,u,y,z;if(c===a){a[12]=c[0]*e+c[4]*b+c[8]*d+c[12];a[13]=
c[1]*e+c[5]*b+c[9]*d+c[13];a[14]=c[2]*e+c[6]*b+c[10]*d+c[14];a[15]=c[3]*e+c[7]*b+c[11]*d+c[15]}else{f=c[0];h=c[1];g=c[2];i=c[3];n=c[4];p=c[5];r=c[6];v=c[7];t=c[8];u=c[9];y=c[10];z=c[11];a[0]=f;a[1]=h;a[2]=g;a[3]=i;a[4]=n;a[5]=p;a[6]=r;a[7]=v;a[8]=t;a[9]=u;a[10]=y;a[11]=z;a[12]=f*e+n*b+t*d+c[12];a[13]=h*e+p*b+u*d+c[13];a[14]=g*e+r*b+y*d+c[14];a[15]=i*e+v*b+z*d+c[15]}return a};i.scale=function(a,c,d){var e=d[0],b=d[1],d=d[2];a[0]=c[0]*e;a[1]=c[1]*e;a[2]=c[2]*e;a[3]=c[3]*e;a[4]=c[4]*b;a[5]=c[5]*b;a[6]=
c[6]*b;a[7]=c[7]*b;a[8]=c[8]*d;a[9]=c[9]*d;a[10]=c[10]*d;a[11]=c[11]*d;a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15];return a};i.rotate=function(a,c,d,e){var h=e[0],g=e[1],e=e[2],i=Math.sqrt(h*h+g*g+e*e),q,s,n,p,r,v,t,u,y,z,A,B,E,C,D,G,H,I,J,K;if(Math.abs(i)<b)return null;i=1/i;h=h*i;g=g*i;e=e*i;q=Math.sin(d);s=Math.cos(d);n=1-s;d=c[0];i=c[1];p=c[2];r=c[3];v=c[4];t=c[5];u=c[6];y=c[7];z=c[8];A=c[9];B=c[10];E=c[11];C=h*h*n+s;D=g*h*n+e*q;G=e*h*n-g*q;H=h*g*n-e*q;I=g*g*n+s;J=e*g*n+h*q;K=h*e*n+g*q;h=
g*e*n-h*q;g=e*e*n+s;a[0]=d*C+v*D+z*G;a[1]=i*C+t*D+A*G;a[2]=p*C+u*D+B*G;a[3]=r*C+y*D+E*G;a[4]=d*H+v*I+z*J;a[5]=i*H+t*I+A*J;a[6]=p*H+u*I+B*J;a[7]=r*H+y*I+E*J;a[8]=d*K+v*h+z*g;a[9]=i*K+t*h+A*g;a[10]=p*K+u*h+B*g;a[11]=r*K+y*h+E*g;if(c!==a){a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15]}return a};i.rotateX=function(a,c,d){var e=Math.sin(d),d=Math.cos(d),b=c[4],f=c[5],h=c[6],g=c[7],i=c[8],n=c[9],p=c[10],r=c[11];if(c!==a){a[0]=c[0];a[1]=c[1];a[2]=c[2];a[3]=c[3];a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=
c[15]}a[4]=b*d+i*e;a[5]=f*d+n*e;a[6]=h*d+p*e;a[7]=g*d+r*e;a[8]=i*d-b*e;a[9]=n*d-f*e;a[10]=p*d-h*e;a[11]=r*d-g*e;return a};i.rotateY=function(a,c,d){var e=Math.sin(d),d=Math.cos(d),b=c[0],f=c[1],h=c[2],g=c[3],i=c[8],n=c[9],p=c[10],r=c[11];if(c!==a){a[4]=c[4];a[5]=c[5];a[6]=c[6];a[7]=c[7];a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15]}a[0]=b*d-i*e;a[1]=f*d-n*e;a[2]=h*d-p*e;a[3]=g*d-r*e;a[8]=b*e+i*d;a[9]=f*e+n*d;a[10]=h*e+p*d;a[11]=g*e+r*d;return a};i.rotateZ=function(a,c,d){var e=Math.sin(d),d=Math.cos(d),
b=c[0],f=c[1],h=c[2],g=c[3],i=c[4],n=c[5],p=c[6],r=c[7];if(c!==a){a[8]=c[8];a[9]=c[9];a[10]=c[10];a[11]=c[11];a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15]}a[0]=b*d+i*e;a[1]=f*d+n*e;a[2]=h*d+p*e;a[3]=g*d+r*e;a[4]=i*d-b*e;a[5]=n*d-f*e;a[6]=p*d-h*e;a[7]=r*d-g*e;return a};i.fromRotationTranslation=function(a,c,d){var e=c[0],b=c[1],f=c[2],h=c[3],g=e+e,i=b+b,n=f+f,c=e*g,p=e*i,e=e*n,r=b*i,b=b*n,f=f*n,g=h*g,i=h*i,h=h*n;a[0]=1-(r+f);a[1]=p+h;a[2]=e-i;a[3]=0;a[4]=p-h;a[5]=1-(c+f);a[6]=b+g;a[7]=0;a[8]=e+
i;a[9]=b-g;a[10]=1-(c+r);a[11]=0;a[12]=d[0];a[13]=d[1];a[14]=d[2];a[15]=1;return a};i.frustum=function(a,c,d,e,b,f,h){var g=1/(d-c),i=1/(b-e),n=1/(f-h);a[0]=f*2*g;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=f*2*i;a[6]=0;a[7]=0;a[8]=(d+c)*g;a[9]=(b+e)*i;a[10]=(h+f)*n;a[11]=-1;a[12]=0;a[13]=0;a[14]=h*f*2*n;a[15]=0;return a};i.perspective=function(a,c,d,e,b){var c=1/Math.tan(c/2),f=1/(e-b);a[0]=c/d;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=c;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=(b+e)*f;a[11]=-1;a[12]=0;a[13]=0;a[14]=2*b*e*
f;a[15]=0;return a};i.ortho=function(a,c,d,e,b,f,h){var g=1/(c-d),i=1/(e-b),n=1/(f-h);a[0]=-2*g;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=-2*i;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=2*n;a[11]=0;a[12]=(c+d)*g;a[13]=(b+e)*i;a[14]=(h+f)*n;a[15]=1;return a};i.lookAt=function(a,c,d,e){var h,g,o,q,s,n,p,r,v=c[0],t=c[1],c=c[2];o=e[0];q=e[1];g=e[2];p=d[0];e=d[1];h=d[2];if(Math.abs(v-p)<b&&Math.abs(t-e)<b&&Math.abs(c-h)<b)return i.identity(a);d=v-p;e=t-e;p=c-h;r=1/Math.sqrt(d*d+e*e+p*p);d=d*r;e=e*r;p=p*r;h=q*p-g*e;g=g*
d-o*p;o=o*e-q*d;if(r=Math.sqrt(h*h+g*g+o*o)){r=1/r;h=h*r;g=g*r;o=o*r}else o=g=h=0;q=e*o-p*g;s=p*h-d*o;n=d*g-e*h;if(r=Math.sqrt(q*q+s*s+n*n)){r=1/r;q=q*r;s=s*r;n=n*r}else n=s=q=0;a[0]=h;a[1]=q;a[2]=d;a[3]=0;a[4]=g;a[5]=s;a[6]=e;a[7]=0;a[8]=o;a[9]=n;a[10]=p;a[11]=0;a[12]=-(h*v+g*t+o*c);a[13]=-(q*v+s*t+n*c);a[14]=-(d*v+e*t+p*c);a[15]=1;return a};i.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+
", "+a[13]+", "+a[14]+", "+a[15]+")"};if(typeof a!=="undefined")a.mat4=i;e={};new Float32Array([0,0,0,1]);e.create=function(){var a=new d(4);a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};e.clone=g.clone;e.fromValues=g.fromValues;e.copy=g.copy;e.set=g.set;e.identity=function(a){a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};e.setAxisAngle=function(a,c,d){var d=d*0.5,e=Math.sin(d);a[0]=e*c[0];a[1]=e*c[1];a[2]=e*c[2];a[3]=Math.cos(d);return a};e.add=g.add;e.multiply=function(a,c,d){var e=c[0],b=c[1],f=c[2],c=c[3],h=
d[0],g=d[1],i=d[2],d=d[3];a[0]=e*d+c*h+b*i-f*g;a[1]=b*d+c*g+f*h-e*i;a[2]=f*d+c*i+e*g-b*h;a[3]=c*d-e*h-b*g-f*i;return a};e.mul=e.multiply;e.scale=g.scale;e.rotateX=function(a,c,d){var d=d*0.5,e=c[0],b=c[1],f=c[2],c=c[3],h=Math.sin(d),d=Math.cos(d);a[0]=e*d+c*h;a[1]=b*d+f*h;a[2]=f*d-b*h;a[3]=c*d-e*h;return a};e.rotateY=function(a,c,d){var d=d*0.5,e=c[0],b=c[1],f=c[2],c=c[3],h=Math.sin(d),d=Math.cos(d);a[0]=e*d-f*h;a[1]=b*d+c*h;a[2]=f*d+e*h;a[3]=c*d-b*h;return a};e.rotateZ=function(a,c,d){var d=d*0.5,
e=c[0],b=c[1],f=c[2],c=c[3],h=Math.sin(d),d=Math.cos(d);a[0]=e*d+b*h;a[1]=b*d-e*h;a[2]=f*d+c*h;a[3]=c*d-f*h;return a};e.calculateW=function(a,c){var d=c[0],e=c[1],b=c[2];a[0]=d;a[1]=e;a[2]=b;a[3]=-Math.sqrt(Math.abs(1-d*d-e*e-b*b));return a};e.dot=g.dot;e.lerp=g.lerp;e.slerp=function(a,c,d,e){var b=c[0],f=c[1],h=c[2],g=c[3],i=d[0],n=d[1],p=d[2],d=d[3],r=b*i+f*n+h*p+g*d,v;if(Math.abs(r)>=1){if(a!==c){a[0]=b;a[1]=f;a[2]=h;a[3]=g}return a}c=Math.acos(r);v=Math.sqrt(1-r*r);if(Math.abs(v)<0.001){a[0]=
b*0.5+i*0.5;a[1]=f*0.5+n*0.5;a[2]=h*0.5+p*0.5;a[3]=g*0.5+d*0.5;return a}r=Math.sin((1-e)*c)/v;e=Math.sin(e*c)/v;a[0]=b*r+i*e;a[1]=f*r+n*e;a[2]=h*r+p*e;a[3]=g*r+d*e;return a};e.invert=function(a,c){var d=c[0],e=c[1],b=c[2],f=c[3],h=d*d+e*e+b*b+f*f,h=h?1/h:0;a[0]=-d*h;a[1]=-e*h;a[2]=-b*h;a[3]=f*h;return a};e.conjugate=function(a,c){a[0]=-c[0];a[1]=-c[1];a[2]=-c[2];a[3]=c[3];return a};e.length=g.length;e.len=e.length;e.squaredLength=g.squaredLength;e.sqrLen=e.squaredLength;e.normalize=g.normalize;e.str=
function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof a!=="undefined")a.quat=e})(b)})();
(function(){function b(a){var a=a||{guess:!0},f=a.e||null,a=!!a.guess,d=new b.implementation,f=d.run(f);return a?d.guessAnonymousFunctions(f):f}b.implementation=function(){};b.implementation.prototype={run:function(a,b){a=a||this.createException();b=b||this.mode(a);return"other"===b?this.other(arguments.callee):this[b](a)},createException:function(){try{this.undef()}catch(a){return a}},mode:function(a){return a.arguments&&a.stack?"chrome":a.stack&&a.sourceURL?"safari":"string"===typeof a.message&&
"undefined"!==typeof window&&window.opera?!a.stacktrace||-1<a.message.indexOf("\n")&&a.message.split("\n").length>a.stacktrace.split("\n").length?"opera9":!a.stack?"opera10a":0>a.stacktrace.indexOf("called from line")?"opera10b":"opera11":a.stack?"firefox":"other"},instrumentFunction:function(a,f,d){var a=a||window,e=a[f];a[f]=function(){d.call(this,b().slice(4));return a[f]._instrumented.apply(this,arguments)};a[f]._instrumented=e},deinstrumentFunction:function(a,b){a[b].constructor===Function&&
a[b]._instrumented&&a[b]._instrumented.constructor===Function&&(a[b]=a[b]._instrumented)},chrome:function(a){a=(a.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");a.pop();return a},safari:function(a){return a.stack.replace(/\[native code\]\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},firefox:function(a){return a.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^[\(@]/gm,"{anonymous}()@").split("\n")},opera11:function(a){for(var b=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/,a=a.stacktrace.split("\n"),d=[],e=0,c=a.length;e<c;e+=2){var h=b.exec(a[e]);if(h){var g=h[4]+":"+h[1]+":"+h[2],h=h[3]||"global code",h=h.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");d.push(h+"@"+g+" -- "+a[e+1].replace(/^\s+/,""))}}return d},opera10b:function(a){for(var b=/^(.*)@(.+):(\d+)$/,a=a.stacktrace.split("\n"),
d=[],e=0,c=a.length;e<c;e++){var h=b.exec(a[e]);h&&d.push((h[1]?h[1]+"()":"global code")+"@"+h[2]+":"+h[3])}return d},opera10a:function(a){for(var b=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,a=a.stacktrace.split("\n"),d=[],e=0,c=a.length;e<c;e+=2){var h=b.exec(a[e]);h&&d.push((h[3]||"{anonymous}")+"()@"+h[2]+":"+h[1]+" -- "+a[e+1].replace(/^\s+/,""))}return d},opera9:function(a){for(var b=/Line (\d+).*script (?:in )?(\S+)/i,a=a.message.split("\n"),d=[],e=2,c=a.length;e<c;e+=2){var h=
b.exec(a[e]);h&&d.push("{anonymous}()@"+h[2]+":"+h[1]+" -- "+a[e+1].replace(/^\s+/,""))}return d},other:function(a){for(var b=/function\s*([\w\-$]+)?\s*\(/i,d=[],e,c;a&&a.arguments&&10>d.length;)e=b.test(a.toString())?RegExp.$1||"{anonymous}":"{anonymous}",c=Array.prototype.slice.call(a.arguments||[]),d[d.length]=e+"("+this.stringifyArguments(c)+")",a=a.caller;return d},stringifyArguments:function(a){for(var b=[],d=Array.prototype.slice,e=0;e<a.length;++e){var c=a[e];void 0===c?b[e]="undefined":null===
c?b[e]="null":c.constructor&&(c.constructor===Array?b[e]=3>c.length?"["+this.stringifyArguments(c)+"]":"["+this.stringifyArguments(d.call(c,0,1))+"..."+this.stringifyArguments(d.call(c,-1))+"]":c.constructor===Object?b[e]="#object":c.constructor===Function?b[e]="#function":c.constructor===String?b[e]='"'+c+'"':c.constructor===Number&&(b[e]=c))}return b.join(",")},sourceCache:{},ajax:function(a){var b=this.createXMLHTTPObject();if(b)try{return b.open("GET",a,!1),b.send(null),b.responseText}catch(d){}return""},
createXMLHTTPObject:function(){for(var a,b=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],d=0;d<b.length;d++)try{return a=b[d](),this.createXMLHTTPObject=b[d],a}catch(e){}},isSameDomain:function(a){return"undefined"!==typeof location&&-1!==a.indexOf(location.hostname)},getSource:function(a){a in this.sourceCache||(this.sourceCache[a]=this.ajax(a).split("\n"));
return this.sourceCache[a]},guessAnonymousFunctions:function(a){for(var b=0;b<a.length;++b){var d=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,e=a[b],c=/\{anonymous\}\(.*\)@(.*)/.exec(e);if(c){var h=d.exec(c[1]);h&&(d=h[1],c=h[2],h=h[3]||0,d&&this.isSameDomain(d)&&c&&(d=this.guessAnonymousFunction(d,c,h),a[b]=e.replace("{anonymous}",d)))}}return a},guessAnonymousFunction:function(a,b){var d;try{d=this.findFunctionName(this.getSource(a),b)}catch(e){d="getSource failed with url: "+a+", exception: "+e.toString()}return d},
findFunctionName:function(a,b){for(var d=/function\s+([^(]*?)\s*\(([^)]*)\)/,e=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*function\b/,c=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(?:eval|new Function)\b/,h="",g,i=Math.min(b,20),k,j=0;j<i;++j)if(g=a[b-j-1],k=g.indexOf("//"),0<=k&&(g=g.substr(0,k)),g)if(h=g+h,(g=e.exec(h))&&g[1]||(g=d.exec(h))&&g[1]||(g=c.exec(h))&&g[1])return g[1];return"(?)"}};XML3D.debug.printStackTrace=b})();
(function(b){var a={VERSION:"2.2.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,ASYNC:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(b,d){var e="string"==typeof b.initial?{state:b.initial}:b.initial,c=d||b.target||{},h=b.events||[],g=b.callbacks||{},i={},k=function(c){var d=c.from instanceof Array?c.from:c.from?[c.from]:[a.WILDCARD];i[c.name]=i[c.name]||{};for(var e=0;e<d.length;e++)i[c.name][d[e]]=c.to||d[e]};e&&(e.event=
e.event||"startup",k({name:e.event,from:"none",to:e.state}));for(var j=0;j<h.length;j++)k(h[j]);for(var l in i)i.hasOwnProperty(l)&&(c[l]=a.buildEvent(l,i[l]));for(l in g)g.hasOwnProperty(l)&&(c[l]=g[l]);c.current="none";c.is=function(a){return this.current==a};c.can=function(c){return!this.transition&&(i[c].hasOwnProperty(this.current)||i[c].hasOwnProperty(a.WILDCARD))};c.cannot=function(a){return!this.can(a)};c.error=b.error||function(a,c,d,e,b,h,f){throw f||h;};if(e&&!e.defer)c[e.event]();return c},
doCallback:function(b,d,e,c,h,g){if(d)try{return d.apply(b,[e,c,h].concat(g))}catch(i){return b.error(e,c,h,g,a.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",i)}},beforeEvent:function(b,d,e,c,h){return a.doCallback(b,b["onbefore"+d],d,e,c,h)},afterEvent:function(b,d,e,c,h){return a.doCallback(b,b["onafter"+d]||b["on"+d],d,e,c,h)},leaveState:function(b,d,e,c,h){return a.doCallback(b,b["onleave"+e],d,e,c,h)},enterState:function(b,d,e,c,h){return a.doCallback(b,
b["onenter"+c]||b["on"+c],d,e,c,h)},changeState:function(b,d,e,c,h){return a.doCallback(b,b.onchangestate,d,e,c,h)},buildEvent:function(b,d){return function(){var e=this.current,c=d[e]||d[a.WILDCARD]||e,h=Array.prototype.slice.call(arguments);if(this.transition)return this.error(b,e,c,h,a.Error.PENDING_TRANSITION,"event "+b+" inappropriate because previous transition did not complete");if(this.cannot(b))return this.error(b,e,c,h,a.Error.INVALID_TRANSITION,"event "+b+" inappropriate in current state "+
this.current);if(!1===a.beforeEvent(this,b,e,c,h))return a.Result.CANCELLED;if(e===c)return a.afterEvent(this,b,e,c,h),a.Result.NOTRANSITION;var g=this;this.transition=function(){g.transition=null;g.current=c;a.enterState(g,b,e,c,h);a.changeState(g,b,e,c,h);a.afterEvent(g,b,e,c,h)};this.transition.cancel=function(){g.transition=null;a.afterEvent(g,b,e,c,h)};var i=a.leaveState(this,b,e,c,h);if(!1===i)return this.transition=null,a.Result.CANCELLED;if("async"===i)return a.Result.ASYNC;this.transition&&
this.transition();return a.Result.SUCCEEDED}}};b.StateMachine=a})(this);
var SimplexNoise=function(b){void 0==b&&(b=Math);this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];this.p=[];for(var a=0;256>a;a++)this.p[a]=Math.floor(256*b.random());this.perm=[];for(a=0;512>a;a++)this.perm[a]=this.p[a&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],
[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};
SimplexNoise.prototype.dot=function(b,a,f){return b[0]*a+b[1]*f};
SimplexNoise.prototype.noise=function(b,a){var f,d,e;e=0.5*(Math.sqrt(3)-1);e*=b+a;var c=Math.floor(b+e),h=Math.floor(a+e),g=(3-Math.sqrt(3))/6;e=(c+h)*g;f=b-(c-e);var i=a-(h-e),k,j;f>i?(k=1,j=0):(k=0,j=1);d=f-k+g;var l=i-j+g;e=f-1+2*g;var g=i-1+2*g,m=c&255,h=h&255,c=this.perm[m+this.perm[h]]%12;k=this.perm[m+k+this.perm[h+j]]%12;j=this.perm[m+1+this.perm[h+1]]%12;h=0.5-f*f-i*i;0>h?f=0:(h*=h,f=h*h*this.dot(this.grad3[c],f,i));i=0.5-d*d-l*l;0>i?d=0:(i*=i,d=i*i*this.dot(this.grad3[k],d,l));l=0.5-e*
e-g*g;0>l?e=0:(l*=l,e=l*l*this.dot(this.grad3[j],e,g));return 70*(f+d+e)};
SimplexNoise.prototype.noise3d=function(b,a,f){var d,e,c,h=(b+a+f)*(1/3),g=Math.floor(b+h),i=Math.floor(a+h),k=Math.floor(f+h),h=1/6;c=(g+i+k)*h;d=b-(g-c);e=a-(i-c);var j=f-(k-c),l,m,x,w,o,q;d>=e?e>=j?(l=1,x=m=0,o=w=1,q=0):(d>=j?(l=1,x=m=0):(m=l=0,x=1),w=1,o=0,q=1):e<j?(m=l=0,x=1,w=0,q=o=1):d<j?(l=0,m=1,w=x=0,q=o=1):(l=0,m=1,x=0,o=w=1,q=0);var s=d-l+h,n=e-m+h,p=j-x+h;c=d-w+2*h;var b=e-o+2*h,r=j-q+2*h,f=d-1+3*h,a=e-1+3*h,h=j-1+3*h,g=g&255,v=i&255,t=k&255,i=this.perm[g+this.perm[v+this.perm[t]]]%12,
k=this.perm[g+l+this.perm[v+m+this.perm[t+x]]]%12;w=this.perm[g+w+this.perm[v+o+this.perm[t+q]]]%12;g=this.perm[g+1+this.perm[v+1+this.perm[t+1]]]%12;o=0.6-d*d-e*e-j*j;0>o?d=0:(o*=o,d=o*o*this.dot(this.grad3[i],d,e,j));e=0.6-s*s-n*n-p*p;0>e?e=0:(e*=e,e=e*e*this.dot(this.grad3[k],s,n,p));s=0.6-c*c-b*b-r*r;0>s?c=0:(s*=s,c=s*s*this.dot(this.grad3[w],c,b,r));b=0.6-f*f-a*a-h*h;0>b?f=0:(b*=b,f=b*b*this.dot(this.grad3[g],f,a,h));return 32*(d+e+c+f)};(function(b){function a(a){return{get:function(){return this._data[a]},set:function(e){this._data[a]=e;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!b){var f=function(a,e,c,b){this._data=new Float32Array(3);void 0!==a&&null!==a&&this.set(a,e,c);this._callback="function"==typeof b?b:0},b=f.prototype;b.set=function(a,e,c){a.length&&3<=a.length?(this._data[0]=a[0],this._data[1]=a[1],this._data[2]=a[2]):a._data&&a._data.length&&3===a._data.length?(this._data[0]=a._data[0],this._data[1]=
a._data[1],this._data[2]=a._data[2]):3==arguments.length&&(this._data[0]=a,this._data[1]=e,this._data[2]=c);this._callback&&this._callback(this)};Object.defineProperty(b,"x",a(0));Object.defineProperty(b,"y",a(1));Object.defineProperty(b,"z",a(2));b.toString=function(){return"[object XML3DVec3]"};b.add=function(a){return a._data?new f(this._data[0]+a._data[0],this._data[1]+a._data[1],this._data[2]+a._data[2]):new f(this._data[0]+a.x,this._data[1]+a.y,this._data[2]+a.z)};b.subtract=function(a){return a._data?
new f(this._data[0]-a._data[0],this._data[1]-a._data[1],this._data[2]-a._data[2]):new f(this._data[0]-a.x,this._data[1]-a.y,this._data[2]-a.z)};b.length=function(){return Math.sqrt(this._data[0]*this._data[0]+this._data[1]*this._data[1]+this._data[2]*this._data[2])};b.setVec3Value=function(a){a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!a)throw Error("Wrong format for XML3DVec3::setVec3Value");this._data[0]=+a[1];this._data[1]=+a[2];this._data[2]=+a[3];this._callback&&this._callback(this)};b.multiply=
function(a){return a._data?new f(this._data[0]*a._data[0],this._data[1]*a._data[1],this._data[2]*a._data[2]):new f(this._data[0]*a.x,this._data[1]*a.y,this._data[2]*a.z)};b.scale=function(a){return new f(this._data[0]*a,this._data[1]*a,this._data[2]*a)};b.cross=function(a){return a._data?new f(this._data[1]*a._data[2]-this._data[2]*a._data[1],this._data[2]*a._data[0]-this._data[0]*a._data[2],this._data[0]*a._data[1]-this._data[1]*a._data[0]):new f(this._data[1]*a.z-this._data[2]*a.y,this._data[2]*
a.x-this._data[0]*a.z,this._data[0]*a.y-this._data[1]*a.x)};b.negate=function(){return new f(-this._data[0],-this._data[1],-this._data[2])};b.dot=function(a){return this._data[0]*a.x+this._data[1]*a.y+this._data[2]*a.z};b.normalize=function(){var a=this.length();if(a)a=1/a;else throw Error();return new f(this._data[0]*a,this._data[1]*a,this._data[2]*a)};XML3D.XML3DVec3=f;window.XML3DVec3=f}})(XML3D._native);
(function(b){if(!b){var a=function(a,d,e){var c=this;this._data=new Float32Array(4);this._axis=new window.XML3DVec3(0,0,1,function(){c._updateQuaternion();c._callback&&c._callback(c)});this._angle=0;this._updateQuaternion();void 0!==a&&null!==a&&this.set(a,d);this._callback="function"==typeof e?e:0},b=a.prototype;b.set=function(a,d){a.axis&&void 0!==a.angle?this.setAxisAngle(a.axis,a.angle):a.length&&4<=a.length?this._setQuaternion(a):a._data&&a._data.length&&3===a._data.length?this.setAxisAngle(a,
d):XML3D.debug.logError("XML3DRotation.set(): invalid argument given. Expect XML3DRotation or Float32Array.")};Object.defineProperty(b,"axis",{get:function(){return this._axis},set:function(){throw Error("Can't set axis. XML3DRotation::axis is readonly.");},configurable:!1,enumerable:!1});Object.defineProperty(b,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;this._updateQuaternion();this._callback&&this._callback(this)},configurable:!1,enumerable:!1});b.toString=function(){return"[object XML3DRotation]"};
b.setAxisAngle=function(a,d){if("object"!=typeof a||isNaN(d))throw Error("Illegal axis and/or angle values: ( axis="+a+" angle="+d+" )");this._axis._data[0]=a._data[0];this._axis._data[1]=a._data[1];this._axis._data[2]=a._data[2];this._angle=d;this._updateQuaternion();this._callback&&this._callback(this)};b.setRotation=function(a,d){var e=a.normalize(),c=d.normalize(),b=e.cross(c);b.length()||(b=Math.abs(e._data[1])>=0.9*Math.abs(e._data[0])&&Math.abs(e._data[2])>=0.9*Math.abs(e._data[0])?new window.XML3DVec3(0,
-e._data[2],e._data[1]):Math.abs(e._data[0])>=0.9*Math.abs(e._data[1])&&Math.abs(e._data[2])>=0.9*Math.abs(e._data[1])?new window.XML3DVec3(-e._data[2],0,e._data[0]):new window.XML3DVec3(-e._data[1],e._data[0],0));this.setAxisAngle(b,Math.acos(e.dot(c)))};b._updateQuaternion=function(){var a=this._axis.length();1.0E-5<a?(a=Math.sin(this._angle/2)/a,this._data[0]=this._axis.x*a,this._data[1]=this._axis.y*a,this._data[2]=this._axis.z*a,this._data[3]=Math.cos(this._angle/2)):XML3D.math.quat.set(this._data,
0,0,0,1)};b.setAxisAngleValue=function(a){var d=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!d)throw Error("Could not parse AxisAngle string: "+a);this.setAxisAngle(new window.XML3DVec3(+d[1],+d[2],+d[3]),+d[4])};b.interpolate=function(b,d){var e=XML3D.math.quat.create(),c=new a;XML3D.math.quat.slerp(e,this._data,b._data,d);c._setQuaternion(e);return c};b.setQuaternion=function(a,d){this._setQuaternion([a.x,a.y,a.z,d])};b.toMatrix=function(){var a=XML3D.math.quat.copy(XML3D.math.quat.create(),
this._data),d=new window.XML3DMatrix;XML3D.math.mat4.fromRotationTranslation(d._data,a,[0,0,0]);return d};b.rotateVec3=function(a){var d=new window.XML3DVec3;XML3D.math.vec3.transformQuat(d._data,a._data,this._data);return d};b._setQuaternion=function(a){var d=Math.sqrt(1-a[3]*a[3]);0.001>d||isNaN(d)?(this._axis._data[0]=0,this._axis._data[1]=0,this._axis._data[2]=1,this._angle=0):(d=1/d,this._axis._data[0]=a[0]*d,this._axis._data[1]=a[1]*d,this._axis._data[2]=a[2]*d,this._angle=2*Math.acos(a[3]));
this._data=XML3D.math.quat.copy(XML3D.math.quat.create(),a);this._callback&&this._callback(this)};b.multiply=function(b){var d=new a,e=XML3D.math.quat.create();XML3D.math.quat.multiply(e,this._data,b._data);d._setQuaternion(e);return d};b.normalize=function(){var b=this._axis.normalize();return new a(b,this._angle)};b.getQuaternion=function(){return XML3D.math.quat.copy(XML3D.math.quat.create(),this._data)};b.setFromBasis=function(a,d,e){var c=XML3D.math.quat.create();XML3D.math.quat.setFromBasis(a._data,
d._data,e._data,c);this._setQuaternion(c)};XML3D.XML3DRotation=a;window.XML3DRotation=a}})(XML3D._native);
(function(b){b||(b=function(a,b,d){var e=this,c=function(){e._callback&&e._callback(e)};this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,c);this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,c);a&&a.min?(this._min.set(a.min),this._max.set(a.max)):(a&&this._min.set(a),b&&this._max.set(b));this._callback="function"==typeof d?d:0},Object.defineProperty(b.prototype,"min",{get:function(){return this._min},set:function(){throw Error("XML3DBox::min is readonly.");
},configurable:!1,enumerable:!1}),Object.defineProperty(b.prototype,"max",{get:function(){return this._max},set:function(){throw Error("XML3DBox::max is readonly.");},configurable:!1,enumerable:!1}),b.prototype.size=function(){var a=this._max.subtract(this._min);0>a.x&&(a.x=0);0>a.y&&(a.y=0);0>a.z&&(a.z=0);return a},b.prototype.center=function(){return this._min.add(this._max).scale(0.5)},b.prototype.makeEmpty=function(){this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);this._callback&&this._callback(this)},b.prototype.isEmpty=function(){return this._min.x>this._max.x||this._min.y>this._max.y||this._min.z>this._max.z},b.prototype.toString=function(){return"[object XML3DBox]"},b.prototype.set=function(a){this._min.set(a.min);this._max.set(a.max);this._callback&&this._callback(this)},b.prototype.extend=function(a){if(a){var b;if(a.constructor===window.XML3DBox)b=a.min,a=a.max;else if(a.constructor===
window.XML3DVec3)b=a;else return;b.x<this._min.x&&(this._min.x=b.x);b.y<this._min.y&&(this._min.y=b.y);b.z<this._min.z&&(this._min.z=b.z);a.x>this._max.x&&(this._max.x=a.x);a.y>this._max.y&&(this._max.y=a.y);a.z>this._max.z&&(this._max.z=a.z)}},XML3D.XML3DBox=b,window.XML3DBox=b)})(XML3D._native);
(function(b){function a(a){return{get:function(){return this._data[a]},set:function(e){this._data[a]=e;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!b){var f=function(a,e,c,b,g,f,k,j,l,m,x,w,o,q,s,n,p){"number"==typeof a&&16<=arguments.length?(this.set(a,e,c,b,g,f,k,j,l,m,x,w,o,q,s,n),this._callback="function"==typeof p?p:0):"object"==typeof a&&1==arguments.length?this.set(a):(this._data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._callback="function"==typeof a?
a:0)},b=f.prototype;Object.defineProperty(b,"m11",a(0));Object.defineProperty(b,"m12",a(1));Object.defineProperty(b,"m13",a(2));Object.defineProperty(b,"m14",a(3));Object.defineProperty(b,"m21",a(4));Object.defineProperty(b,"m22",a(5));Object.defineProperty(b,"m23",a(6));Object.defineProperty(b,"m24",a(7));Object.defineProperty(b,"m31",a(8));Object.defineProperty(b,"m32",a(9));Object.defineProperty(b,"m33",a(10));Object.defineProperty(b,"m34",a(11));Object.defineProperty(b,"m41",a(12));Object.defineProperty(b,
"m42",a(13));Object.defineProperty(b,"m43",a(14));Object.defineProperty(b,"m44",a(15));b.set=function(a,e,c,b,g,f,k,j,l,m,x,w,o,q,s,n){"number"==typeof a&&16<=arguments.length?this._data=new Float32Array(arguments):a._data&&a._data.length&&16===a._data.length?this._data=new Float32Array(a._data):a.length&&16<=a.length?this._data=new Float32Array(a):XML3D.debug.logError("XML3DMatrix.set(): invalid parameter(s). Expect XML3DMatrix, Float32Array or 16 numbers.")};b.toString=function(){return"[object XML3DMatrix]"};
b.setMatrixValue=function(a){a=/^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)$/.exec(a);if(!a)throw{code:DOMException.SYNTAX_ERR,message:"SYNTAX_ERR: DOM Exception 12"};if(17!=a.length)throw{code:DOMException.SYNTAX_ERR,message:"Illegal number of elements: "+(a.length-1)+"expected: 16"};this._data=new Float32Array(a.slice(1));this._callback&&this._callback(this)};b.multiply=function(a){var e=new f;XML3D.math.mat4.multiply(e._data,
this._data,a._data);return e};b.inverse=function(){var a=new f;a._data=XML3D.math.mat4.invert(a._data,this._data);if(null==a._data||isNaN(a._data[0]))throw Error("Trying to invert matrix that is not invertable.");return a};b.rotate=function(a,e,c){var b=new f;if(void 0===e&&void 0===c)return XML3D.math.mat4.rotateZ(b._data,this._data,a),b;XML3D.math.mat4.rotateZ(b._data,this._data,c);XML3D.math.mat4.rotateY(b._data,b._data,e);XML3D.math.mat4.rotateX(b._data,b._data,a);return b};b.rotateAxisAngle=
function(a,e,c,b){var g=new f;XML3D.math.mat4.rotate(g._data,this._data,b,[a,e,c]);return g};b.scale=function(a,e,c){var b=new f;c||(c=1);e||(e=a);XML3D.math.mat4.scale(b._data,this._data,[a,e,c]);return b};b.translate=function(a,e,c){var b=new f;XML3D.math.mat4.translate(b._data,this._data,[a,e,c]);return b};XML3D.XML3DMatrix=f;window.XML3DMatrix||(window.XML3DMatrix=f)}})(XML3D._native);
(function(b){if(!b){var b=function(a,d,e){var c=this,b=function(){c._callback&&c._callback(c)};this._origin=new window.XML3DVec3(0,0,0,b);this._direction=new window.XML3DVec3(0,0,-1,b);a&&a.origin?this.set(a,d):(a&&this._origin.set(a),d&&this._direction.set(d));this._callback="function"==typeof e?e:0},a=b.prototype;Object.defineProperty(a,"origin",{get:function(){return this._origin},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});Object.defineProperty(a,
"direction",{get:function(){return this._direction},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});a.set=function(a){this._origin.set(a.origin);this._direction.set(a.direction);this._callback&&this._callback(this)};a.toString=function(){return"[object XML3DRay]"};XML3D.XML3DRay=b;window.XML3DRay=b}})(XML3D._native);
(function(b){function a(a){switch(a){case Xflow.DATA_TYPE.FLOAT:return e.FLOAT;case Xflow.DATA_TYPE.FLOAT2:return e.FLOAT2;case Xflow.DATA_TYPE.FLOAT3:return e.FLOAT3;case Xflow.DATA_TYPE.FLOAT4:return e.FLOAT4;case Xflow.DATA_TYPE.FLOAT4X4:return e.FLOAT4X4;case Xflow.DATA_TYPE.INT:return e.INT;case Xflow.DATA_TYPE.INT4:return e.INT4;case Xflow.DATA_TYPE.BOOL:return e.BOOL;case Xflow.DATA_TYPE.TEXTURE:return e.TEXTURE;case Xflow.DATA_TYPE.BYTE:return e.BYTE;case Xflow.DATA_TYPE.UBYTE:return e.UBYTE;
default:throw Error("WHAT IS THIS I DON'T EVEN...");}}if(!b){var f=[],b=function(a){this.callback=a;this.observed=[]};window.XML3DDataObserver=b;b.prototype.observe=function(a,d){0==this.observed.length&&f.push(this);var b=XML3D.data.factory.getAdapter(a);if(b){var e={node:a,changed:!1,request:null},k=d&&d.names;"String"===Object.prototype.toString.call(k).slice(8,-1)&&(k=[k]);e.request=b.getComputeRequest(k,function(){e.changed=!0});e.request.getResult();this.observed.push(e)}};b.prototype.disconnect=
function(){for(var a=0;a<this.observed.length;++a)this.observed[a].request.clear();this.observed=[];for(a=f.length;a--;)f[a]==this&&f.splice(a,1)};XML3D.updateXflowObserver=function(){for(var a=0;a<f.length;++a){for(var b=f[a],g=[],i=0;i<b.observed.length;++i){var k=b.observed[i];if(k.changed){k.changed=!1;var j=k.request.getResult(),j=new e(j);g.push(new d(k.node,j))}}0<g.length&&b.callback&&b.callback(g,b)}};var d=function(a,d){this.target=a;this.result=d};window.XML3DDataRecord=d;var e=function(c){this._entries=
{};for(var d=0;d<c.outputNames.length;++d){var b=c.outputNames[d],e=c.getOutputData(b),f=e&&e.getValue();null!==f&&(e=a(e.type),this._entries[b]={type:e,value:f})}};window.XML3DDataResult=e;e.prototype.getValue=function(a){return this._entries[a]?this._entries[a].value:null};e.prototype.getType=function(a){return this._entries[a]?this._entries[a].type:null};e.prototype.getNames=function(){var a=[],d;for(d in this._entries)a.push(d);return a};e.FLOAT=0;e.FLOAT2=1;e.FLOAT3=2;e.FLOAT4=3;e.FLOAT4X4=4;
e.INT=10;e.INT4=11;e.BOOL=20;e.TEXTURE=30;e.BYTE=40;e.UBYTE=50;b=function(c,d,b,e,f,j){this.type=a(c);this.origin=d;this.originalName=b;this.seqLength=e;this.seqMinKey=f;this.seqMaxKey=j};window.XML3DDataChannelInfo=b;b.ORIGIN_CHILD=1;b.ORIGIN_COMPUTE=2;b.ORIGIN_PROTO=3}})(XML3D._native);(function(){function b(a){for(var b in this.connectedAdapterHandles)this.connectedAdapterHandles[b]==a.adapterHandle&&this.notifyChanged(new XML3D.events.ConnectedAdapterNotification(a,b))}XML3D.base={toString:function(){return"base"}};XML3D.base.Adapter=function(a){this.factory=a};XML3D.base.Adapter.prototype.connectAdapterHandle=function(a,f){this.connectedAdapterHandles||(this.connectedAdapterHandles={},this._bindedAdapterHandleCallback=b.bind(this));this.disconnectAdapterHandle(a);f?(this.connectedAdapterHandles[a]=
f,this.connectedAdapterHandles[a].addListener(this._bindedAdapterHandleCallback)):delete this.connectedAdapterHandles[a]};XML3D.base.Adapter.prototype.disconnectAdapterHandle=function(a){this.connectedAdapterHandles&&this.connectedAdapterHandles[a]&&(this.connectedAdapterHandles[a].removeListener(this._bindedAdapterHandleCallback),delete this.connectedAdapterHandles[a])};XML3D.base.Adapter.prototype.clearAdapterHandles=function(){for(var a in this.connectedAdapterHandles)this.connectedAdapterHandles[a].removeListener(this._bindedAdapterHandleCallback);
this.connectedAdapterHandles={}};XML3D.base.Adapter.prototype.getConnectedAdapterHandle=function(a){return this.connectedAdapterHandles&&this.connectedAdapterHandles[a]};XML3D.base.Adapter.prototype.getConnectedAdapter=function(a){return(a=this.getConnectedAdapterHandle(a))&&a.getAdapter()};XML3D.base.NodeAdapter=function(a,b){XML3D.base.Adapter.call(this,a);this.node=b};XML3D.createClass(XML3D.base.NodeAdapter,XML3D.base.Adapter);XML3D.base.NodeAdapter.prototype.init=function(){};XML3D.base.NodeAdapter.prototype.notifyChanged=
function(){};XML3D.base.NodeAdapter.prototype.getAdapterHandle=function(a){return XML3D.base.resourceManager.getAdapterHandle(this.node.ownerDocument,a,this.factory.aspect,this.factory.canvasId)};XML3D.base.NodeAdapter.prototype.notifyOppositeAdapters=function(a){a=a||XML3D.events.ADAPTER_HANDLE_CHANGED;return XML3D.base.resourceManager.notifyNodeAdapterChange(this.node,this.factory.aspect,this.factory.canvasId,a)};XML3D.base.IFactory=function(){};XML3D.base.IFactory.prototype.canvasId;XML3D.base.AdapterFactory=
function(a,b,d){this.aspect=a;this.canvasId=d||0;this.mimetypes="string"==typeof b?[b]:b;XML3D.base.registerFactory(this)};XML3D.base.AdapterFactory.prototype.createAdapter=function(){return null};XML3D.base.AdapterFactory.prototype.supportsMimetype=function(a){return-1!=this.mimetypes.indexOf(a)};XML3D.base.NodeAdapterFactory=function(a,b){XML3D.base.AdapterFactory.call(this,a,["text/xml","application/xml"],b)};XML3D.createClass(XML3D.base.NodeAdapterFactory,XML3D.base.AdapterFactory);XML3D.base.NodeAdapterFactory.prototype.getAdapter=
function(a,b){if(!a||void 0===a._configured)return null;var d=a._configured,e=this.aspect+"_"+this.canvasId,c=d.adapters[e];if(void 0!==c)return c;if(c=this.createAdapter(a,b))d.adapters[e]=c,c.init();return c};XML3D.base.callAdapterFunc=function(a,b){var d=[];if(!a||void 0===a._configured)return d;var e=a._configured.adapters,c;for(c in e)for(var h in b){var g=e[c],i=g[h];i&&d.push(i.apply(g,b[h]))}return d};XML3D.base.sendAdapterEvent=function(a,b){if(!a||void 0===a._configured)return!1;var d=a._configured.adapters,
e;for(e in d)for(var c in b){var h=d[e][c];h&&h.apply(d[e],b[c])}return!0}})();
(function(){var b=function(a){this.url=a;this.adapter=null;this.listeners=[];this.status=0};b.STATUS={LOADING:0,NOT_FOUND:1,READY:2};b.prototype.hasAdapter=function(){return null!=this.adapter};b.prototype.getAdapter=function(){return this.adapter};b.prototype.setAdapter=function(a,b){this.adapter=a;this.status=b;this.notifyListeners(XML3D.events.ADAPTER_HANDLE_CHANGED)};b.prototype.notifyListeners=function(a){for(var a=new XML3D.events.AdapterHandleNotification(this,a),b=this.listeners.length;b--;)this.listeners[b](a)};
b.prototype.addListener=function(a){-1==this.listeners.indexOf(a)&&this.listeners.push(a)};b.prototype.removeListener=function(a){a=this.listeners.indexOf(a);-1!=a&&this.listeners.splice(a,1)};XML3D.base.AdapterHandle=b})();
(function(){var b=function(){this.factories={}};b.prototype.registerFactoryClass=function(a){if(!a.aspect||!XML3D.isSuperclassOf(XML3D.base.AdapterFactory,a))throw Error("factoryClass must be a subclass of XML3D.base.AdapterFactory");this.factories[a.aspect]=a};b.prototype.isFormatSupported=function(){return!1};b.prototype.getFormatData=function(a){return a};b.prototype.getFragmentData=function(a,b){return!b?a:null};XML3D.base.FormatHandler=b;var a=function(){};a.prototype.isFormatSupported=function(a,
b,c){return a&&9===a.nodeType&&("application/xml"===c||"text/xml"===c)};a.prototype.getFormatData=function(a){return a};a.prototype.getFragmentData=function(a,b){return a.querySelectorAll("*[id="+b+"]")[0]};XML3D.createClass(a,b);XML3D.base.XMLFormatHandler=a;var f=function(){};f.prototype.isFormatSupported=function(d,b,c){return a.prototype.isFormatSupported.call(this,d,b,c)};f.prototype.getFormatData=function(a){for(var b=a.querySelectorAll("xml3d"),c=0;c<b.length;++c)XML3D.config.element(b[c]);
return a};XML3D.createClass(f,a);XML3D.base.XML3DFormatHandler=f;f=function(){};f.prototype.isFormatSupported=function(a,b,c){return"application/json"===c};f.prototype.getFormatData=function(a){return a};XML3D.createClass(f,b);XML3D.base.JSONFormatHandler=f;f=function(){};XML3D.createClass(f,b);XML3D.base.BinaryFormatHandler=f})();
(function(){function b(a){var c=x[a];c||(c={counter:0,listeners:[]},x[a]=c);return c}function a(a){var c=a.listeners;a.listeners=[];for(a=c.length;a--;)c[a](this)}function f(c){if(c=x[c])XML3D.debug.assert(0<c.counter,"counter must be > 0"),c.counter--,0==c.counter&&a(c)}function d(a){for(var c in q)if(a==q[c])return!0;return!1}function e(a){for(var c in s)if(-1!==a.indexOf(s[c],a.length-s[c].length))return!0;return!1}function c(a){var c=null;try{c=new XMLHttpRequest}catch(b){c=null}c&&(c._url=a,
c._contentChecked=!1,c.open("GET",a,!0),e(a)&&(c.responseType="arraybuffer"),c.onreadystatechange=function(){if(!c._aborted){if(!c._contentChecked&&(c.readyState==2||c.readyState==3||c.readyState==4)&&c.status==200){c._contentChecked=true;var a=c.getResponseHeader("content-type");if(a){a=d(a);if(a!=(c.responseType=="arraybuffer")){c._aborted=true;var b=c.onreadystatechange;c.onreadystatechange=null;var e=c._url;c.abort();c=new XMLHttpRequest;c._url=e;c._contentChecked=true;c.open("GET",e,true);if(a)c.responseType=
"arraybuffer";c.onreadystatechange=b;c.send(null);return}}}if(c.readyState==4)if(c.status==200){XML3D.debug.logDebug("Loaded: "+c._url);XML3D.xmlHttpCallback&&XML3D.xmlHttpCallback(c);var a=c,b=a.getResponseHeader("content-type"),e=a._url,g=j[e];g.mimetype=b;if(a.responseType=="arraybuffer")g.response=a.response;else if(b=="application/json")g.response=JSON.parse(a.responseText);else if(b=="application/xml"||b=="text/xml"){g.response=a.responseXML;if(g.response){b=g.response.querySelectorAll("xml3d");
for(e=0;e<b.length;++e)XML3D.config.element(b[e])}else XML3D.debug.logError("Invalid external XML document '"+a._url+"': XML Syntax error")}else if(b=="application/octet-stream"||b=="text/plain; charset=x-user-defined"){XML3D.debug.logError("Possibly wrong loading of resource "+e+". Mimetype is "+b+" but response is not an ArrayBuffer");g.response=a.response}a=a._url;e=j[a];b=e.fragments;e.fragments=[];for(e=0;e<b.length;++e)h(a,b[e])}else{a=c;XML3D.debug.logError("Could not load external document '"+
a._url+"': "+a.status+" - "+a.statusText);a=a._url;e=j[a];b=e.fragments;e.fragments=[];for(e=0;e<b.length;++e)i(a+(b[e]?"#"+b[e]:""))}}},c.send(null))}function h(a,c){var d=j[a].response,b=j[a].mimetype,e=a+(c?"#"+c:"");if(d){var h=null;(h="application/json"==b?d:"application/xml"==b||"text/xml"==b?d.querySelectorAll("*[id="+c+"]")[0]:d)?g(e,b,h):i(e)}else i(e)}function g(a,c,d){for(var b in m[a])for(var e in m[a][b]){var h=m[a][b][e];h.hasAdapter()||(k(h,b,e,c,d),f(e,a))}}function i(a){for(var c in m[a])for(var d in m[a][c])m[a][c][d].setAdapter(null,
XML3D.base.AdapterHandle.STATUS.NOT_FOUND),f(d,a)}function k(a,c,d,b,e){for(var d=l[d],h=0;h<d.length;++h){var g=d[h];g.aspect==c&&g.supportsMimetype(b)&&(g=g.getAdapter?g.getAdapter(e,b):g.createAdapter(e,b))&&a.setAdapter(g,XML3D.base.AdapterHandle.STATUS.READY)}}var j={},l={},m={},x={},w=[];XML3D.base.registerFactory=function(a){var c=a.canvasId;l[c]||(l[c]=[]);l[c].push(a)};XML3D.base.registerFormat=function(a){a&&w.push(a)};XML3D.base.findFormat=function(a,c,d){for(var b=0;b<w.length;++b){var e=
w[b];if(w[b].isFormatSupported(a,c,d))return e}return null};var o=function(){};o.prototype.getCanvasIdCounters=function(){return x};o.prototype.addLoadCompleteListener=function(a,c){var d=x[a];void 0===d||0==d.counter?c(a):-1==d.listeners.indexOf(c)&&d.listeners.push(c)};o.prototype.removeLoadCompleteListener=function(a,c){var d=x[a];if(d){var b=d.listeners.indexOf(c);-1!=b&&d.listeners.splice(b,1)}};var q=["application/octet-stream","text/plain; charset=x-user-defined"],s=[".bin",".bson"];o.prototype.addBinaryContentType=
function(a){-1==q.indexOf(a)&&q.push(a)};o.prototype.removeBinaryContentType=function(a){a=q.indexOf(a);-1!=a&&q.splice(a,1)};o.prototype.addBinaryExtension=function(a){-1==s.indexOf(a)&&s.push(a)};o.prototype.removeBinaryExtension=function(a){a=s.indexOf(a);-1!=a&&s.splice(a,1)};o.prototype.getAdapterHandle=function(a,d,e,g){if(!d)return null;"string"==typeof d&&(d=new XML3D.URI(d));g=g||0;if(document!=a||!d.isLocal())d=d.getAbsoluteURI(a.documentURI);m[d]||(m[d]={});m[d][e]||(m[d][e]={});if(a=m[d][e][g])return a;
a=new XML3D.base.AdapterHandle(d);m[d][e][g]=a;d.isLocal()?(d=XML3D.URIResolver.resolveLocal(d))?k(a,e,g,"application/xml",d):a.setAdapter(null,XML3D.base.AdapterHandle.STATUS.NOT_FOUND):(b(g).counter++,e=d.toStringWithoutFragment(),(g=j[e])&&g.response?h(e,d.fragment):(g||(c(e),j[e]=g={fragments:[]}),g.fragments.push(d.fragment)));return a};o.prototype.notifyNodeIdChange=function(a,c,d){for(var b=a;b.parentNode;)b=b.parentNode;if(b==window.document){if(c){var c="#"+c,e;for(e in m[c])for(var h in m[c][e])b=
m[c][e][h],b.hasAdapter()&&b.setAdapter(null,XML3D.base.AdapterHandle.STATUS.NOT_FOUND)}d&&g("#"+d,"application/xml",a)}};o.prototype.notifyNodeAdapterChange=function(a,c,d,b){d=d||0;a="#"+a.id;m[a]&&m[a][c]&&m[a][c][d]&&m[a][c][d].notifyListeners(b)};o.prototype.loadData=function(a,c,b){var h=null;try{h=new XMLHttpRequest}catch(g){h=null}h&&(h._url=a,h._contentChecked=!1,h.open("GET",a,!0),e(a)&&(h.responseType="arraybuffer"),h.onreadystatechange=function(){if(!h._aborted){if(!h._contentChecked&&
(h.readyState==2||h.readyState==3||h.readyState==4)&&h.status==200){h._contentChecked=true;var a=h.getResponseHeader("content-type");if(a){a=d(a);if(a!=(h.responseType=="arraybuffer")){h._aborted=true;var e=h.onreadystatechange;h.onreadystatechange=null;var g=h._url;h.abort();h=new XMLHttpRequest;h._url=g;h._contentChecked=true;h.open("GET",g,true);if(a)h.responseType="arraybuffer";h.onreadystatechange=e;h.send(null);return}}}if(h.readyState==4)if(h.status==200){XML3D.debug.logDebug("Loaded: "+h._url);
a=h.getResponseHeader("content-type");e=null;if(h.responseType=="arraybuffer")e=h.response;else if(a=="application/json")e=JSON.parse(h.responseText);else if(a=="application/xml"||a=="text/xml")e=h.responseXML;else if(a=="application/octet-stream"||a=="text/plain; charset=x-user-defined"){XML3D.debug.logError("Possibly wrong loading of resource "+g+". Mimetype is "+a+" but response is not an ArrayBuffer");e=h.responseText}c&&c(e)}else{XML3D.debug.logError("Could not load external document '"+h._url+
"': "+h.status+" - "+h.statusText);b&&b(h)}}},h.send(null))};o.prototype.getImage=function(a,c,d){b(0).counter++;var e=new Image;e.onload=function(d){f(0,a);c(d,e)};e.onerror=function(c){f(0,a);d(c,e)};e.crossOrigin="anonymous";e.src=a;return e};o.prototype.getVideo=function(a,c,d){function e(){f(0,a)}function h(a){return function(c){a(c,g)}}b(0).counter++;var g=document.createElement("video");g.addEventListener("canplay",e,!0);g.addEventListener("error",e,!0);g.crossorigin="anonymous";g.autoplay=
c;for(var i in d)g.addEventListener(i,h(d[i]),!0);g.src=a;return g};XML3D.base.resourceManager=new o})();(function(){var b={NODE_INSERTED:0,VALUE_MODIFIED:1,NODE_REMOVED:2,DANGLING_REFERENCE:3,VALID_REFERENCE:4,THIS_REMOVED:5,ADAPTER_HANDLE_CHANGED:6,Notification:function(a){this.type=a}};b.Notification.prototype.toString=function(){return"Notification (type:"+this.type+")"};b.NotificationWrapper=function(a,b){this.wrapped=a;this.type=b};XML3D.createClass(b.NotificationWrapper,b.Notification);b.NotificationWrapper.prototype.toString=function(){return"NotificationWrapper (type:"+this.type+", wrapped: "+
this.wrapped+")"};b.AdapterHandleNotification=function(a,b){this.adapterHandle=a;this.type=b};XML3D.createClass(b.AdapterHandleNotification,b.Notification);b.AdapterHandleNotification.prototype.toString=function(){return"AdapterHandleNotification (type:"+this.type+")"};b.ConnectedAdapterNotification=function(a,b){this.adapter=a.adapterHandle.getAdapter();this.key=b;this.url=a.adapterHandle.url;this.type=a.type;this.handleStatus=a.adapterHandle.status};XML3D.createClass(b.ConnectedAdapterNotification,
b.Notification);b.ConnectedAdapterNotification.prototype.toString=function(){return"ConnectedAdapterNotification (type:"+this.type+", key: "+this.key+")"};XML3D.events=XML3D.events||{};XML3D.extend(XML3D.events,b)})();XML3D.config=XML3D.config||{};XML3D.config.isXML3DElement=function(b){return b.nodeType===Node.ELEMENT_NODE&&b.namespaceURI==XML3D.xml3dNS};
XML3D.config.element=function(b,a){if(void 0===b._configured){var f=XML3D.classInfo[b.localName];if(void 0===f)XML3D.debug.logInfo("Unrecognised element "+b.localName);else{b._configured="xml3d"==b.localName?new XML3D.XML3DHandler(b):new XML3D.ElementHandler(b,a);b._configured.registerAttributes(f);void 0==b.style&&(b.style=null);f=b.firstElementChild;for(XML3D.base.resourceManager.notifyNodeIdChange(b,null,b.getAttribute("id"));f;)XML3D.config.element(f,a),f=f.nextElementSibling}}};
XML3D.config.configure=function(b,a){Array.isArray(b)?Array.forEach(b,function(b){XML3D.config.element(b,a)}):XML3D.config.element(b,a)};
(function(b){if(!b){var b={},a=document.getElementById;b.getElementById=function(d){var b=a.call(this,d);if(b)return b;for(var b=this.getElementsByTagName("*"),c=0;c<b.length;c++){var h=b[c];if(h.getAttribute("id")===d)return h}return null};var f=document.createElementNS;b.createElementNS=function(a,b){var c=f.call(this,a,b);a==XML3D.xml3dNS&&XML3D.config.element(c,!0);return c};XML3D.extend(window.document,b)}})(XML3D._native);
if(-1!=navigator.userAgent.indexOf("WebKit")){var attrModifiedWorks=!1,listener=function(){attrModifiedWorks=!0};document.documentElement.addEventListener("DOMAttrModified",listener,!1);document.documentElement.setAttribute("___TEST___",!0);document.documentElement.removeAttribute("___TEST___");document.documentElement.removeEventListener("DOMAttrModified",listener,!1);attrModifiedWorks||(Element.prototype.__setAttribute=HTMLElement.prototype.setAttribute,Element.prototype.setAttribute=function(b,
a){var f=this.getAttribute(b);this.__setAttribute(b,a);var a=this.getAttribute(b),d=document.createEvent("MutationEvent");d.initMutationEvent("DOMAttrModified",!0,!1,this,f||"",a||"",b,null==f?MutationEvent.ADDITION:MutationEvent.MODIFICATION);this.dispatchEvent(d)},Element.prototype.__removeAttribute=HTMLElement.prototype.removeAttribute,Element.prototype.removeAttribute=function(b){var a=this.getAttribute(b);this.__removeAttribute(b);var f=document.createEvent("MutationEvent");f.initMutationEvent("DOMAttrModified",
!0,!1,this,a,"",b,MutationEvent.REMOVAL);this.dispatchEvent(f)})}
(function(){function b(a){var c=a.target._configured,d=c&&c.handlers[a.attrName];if(d){var b=!1;d.setFromAttribute&&(b=d.setFromAttribute(a.newValue,a.prevValue));b||(a=new k.NotificationWrapper(a),a.type=k.VALUE_MODIFIED,c.notify(a))}}function a(a){var c=a.target,d=a.relatedNode._configured;if(d){var b=new k.NotificationWrapper(a);c.nodeType==Node.TEXT_NODE&&d.handlers.value?(b.type=k.VALUE_MODIFIED,d.handlers.value.resetValue()):(b.type=k.NODE_REMOVED,d.notify(b),c._configured&&(b.type=k.THIS_REMOVED,
f(c,b)));a.stopPropagation()}}function f(a,c){a._configured&&(a._configured.notify(c),a._configured.remove(c));for(var d=a.firstElementChild;d;)f(d,c),d=d.nextElementSibling;XML3D.base.resourceManager.notifyNodeIdChange(a,a.id,null)}function d(a){var c=a.target,d=a.relatedNode._configured;if(d&&a.currentTarget!==c){var b=new k.NotificationWrapper(a);c.nodeType==Node.TEXT_NODE&&d.handlers.value?(b.type=k.VALUE_MODIFIED,d.handlers.value.resetValue()):(XML3D.config.element(c),b.type=k.NODE_INSERTED,
e(c));d.notify(b);a.stopPropagation()}}function e(a){for(var c=a.firstElementChild;c;)e(c),c=c.nextElementSibling;XML3D.base.resourceManager.notifyNodeIdChange(a,null,a.id)}function c(a){a=a.target;XML3D.base.resourceManager.notifyNodeIdChange(a,null,a.id)}function h(a){a=a.target;XML3D.base.resourceManager.notifyNodeIdChange(a,a.id,null)}function g(a,c,d){var b={get:function(){return d[a]}};try{Object.defineProperty(c,a,b)}catch(e){XML3D.debug.logWarning("Can't configure "+c.nodeName+"::"+a)}}var i=
{},k=XML3D.events;i.ElementHandler=function(e,g){e&&(this.element=e,this.handlers={},this.adapters={},g&&(e.addEventListener("DOMNodeRemoved",a,!0),e.addEventListener("DOMNodeInserted",d,!0),e.addEventListener("DOMNodeInsertedIntoDocument",c,!0),e.addEventListener("DOMNodeRemovedFromDocument",h,!0),e.addEventListener("DOMAttrModified",b,!0),this.monitoring=!0))};i.ElementHandler.prototype.registerAttributes=function(a){var c=this.element,d;for(d in a)if(void 0===a[d])delete c[d];else if(void 0!==
a[d].a){var b=a[d].id||d,e=new a[d].a(c,b,a[d].params);this.handlers[b]=e;try{Object.defineProperty(c,d,e.desc)}catch(h){XML3D.debug.logWarning("Can't configure "+c.nodeName+"::"+d)}}else void 0!==a[d].m?c[d]=a[d].m:XML3D.debug.logError("Can't configure "+c.nodeName+"::"+d);return c};i.ElementHandler.prototype.registerMixed=function(){this.element.addEventListener("DOMCharacterDataModified",this,!1)};i.ElementHandler.prototype.handleEvent=function(a){XML3D.debug.logDebug(a.type+" at "+a.currentTarget.localName+
"/"+a.target);var c=new k.NotificationWrapper(a);switch(a.type){case "DOMCharacterDataModified":c.type=k.VALUE_MODIFIED,this.handlers.value.resetValue(),this.notify(c)}};i.ElementHandler.prototype.notify=function(a){var c=this.adapters,d;for(d in c)try{c[d].notifyChanged(a)}catch(b){XML3D.debug.logException(b)}};i.ElementHandler.prototype.remove=function(){for(var a in this.handlers){var c=this.handlers[a];c.remove&&c.remove()}};i.ElementHandler.prototype.toString=function(){return"ElementHandler ("+
this.element.nodeName+", id: "+this.element.id+")"};var j="clientHeight,clientLeft,clientTop,clientWidth,offsetHeight,offsetLeft,offsetTop,offsetWidth".split(",");i.XML3DHandler=function(a){i.ElementHandler.call(this,a,!0);var c=document.createElement("canvas");c.width=800;c.height=600;this.canvas=c;for(var d in j)g(j[d],a,c);a.getBoundingClientRect=function(){return c.getBoundingClientRect()}};XML3D.createClass(i.XML3DHandler,i.ElementHandler);XML3D.extend(XML3D,i)})();
(function(){var b=function(a){switch(a.toLowerCase()){case "true":case "1":return!0;case "false":case "0":return!1;default:return Boolean(a)}},a={},f=function(){this.setter=function(){}};a.IDHandler=function(a,d){this.setFromAttribute=function(d,b){XML3D.base.resourceManager.notifyNodeIdChange(a,b,d)};this.desc={get:function(){return this.getAttribute(d)||""},set:function(a){this.setAttribute(d,a)}}};a.StringAttributeHandler=function(a,d){this.desc={get:function(){return this.getAttribute(d)||""},
set:function(a){this.setAttribute(d,a)}}};a.ReferenceHandler=a.StringAttributeHandler;a.EnumAttributeHandler=function(a,d,b){f.call(this,a);var e=b.d;this.setFromAttribute=function(a){e=(a=a.toLowerCase())&&void 0!==b.e[a]?b.e[a]:b.d;return!1};a.hasAttribute(d)&&this.setFromAttribute(a.getAttribute(d));this.desc={get:function(){return b.e[e]},set:function(a){this.setAttribute(d,a);e=(a="string"==typeof a?a.toLowerCase():void 0)&&void 0!==b.e[a]?b.e[a]:b.d}}};a.EnumAttributeHandler.prototype=new f;
a.EnumAttributeHandler.prototype.constructor=a.EnumAttributeHandler;a.EventAttributeHandler=function(a,d){f.call(this,a);var b=null;this.setFromAttribute=function(){b=null;return!1};this.desc={get:function(){return b?b:!this.hasAttribute(d)||void 0===b?null:eval("crx = function onclick(event){\n  "+this.getAttribute(d)+"\n}")},set:function(e){b="function"==typeof e?e:void 0;this._configured.notify({attrName:d,relatedNode:a})}}};a.EventAttributeHandler.prototype=new f;a.EventAttributeHandler.prototype.constructor=
a.EventAttributeHandler;a.IntAttributeHandler=function(a,d,b){var e=b;this.setFromAttribute=function(f){e=(f=f.match(/^\d+/))?+f[0]:b;a._configured.canvas&&(a._configured.canvas[d]=e);return!1};a.hasAttribute(d)&&this.setFromAttribute(a.getAttribute(d));this.desc={get:function(){return e},set:function(a){a=+a;e=isNaN(a)?b:Math.floor(a);this.setAttribute(d,e+"")}}};a.IntAttributeHandler.prototype=new f;a.IntAttributeHandler.prototype.constructor=a.IntAttributeHandler;a.FloatAttributeHandler=function(a,
d,b){var e=b;this.setFromAttribute=function(a){a=+a;e=isNaN(a)?b:a;return!1};a.hasAttribute(d)&&this.setFromAttribute(a.getAttribute(d));this.desc={get:function(){return e},set:function(a){a=+a;e=isNaN(a)?b:a;this.setAttribute(d,e+"")}}};a.BoolAttributeHandler=function(a,d,e){var f=e;this.setFromAttribute=function(a){f=b(a+"");return!1};a.hasAttribute(d)&&this.setFromAttribute(a.getAttribute(d));this.desc={get:function(){return f},set:function(a){f=Boolean(a);this.setAttribute(d,f+"")}}};a.XML3DVec3AttributeHandler=
function(a,d,b){var e=null,f=this,j=function(b){a.setAttribute(d,b.x+" "+b.y+" "+b.z)};this.setFromAttribute=function(a){e||(e=new window.XML3DVec3(0,0,0,j));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?(e._data[0]=a[1],e._data[1]=a[2],e._data[2]=a[3]):e._data.set(b);return!1};this.desc={get:function(){e||(this.hasAttribute(d)?f.setFromAttribute(this.getAttribute(d)):e=new window.XML3DVec3(b[0],b[1],b[2],j));return e},set:function(){throw Error("Can't set "+a.nodeName+"::"+d+": it's readonly");}}};
a.XML3DRotationAttributeHandler=function(a,d,b){var e=null,f=this,j=function(b){a.setAttribute(d,b.axis.x+" "+b.axis.y+" "+b.axis.z+" "+b.angle)};this.setFromAttribute=function(a){e||(e=new window.XML3DRotation(null,null,j));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?(e._axis._data[0]=+a[1],e._axis._data[1]=+a[2],e._axis._data[2]=+a[3],e._angle=+a[4]):(e._axis._data[0]=b[0],e._axis._data[1]=b[1],e._axis._data[2]=b[2],e._angle=b[3]);e._updateQuaternion();return!1};this.desc={get:function(){e||
(this.hasAttribute(d)?f.setFromAttribute(this.getAttribute(d)):e=new window.XML3DRotation(new window.XML3DVec3(b[0],b[1],b[2]),b[3],j));return e},set:function(){throw Error("Can't set "+a.nodeName+"::"+d+": it's readonly");}}};var d=function(a,d,b){a._configured.registerMixed();return{get:function(){d.value||(d.value=b.parse(a));return d.value},set:function(){throw Error("Can't set "+a.nodeName+"::value: it's readonly");}}},e=function(a){for(var d="",a=a.firstChild;a;)d+=3==a.nodeType?a.textContent:
" ",a=a.nextSibling;return d};a.FloatArrayValueHandler=function(a){var b={};this.desc=d(a,b,this);this.resetValue=function(){b.value=null}};a.FloatArrayValueHandler.prototype.parse=function(a){return(a=e(a).match(/([+\-0-9eE\.]+)/g))?new Float32Array(a):new Float32Array};a.Float2ArrayValueHandler=a.FloatArrayValueHandler;a.Float3ArrayValueHandler=a.FloatArrayValueHandler;a.Float4ArrayValueHandler=a.FloatArrayValueHandler;a.Float4x4ArrayValueHandler=a.FloatArrayValueHandler;a.IntArrayValueHandler=
function(a){var b={};this.desc=d(a,b,this);this.resetValue=function(){b.value=null}};a.IntArrayValueHandler.prototype.parse=function(a){return(a=e(a).match(/([+\-0-9]+)/g))?new Int32Array(a):new Int32Array};a.BoolArrayValueHandler=function(a){var b={};this.desc=d(a,b,this);this.resetValue=function(){b.value=null}};a.BoolArrayValueHandler.prototype.parse=function(a){a=e(a).match(/(true|false|0|1)/ig);return!a?new Uint8Array:(a=Array.map(a,b))?new Uint8Array(a):new Uint8Array};a.CanvasStyleHandler=
function(a,d){var b=a._configured.canvas;this.desc={};this.desc.get=function(){return b.style};this.desc.set=function(){};this.setFromAttribute=function(a){b.setAttribute(d,a)};a.hasAttribute(d)&&this.setFromAttribute(a.getAttribute(d))};a.CanvasClassHandler=function(a,d){var b=a._configured.canvas;b.className="_xml3d";this.desc={};this.desc.get=function(){return b.className};this.desc.set=function(a){b.className=a};this.setFromAttribute=function(a){b.setAttribute(d,a+" _xml3d")};a.hasAttribute(d)&&
this.setFromAttribute(a.getAttribute(d))};XML3D.extend(XML3D,a)})();XML3D.methods=XML3D.methods||{};
new function(){function b(a,d){var b={},e;for(e in d){var f=d[e],j=a.getOutputData(f)&&a.getOutputData(f).getValue();j&&(b[f]=j)}return b}var a={xml3dCreateXML3DVec3:function(){return new window.XML3DVec3},xml3dCreateXML3DRay:function(){return new window.XML3DRay},xml3dGetElementByRay:function(){XML3D.debug.logError(this.nodeName+"::getElementByRay is not implemeted yet.");return null},xml3dCreateXML3DMatrix:function(){return new window.XML3DMatrix},xml3dCreateXML3DRotation:function(){return new window.XML3DRotation},
viewGetDirection:function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,0,-1))},viewSetPosition:function(a){this.position=a}},f=XML3D.math.vec3.create(),d=XML3D.math.vec3.create(),e=XML3D.math.vec3.create();XML3D.math.quat.setFromMat3=function(a,d){var b=a[0]+a[4]+a[8];0<b?(b=2*Math.sqrt(b+1),d[0]=(a[7]-a[5])/b,d[1]=(a[2]-a[6])/b,d[2]=(a[3]-a[1])/b,d[3]=0.25*b):a[0]>a[4]&a[0]>a[8]?(b=2*Math.sqrt(1+a[0]-a[4]-a[8]),d[3]=(a[7]-a[5])/b,d[0]=0.25*b,d[1]=(a[1]+a[3])/b,d[2]=(a[2]+a[6])/b):
a[4]>a[8]?(b=2*Math.sqrt(1+a[4]-a[0]-a[8]),d[3]=(a[2]-a[6])/b,d[0]=(a[1]+a[3])/b,d[1]=0.25*b,d[2]=(a[5]+a[7])/b):(b=2*Math.sqrt(1+a[8]-a[0]-a[4]),d[3]=(a[3]-a[1])/b,d[0]=(a[2]+a[6])/b,d[1]=(a[5]+a[7])/b,d[2]=0.25*b)};XML3D.math.quat.setFromBasis=function(a,d,b,e){var f=1/XML3D.math.vec3.length(a),j=1/XML3D.math.vec3.length(d),l=1/XML3D.math.vec3.length(b),m=XML3D.math.mat3.create();m[0]=a[0]*f;m[1]=d[0]*j;m[2]=b[0]*l;m[3]=a[1]*f;m[4]=d[1]*j;m[5]=b[1]*l;m[6]=a[2]*f;m[7]=d[2]*j;m[8]=b[2]*l;XML3D.math.quat.setFromMat3(m,
e)};a.viewSetDirection=function(a){var a=a||new window.XML3DVec3(0,0,-1),a=a.normalize(),b=this.orientation.rotateVec3(new window.XML3DVec3(0,1,0)),b=b.normalize();XML3D.math.vec3.cross(f,a._data,b._data);XML3D.math.vec3.length(f)||(f=this.orientation.rotateVec3(new window.XML3DVec3(1,0,0))._data);XML3D.math.vec3.cross(d,f,a._data);XML3D.math.vec3.negate(e,a._data);a=XML3D.math.quat.create();XML3D.math.quat.setFromBasis(f,d,e,a);this.orientation._setQuaternion(a)};a.viewSetUpVector=function(a){var a=
a||new window.XML3DVec3(0,1,0),a=a.normalize(),d=new window.XML3DRotation;d.setRotation(new window.XML3DVec3(0,1,0),a);d=this.orientation.multiply(d);d=d.normalize();this.orientation.set(d)};a.viewGetUpVector=function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,1,0))};a.viewLookAt=function(a){this.setDirection(a.subtract(this.position))};a.viewGetViewMatrix=function(){var a=this._configured.adapters||{},d;for(d in a)if(a[d].getViewMatrix)return a[d].getViewMatrix();a=this.position;
d=this.orientation;var b=d.axis;return(new window.XML3DMatrix).translate(a.x,a.y,a.z).rotateAxisAngle(b.x,b.y,b.z,d.angle).inverse()};a.xml3dGetElementByPoint=function(a,d,b,e){var f=this._configured.adapters||{},j;for(j in f)if(f[j].getElementByPoint)return f[j].getElementByPoint(a,d,b,e);return null};a.xml3dGenerateRay=function(a,d){var b=this._configured.adapters||{},e;for(e in b)if(b[e].generateRay)return b[e].generateRay(a,d);return new window.XML3DRay};a.groupGetLocalMatrix=function(){var a=
this._configured.adapters||{},d;for(d in a)if(a[d].getLocalMatrix)return a[d].getLocalMatrix();return new window.XML3DMatrix};a.groupGetBoundingBox=function(){var a=this._configured.adapters||{},d;for(d in a)if(a[d].getBoundingBox)return a[d].getBoundingBox();return new window.XML3DBox};a.xml3dGetBoundingBox=a.groupGetBoundingBox;a.meshGetBoundingBox=function(){var a=this._configured.adapters||{},d;for(d in a)if(a[d].getBoundingBox)return a[d].getBoundingBox();return new window.XML3DBox};a.XML3DGraphTypeGetWorldMatrix=
function(){var a=this._configured.adapters||{},d;for(d in a)if(a[d].getWorldMatrix)return a[d].getWorldMatrix();return new window.XML3DMatrix};a.dataGetOutputNames=function(){var a=XML3D.data.factory.getAdapter(this);return a?a.getOutputNames():null};a.videoPlay=function(){XML3D.base.sendAdapterEvent(this,{play:[]})};a.videoPause=function(){XML3D.base.sendAdapterEvent(this,{pause:[]})};a.protoGetOutputNames=a.dataGetOutputNames;a.dataGetResult=function(a){var d=XML3D.data.factory.getAdapter(this);
return d?(a=d.getComputeResult(a),!a?null:new window.XML3DDataResult(a)):null};a.dataGetOutputChannelInfo=function(a){var d=XML3D.data.factory.getAdapter(this);return d?(a=d.getOutputChannelInfo(a),!a?null:new window.XML3DDataChannelInfo(a.type,a.origin,a.originalName,a.seqLength,a.seqMinKey,a.seqMaxKey)):null};a.protoGetOutputChannelInfo=a.dataGetOutputChannelInfo;a.dataGetComputeInfo=function(){XML3D.debug.logError(this.nodeName+"::getComputeInfo is not implemeted yet.");return null};a.protoGetComputeInfo=
a.dataGetComputeInfo;a.dataGetProtoInfo=function(){XML3D.debug.logError(this.nodeName+"::getProtoInfo is not implemeted yet.");return null};a.protoGetProtoInfo=a.dataGetProtoInfo;a.dataIsOutputConnected=function(){XML3D.debug.logError(this.nodeName+"::isOutputConnected is not implemeted yet.");return!1};a.protoIsOutputConnected=a.dataIsOutputConnected;a.dataAddOutputFieldListener=function(a,d){if(!a)return!1;"String"===Object.prototype.toString.call(a).slice(8,-1)&&(a=[a]);if(0==a.length)return!1;
var e=XML3D.base.callAdapterFunc(this,{getComputeRequest:[a,function(e){d(b(e.getResult(),a))}]});if(0==e.length)return!1;e=e[0].getResult();e=b(e,a);Object.keys(e).length&&d(e);return!0};XML3D.extend(XML3D.methods,a)};XML3D.MeshTypes={};XML3D.MeshTypes.triangles=0;XML3D.MeshTypes[0]="triangles";XML3D.MeshTypes.trianglestrips=1;XML3D.MeshTypes[1]="trianglestrips";XML3D.MeshTypes.lines=2;XML3D.MeshTypes[2]="lines";XML3D.MeshTypes.linestrips=3;XML3D.MeshTypes[3]="linestrips";XML3D.TextureTypes={};
XML3D.TextureTypes["2d"]=0;XML3D.TextureTypes[0]="2d";XML3D.TextureTypes["1d"]=1;XML3D.TextureTypes[1]="1d";XML3D.TextureTypes["3d"]=2;XML3D.TextureTypes[2]="3d";XML3D.FilterTypes={};XML3D.FilterTypes.none=0;XML3D.FilterTypes[0]="none";XML3D.FilterTypes.nearest=1;XML3D.FilterTypes[1]="nearest";XML3D.FilterTypes.linear=2;XML3D.FilterTypes[2]="linear";XML3D.WrapTypes={};XML3D.WrapTypes.clamp=0;XML3D.WrapTypes[0]="clamp";XML3D.WrapTypes.repeat=1;XML3D.WrapTypes[1]="repeat";XML3D.WrapTypes.border=2;
XML3D.WrapTypes[2]="border";XML3D.DataFieldType={};XML3D.DataFieldType["float "]=0;XML3D.DataFieldType[0]="float ";XML3D.DataFieldType["float2 "]=1;XML3D.DataFieldType[1]="float2 ";XML3D.DataFieldType.float3=2;XML3D.DataFieldType[2]="float3";XML3D.DataFieldType.float4=3;XML3D.DataFieldType[3]="float4";XML3D.DataFieldType.float4x4=4;XML3D.DataFieldType[4]="float4x4";XML3D.DataFieldType["int"]=10;XML3D.DataFieldType[10]="int";XML3D.DataFieldType.int4=11;XML3D.DataFieldType[11]="int4";
XML3D.DataFieldType.bool=20;XML3D.DataFieldType[20]="bool";XML3D.DataFieldType.texture=30;XML3D.DataFieldType[30]="texture";XML3D.DataChannelOrigin={};XML3D.DataChannelOrigin["origin_value "]=0;XML3D.DataChannelOrigin[0]="origin_value ";XML3D.DataChannelOrigin.origin_child=1;XML3D.DataChannelOrigin[1]="origin_child";XML3D.DataChannelOrigin.origin_source=2;XML3D.DataChannelOrigin[2]="origin_source";XML3D.DataChannelOrigin.origin_compute=3;XML3D.DataChannelOrigin[3]="origin_compute";
XML3D.DataChannelOrigin.origin_proto=4;XML3D.DataChannelOrigin[4]="origin_proto";XML3D.classInfo={};
XML3D.classInfo.xml3d={id:{a:XML3D.IDHandler},className:{a:XML3D.CanvasClassHandler,id:"class"},style:{a:XML3D.CanvasStyleHandler},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},
onkeyup:{a:XML3D.EventAttributeHandler},height:{a:XML3D.IntAttributeHandler,params:600},width:{a:XML3D.IntAttributeHandler,params:800},createXML3DVec3:{m:XML3D.methods.xml3dCreateXML3DVec3},createXML3DRotation:{m:XML3D.methods.xml3dCreateXML3DRotation},createXML3DMatrix:{m:XML3D.methods.xml3dCreateXML3DMatrix},createXML3DRay:{m:XML3D.methods.xml3dCreateXML3DRay},getElementByPoint:{m:XML3D.methods.xml3dGetElementByPoint},generateRay:{m:XML3D.methods.xml3dGenerateRay},getElementByRay:{m:XML3D.methods.xml3dGetElementByRay},
getBoundingBox:{m:XML3D.methods.xml3dGetBoundingBox},activeView:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.data={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},filter:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.dataGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.dataGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.dataGetComputeInfo},getProtoInfo:{m:XML3D.methods.dataGetProtoInfo},isOutputConnected:{m:XML3D.methods.dataIsOutputConnected},getResult:{m:XML3D.methods.dataGetResult},addOutputFieldListener:{m:XML3D.methods.dataAddOutputFieldListener},
getOutputNames:{m:XML3D.methods.dataGetOutputNames},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.defs={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},_term:void 0};
XML3D.classInfo.group={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getLocalMatrix:{m:XML3D.methods.groupGetLocalMatrix},getBoundingBox:{m:XML3D.methods.groupGetBoundingBox},transform:{a:XML3D.ReferenceHandler},shader:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.mesh={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.MeshTypes,d:0}},compute:{a:XML3D.StringAttributeHandler},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getBoundingBox:{m:XML3D.methods.meshGetBoundingBox},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.transform={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},translation:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scale:{a:XML3D.XML3DVec3AttributeHandler,params:[1,1,1]},rotation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},center:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scaleOrientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},_term:void 0};
XML3D.classInfo.shader={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.light={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},global:{a:XML3D.BoolAttributeHandler,params:!1},intensity:{a:XML3D.FloatAttributeHandler,params:1},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},shader:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.lightshader={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.script={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},value:{a:XML3D.StringAttributeHandler},src:{a:XML3D.StringAttributeHandler},type:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.proto={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},filter:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.protoGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.protoGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.protoGetComputeInfo},getProtoInfo:{m:XML3D.methods.protoGetProtoInfo},isOutputConnected:{m:XML3D.methods.protoIsOutputConnected},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},
_term:void 0};XML3D.classInfo["float"]={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.FloatArrayValueHandler},_term:void 0};
XML3D.classInfo.float2={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float2ArrayValueHandler},_term:void 0};
XML3D.classInfo.float3={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float3ArrayValueHandler},_term:void 0};
XML3D.classInfo.float4={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float4ArrayValueHandler},_term:void 0};
XML3D.classInfo.float4x4={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float4x4ArrayValueHandler},_term:void 0};
XML3D.classInfo["int"]={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.IntArrayValueHandler},_term:void 0};
XML3D.classInfo.int4={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.IntArrayValueHandler},_term:void 0};
XML3D.classInfo.bool={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.BoolArrayValueHandler},_term:void 0};
XML3D.classInfo.texture={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.TextureTypes,d:0}},filterMin:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMag:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMip:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,
d:1}},wrapS:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapT:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapU:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},borderColor:{a:XML3D.StringAttributeHandler},_term:void 0};XML3D.classInfo.img={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.video={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},play:{m:XML3D.methods.videoPlay},pause:{m:XML3D.methods.videoPause},autoplay:{a:XML3D.BoolAttributeHandler,params:!1},_term:void 0};
XML3D.classInfo.view={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},position:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},orientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},fieldOfView:{a:XML3D.FloatAttributeHandler,params:0.785398},perspective:{a:XML3D.ReferenceHandler},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},setDirection:{m:XML3D.methods.viewSetDirection},setUpVector:{m:XML3D.methods.viewSetUpVector},lookAt:{m:XML3D.methods.viewLookAt},getDirection:{m:XML3D.methods.viewGetDirection},
getUpVector:{m:XML3D.methods.viewGetUpVector},getViewMatrix:{m:XML3D.methods.viewGetViewMatrix},_term:void 0};window=this;var Xflow={EPSILON:1.0E-6,DATA_TYPE:{UNKNOWN:0,FLOAT:1,FLOAT2:2,FLOAT3:3,FLOAT4:4,FLOAT4X4:10,INT:20,INT4:21,BOOL:30,TEXTURE:40,BYTE:50,UBYTE:60},DATA_TYPE_TUPLE_SIZE:{}};Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT2]=2;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT3]=3;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT4]=4;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT4X4]=16;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.INT]=1;
Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.INT4]=4;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.BOOL]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.TEXTURE]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.BYTE]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.UBYTE]=1;
Xflow.DATA_TYPE_MAP={"float":Xflow.DATA_TYPE.FLOAT,float2:Xflow.DATA_TYPE.FLOAT2,float3:Xflow.DATA_TYPE.FLOAT3,float4:Xflow.DATA_TYPE.FLOAT4,float4x4:Xflow.DATA_TYPE.FLOAT4X4,"int":Xflow.DATA_TYPE.INT,int4:Xflow.DATA_TYPE.INT4,bool:Xflow.DATA_TYPE.BOOL,texture:Xflow.DATA_TYPE.TEXTURE,"byte":Xflow.DATA_TYPE.BYTE,ubyte:Xflow.DATA_TYPE.UBYTE};Xflow.getTypeName=function(b){for(var a in Xflow.DATA_TYPE_MAP)if(Xflow.DATA_TYPE_MAP[a]==b)return a};
Xflow.TEX_FILTER_TYPE={NEAREST:9728,LINEAR:9729,MIPMAP_NEAREST:9984,MIPMAP_LINEAR:9985};Xflow.TEX_WRAP_TYPE={CLAMP:33071,REPEAT:10497};Xflow.TEX_TYPE={TEXTURE_2D:3553};Xflow.DATA_FILTER_TYPE={RENAME:0,KEEP:1,REMOVE:2};Xflow.DATA_ENTRY_STATE={CHANGED_NEW:1,CHANGED_VALUE:2,CHANGE_SIZE:3,CHANGE_REMOVED:4};Xflow.RESULT_TYPE={COMPUTE:0};Xflow.RESULT_STATE={NONE:0,CHANGED_DATA:1,CHANGED_STRUCTURE:2};Xflow.SEQUENCE={NO_ACCESS:0,PREV_BUFFER:1,NEXT_BUFFER:2,LINEAR_WEIGHT:3};
Xflow.EXTRACT={NO_EXTRAC:0,TEX_WIDTH:1,TEX_HEIGHT:2};Xflow.ORIGIN={CHILD:1,COMPUTE:2,PROTO:3};Xflow.createClass=function(b,a,f){f=f||{};if(a){var d=function(){};d.prototype=a.prototype;b.prototype=new d;b.prototype.constructor=b;b.superclass=a.prototype}for(var e in f)b.prototype[e]=f[e];return b};
(function(){function b(a,d){for(var b=0;b<c._listeners.length;++b)c._listeners[b](a,d);for(b=0;b<a._listeners.length;++b)a._listeners[b].notify(a,d)}Xflow.SamplerConfig=function(){this.generateMipMap=this.colorB=this.colorG=this.colorR=this.textureType=this.wrapU=this.wrapT=this.wrapS=this.mipFilter=this.magFilter=this.minFilter=0};Xflow.SamplerConfig.prototype.setDefaults=function(){this.magFilter=this.minFilter=Xflow.TEX_FILTER_TYPE.LINEAR;this.mipFilter=Xflow.TEX_FILTER_TYPE.NEAREST;this.wrapU=
this.wrapT=this.wrapS=Xflow.TEX_WRAP_TYPE.CLAMP;this.textureType=Xflow.TEX_TYPE.TEXTURE_2D;this.generateMipMap=this.colorB=this.colorG=this.colorR=0};Xflow.SamplerConfig.prototype.set=function(a){this.minFilter=a.minFilter;this.magFilter=a.magFilter;this.mipFilter=a.mipFilter;this.wrapS=a.wrapS;this.wrapT=a.wrapT;this.wrapU=a.wrapU;this.textureType=a.textureType;this.colorR=a.colorR;this.colorG=a.colorG;this.colorB=a.colorB;this.generateMipMap=a.generateMipMap};var a=Xflow.SamplerConfig;Xflow.DataEntry=
function(a){this._type=a;this._listeners=[];this.userData={}};var f=Xflow.DataEntry;Object.defineProperty(f.prototype,"type",{set:function(){throw Error("type is read-only");},get:function(){return this._type}});f.prototype.addListener=function(a){this._listeners.push(a)};f.prototype.removeListener=function(a){Array.erase(this._listeners,a)};f.prototype.notifyChanged=function(){b(this,Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};Xflow.BufferEntry=function(a,c){Xflow.DataEntry.call(this,a);this._value=c;
b(this,Xflow.DATA_ENTRY_STATE.CHANGED_NEW)};Xflow.createClass(Xflow.BufferEntry,Xflow.DataEntry);f=Xflow.BufferEntry;f.prototype.setValue=function(a){var c=(this._value?this._value.length:0)!=(a?a.length:0);this._value=a;b(this,c?Xflow.DATA_ENTRY_STATE.CHANGE_SIZE:Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};f.prototype.getValue=function(){return this._value};f.prototype.getLength=function(){return this._value?this._value.length:0};f.prototype.getTupleSize=function(){this._tupleSize||(this._tupleSize=Xflow.DATA_TYPE_TUPLE_SIZE[this._type]);
return this._tupleSize};f.prototype.getIterateCount=function(){return this.getLength()/this.getTupleSize()};f.prototype.isEmpty=function(){return!this._value};var d=null,e=null;Xflow.toImageData=function(a){if(a instanceof ImageData)return a;if(!a.data)throw Error("no data property");if(!a.width)throw Error("no width property");if(!a.height)throw Error("no height property");e||(d=document.createElement("canvas"),e=d.getContext("2d"));for(var c=e.createImageData(a.width,a.height),b=0;b<a.data.length;++b){var f=
a.data[b];255<f&&(f=255);0>f&&(f=0);c.data[b]=f}return c};Xflow.TextureEntry=function(c){Xflow.DataEntry.call(this,Xflow.DATA_TYPE.TEXTURE);this._samplerConfig=new a;this._formatType=null;this._updateImage(c);b(this,Xflow.DATA_ENTRY_STATE.CHANGED_NEW)};Xflow.createClass(Xflow.TextureEntry,Xflow.DataEntry);f=Xflow.TextureEntry;f.prototype.isLoading=function(){var a=this._image;if(!a)return!1;var c=a.nodeName.toLowerCase();return"img"==c?!a.complete:"canvas"==c?0>=this._image.width||0>=this._image.height:
"video"==c?0==a.readyState||0>=this._image.videoWidth||0>=this._image.videoHeight:!1};f.prototype._updateImage=function(a){this._image=a;this._imageData=this._context=null;this._image?(a=this._image.nodeName.toLowerCase(),"video"==a?(this.width=this._image.videoWidth,this.height=this._image.videoHeight):(this.width=this._image.width,this.height=this._image.height),"canvas"==a)?(this._canvas=this._image,this._copyImageToCtx=!1):(this._canvas=null,this._copyImageToCtx=!0):(this.height=this.width=0,
this._canvas=null)};f.prototype.createImage=function(a,c,d,b){if(!this._image||this.getWidth()!=a||this.getHeight()!=c||this._formatType!=d){if(!a||!c)throw Error("Width or height is not specified");var e=document.createElement("canvas");e.width=a;e.height=c;e.complete=!0;this._formatType=d;b||(b=new Xflow.SamplerConfig,b.setDefaults());this._samplerConfig.set(b);this.setImage(e)}else this.notifyChanged();return this._image};f.prototype.setImage=function(a){this._updateImage(a);b(this,Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};
f.prototype.getFormatType=function(){return this._formatType};f.prototype.getWidth=function(){return!this._image?0:this._image.videoWidth||this._image.width||0};f.prototype.getHeight=function(){return!this._image?0:this._image.videoHeight||this._image.height||0};f.prototype._flush=function(){this._imageData&&(this._imageData instanceof ImageData?this._context.putImageData(this._imageData,0,0):this._context.putImageData(Xflow.toImageData(this._imageData),0,0),this._imageData=null);this._canvas&&(this._canvas.complete=
!0,this._image=this._canvas)};f.prototype.getImage=function(){this._flush();return this._image};f.prototype.getCanvas=function(){this._canvas?this._flush():(this._canvas=document.createElement("canvas"),this._canvas.width=this.getWidth(),this._canvas.height=this.getHeight(),this._canvas.complete=!1);return this._canvas};f.prototype.getFilledCanvas=function(){var a=this.getCanvas();this._context=a.getContext("2d");if(!this._context)throw Error("Could not create 2D context.");this._copyImageToCtx&&
(this._context.drawImage(this._image,0,0),this._copyImageToCtx=!1);return a};f.prototype.getContext2D=function(){this._context?this._flush():this.getFilledCanvas();return this._context};f.prototype.getValue=function(){if(!this._image)return null;!this._imageData&&!this.isLoading()&&(this._imageData=this.getContext2D().getImageData(0,0,this.getWidth(),this.getHeight()),"float32"==this._formatType?this._imageData={data:new Float32Array(this._imageData.data),width:this._imageData.width,height:this._imageData.height}:
"float64"==this._formatType&&(this._imageData={data:new Float64Array(this._imageData.data),width:this._imageData.width,height:this._imageData.height}));return this._imageData};f.prototype.getSamplerConfig=function(){return this._samplerConfig};f.prototype.getLength=function(){return 1};f.prototype.isEmpty=function(){return!this._image};f.prototype.getIterateCount=function(){return 1};Xflow.ImageDataTextureEntry=function(c){Xflow.DataEntry.call(this,Xflow.DATA_TYPE.TEXTURE);this._samplerConfig=new a;
this._formatType=this._imageData=null;this._updateImageData(c);b(this,Xflow.DATA_ENTRY_STATE.CHANGED_NEW)};Xflow.createClass(Xflow.ImageDataTextureEntry,Xflow.DataEntry);f=Xflow.ImageDataTextureEntry;f.prototype.isLoading=function(){return!this._imageData};f.prototype._updateImageData=function(a){this._formatType=null;this._imageData=a};f.prototype.createImage=function(a,c,d,b){if(!this._image||this.getWidth()!=a||this.getHeight()!=c||this._formatType!=d){if(!a||!c)throw Error("Width or height is not specified");
this._formatType=d;b||(b=new Xflow.SamplerConfig,b.setDefaults());this._samplerConfig.set(b);b={width:a,height:c,data:null};b.data="float64"==d?new Float64Array(4*a*c):"float32"==d?new Float32Array(4*a*c):Uint8Array==Uint8ClampedArray?new Int16Array(4*a*c):new Uint8ClampedArray(4*a*c);this._imageData=b}this.notifyChanged()};f.prototype.setImageData=function(a){this._updateImageData(a);b(this,Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};f.prototype.getWidth=function(){return this._imageData&&this._imageData.width||
0};f.prototype.getHeight=function(){return this._imageData&&this._imageData.height||0};f.prototype.getValue=function(){return this._imageData};f.prototype.getSamplerConfig=function(){return this._samplerConfig};f.prototype.getLength=function(){return 1};f.prototype.isEmpty=function(){return!this._imageData};f.prototype.getFormatType=function(){return this._formatType};f.prototype.getIterateCount=function(){return 1};Xflow.DataChangeNotifier={_listeners:[]};var c=Xflow.DataChangeNotifier;c.addListener=
function(a){this._listeners.push(a)};c.removeListener=function(a){Array.erase(this._listeners,a)}})();
(function(){function b(a){return!a._filterMapping.isEmpty()||a._computeOperator?null:a._sourceNode&&0==a._children.length?a._sourceNode:1==a._children.length&&a._children[0]instanceof d?a._children[0]:null}function a(a,c){for(var d=0;d<a._parents.length;++d)a._parents[d].notify(c,a)}Xflow.Graph=function(){this._nodes=[]};var f=Xflow.Graph;f.prototype.createInputNode=function(){var a=new Xflow.InputNode(this);this._nodes.push(a);return a};f.prototype.createDataNode=function(a){a=new Xflow.DataNode(this,
a);this._nodes.push(a);return a};Xflow.GraphNode=function(a){this._graph=a;this._parents=[]};Xflow.InputNode=function(a){Xflow.GraphNode.call(this,a);this._name="";this._key=0;this._data=null;this._param=!1};Xflow.createClass(Xflow.InputNode,Xflow.GraphNode);f=Xflow.InputNode;f.prototype.notify=function(c,d){a(this,d==Xflow.DATA_ENTRY_STATE.CHANGED_VALUE?Xflow.RESULT_STATE.CHANGED_DATA:Xflow.RESULT_STATE.CHANGED_STRUCTURE)};Object.defineProperty(f.prototype,"name",{set:function(c){this._name=c;a(this,
Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._name}});Object.defineProperty(f.prototype,"key",{set:function(c){this._key=c;a(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._key}});Object.defineProperty(f.prototype,"param",{set:function(c){this._param=c;a(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._param}});Object.defineProperty(f.prototype,"data",{set:function(c){this._data&&this._data.removeListener(this);(this._data=c)&&this._data.addListener(this);
a(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._data}});Xflow.DataNode=function(a,c){Xflow.GraphNode.call(this,a);this.loading=!1;this._isProtoNode=c;this._children=[];this._protoNode=this._sourceNode=null;this._filterType=0;this._filterMapping=new Xflow.OrderMapping(this);this._computeOperator="";this._computeInputMapping=new Xflow.OrderMapping(this);this._computeOutputMapping=new Xflow.OrderMapping(this);this._channelNode=new Xflow.ChannelNode(this);this._requests=[]};
Xflow.createClass(Xflow.DataNode,Xflow.GraphNode);var d=Xflow.DataNode;Xflow.Mapping=function(a){this._owner=a};Xflow.OrderMapping=function(a){Xflow.Mapping.call(this,a);this._names=[]};Xflow.createClass(Xflow.OrderMapping,Xflow.Mapping);Xflow.NameMapping=function(a){Xflow.Mapping.call(this,a);this._destNames=[];this._srcNames=[]};Xflow.createClass(Xflow.NameMapping,Xflow.Mapping);Object.defineProperty(d.prototype,"sourceNode",{set:function(a){this._sourceNode&&Array.erase(this._sourceNode._parents,
this);(this._sourceNode=a)&&this._sourceNode._parents.push(this);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._sourceNode}});Object.defineProperty(d.prototype,"protoNode",{set:function(a){this._protoNode&&Array.erase(this._protoNode._parents,this);(this._protoNode=a)&&this._protoNode._parents.push(this);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._protoNode}});Object.defineProperty(d.prototype,"filterType",{set:function(a){this._filterType=
a;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._filterType}});Object.defineProperty(d.prototype,"filterMapping",{set:function(){throw Error("filterMapping is readonly!");},get:function(){return this._filterMapping}});Object.defineProperty(d.prototype,"computeOperator",{set:function(a){this._computeOperator=a;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)},get:function(){return this._computeOperator}});Object.defineProperty(d.prototype,"computeInputMapping",{set:function(){throw Error("computeInputMapping is readonly!");
},get:function(){return this._computeInputMapping}});Object.defineProperty(d.prototype,"computeOutputMapping",{set:function(){throw Error("computeOutputMapping is readonly!");},get:function(){return this._computeOutputMapping}});d.prototype.isProtoNode=function(){return this._isProtoNode};d.prototype.appendChild=function(a){this._children.push(a);a._parents.push(this);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)};d.prototype.removeChild=function(a){Array.erase(this._children,a);Array.erase(a._parents,
this);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)};d.prototype.insertBefore=function(a,c){var d=this._children.indexOf(c);-1==d?this._children.push(a):this._children.splice(d,0,a);a._parents.push(this);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)};d.prototype.clearChildren=function(){for(var a=0;a<this._children.length;++a)Array.erase(this._children[a]._parents,this);this._children=[];this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)};d.prototype.detachFromParents=function(){for(var a=
0;a<this._parents.length;++a){var c=this._parents[a];c._sourceNode==this?c.sourceNode=null:c._protoNode==this?c.protoNode=null:c.removeChild(this)}this._children=[]};var e=/^([A-Za-z\s]*)\(([^()]+)\)$/;d.prototype.setFilter=function(a){var a=a||"",c=Xflow.DATA_FILTER_TYPE.RENAME,d=null;if(a){var b=a.trim().match(e);if(b){d=b[1].trim();switch(d){case "keep":c=Xflow.DATA_FILTER_TYPE.KEEP;break;case "remove":c=Xflow.DATA_FILTER_TYPE.REMOVE;break;case "rename":c=Xflow.DATA_FILTER_TYPE.RENAME;break;default:XML3D.debug.logError("Unknown filter type:"+
d)}d=Xflow.Mapping.parse(b[2],this)}else XML3D.debug.logError("Could not parse filter '"+a+"'")}d||(d=new Xflow.OrderMapping(this));if(b=this._filterMapping)b._owner=null;this._filterMapping=d;this._filterType=c;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)};var c=/^(([^=]+)\=)?([^(]+)\(([^()]*)\)$/,h=/^\(([^()]*)\)$/;d.prototype.setCompute=function(a){var d="",b=null,e=null;if(a=(a||"").trim().match(c)){e=a[2]?a[2].trim():"";d=a[3].trim();b=a[4]?a[4].trim():"";if(a=e.match(h))e=a[1];b=Xflow.Mapping.parse(b,
this);e=Xflow.Mapping.parse(e,this)}b||(b=new Xflow.OrderMapping(this));e||(e=new Xflow.OrderMapping(this));if(a=this._computeInputMapping)a._owner=null;if(a=this._computeOutputMapping)a._owner=null;this._computeInputMapping=b;this._computeOutputMapping=e;this._computeOperator=d;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)};d.prototype.notify=function(c,d){if(c==Xflow.RESULT_STATE.CHANGED_STRUCTURE){this._channelNode.setStructureOutOfSync();a(this,c);for(var b in this._requests)this._requests[b].notify(c)}else c==
Xflow.RESULT_STATE.CHANGED_DATA&&this._channelNode.notifyDataChange(d)};d.prototype.getOutputNames=function(){var a=b(this);return a?a.getOutputNames():this._channelNode.getOutputNames()};d.prototype.getOutputChannelInfo=function(a){return(b(this)||this)._channelNode.getOutputChannelInfo(a)};d.prototype._getComputeResult=function(a){var c=b(this);return c?c._getComputeResult(a):this._channelNode.getComputeResult(a)}})();
(function(){function b(a){a._owner&&a._owner.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE)}Xflow.Mapping.parse=function(c,b){var c=c.trim(),g=c.trim().match(f);if(g)return a.parse(c,b);if(g=c.trim().match(e))return d.parse(g[1],b);XML3D.debug.logError("Cannot parse name mapping '"+c+"'");return null};var a=Xflow.OrderMapping;a.parse=function(a,d){for(var b=new Xflow.OrderMapping(d),e=a.split(","),f=0;f<e.length;f++)b._names.push(e[f].trim());return b};Object.defineProperty(a.prototype,"length",{set:function(){throw Error("length is read-only");
},get:function(){return this._name.length}});a.prototype.getName=function(a){return this._names[a]};a.prototype.clear=function(){this._names=[];b(this)};a.prototype.setName=function(a,d){this._names[a]=d;b(this)};a.prototype.removeName=function(a){this._names.splice(a);b(this)};a.prototype.isEmpty=function(){return 0==this._names.length};var f=/^([^:,{}]+)(,[^:{},]+)*$/;a.prototype.applyFilterOnChannelMap=function(a,d,b,e,f,j){for(var l in d.map){var m=this._names.indexOf(l);(f==Xflow.DATA_FILTER_TYPE.RENAME||
f==Xflow.DATA_FILTER_TYPE.KEEP&&-1!=m||f==Xflow.DATA_FILTER_TYPE.REMOVE&&-1==m)&&j(a,l,d,l,b,e)}};a.prototype.getScriptInputName=function(a){return this._names[a]?this._names[a]:null};a.prototype.getScriptOutputName=function(a){return this._names[a]?this._names[a]:null};a.prototype.getScriptOutputNameInv=function(a,d){var b=this._names.indexOf(a);return-1==b?null:d[b].name};a.prototype.applyScriptOutputOnMap=function(a,d){var b=0,e;for(e in d)if(b<this._names.length)a[this._names[b]]=d[e],++b;else break};
a.prototype.getRenameSrcName=function(a){return a};a.prototype.filterNameset=function(a,d){if(d==Xflow.DATA_FILTER_TYPE.RENAME)return a.splice();var b=d==Xflow.DATA_FILTER_TYPE.KEEP,e=[],f;for(f in a){var j=this._names.indexOf(a[f]);(b&&-1!=j||!b&&-1==j)&&e.push(a[f])}return e};var d=Xflow.NameMapping;d.parse=function(a,d){for(var b=new Xflow.NameMapping(d),e=a.split(","),f=0;f<e.length;f++){var j=e[f].split(":"),l=j[0].trim(),j=j[1].trim();b.setNamePair(l,j)}return b};Object.defineProperty(d.prototype,
"length",{set:function(){throw Error("length is read-only");},get:function(){return this._srcNames.length}});d.prototype.getDestName=function(a){return this._destNames[a]};d.prototype.getSrcName=function(a){return this._srcNames[a]};d.prototype.getSrcNameFromDestName=function(a){a=this._destNames.indexOf(a);return-1==a?null:this._srcNames[a]};d.prototype.getDestNameFromSrcName=function(a){a=this._srcNames.indexOf(a);return-1==a?null:this._destNames[a]};d.prototype.clear=function(){this._srcNames=
[];this._destNames=[];b(this)};d.prototype.setNamePair=function(a,d){var e=this._destNames.indexOf(a);-1!=e&&(this._destNames.splice(e,1),this._srcNames.splice(e,1));this._destNames.push(a);this._srcNames.push(d);b(this)};d.prototype.removeNamePair=function(a){a=this._destNames.indexOf(a);-1!=a&&(this._destNames.splice(a,1),this._srcNames.splice(a,1));b(this)};d.prototype.isEmpty=function(){return 0==this._destNames.length};var e=/^\{(([^:,{}]+:[^:{},]+)(,[^:{},]+:[^:},]+)*)\}$/;d.prototype.filterNameset=
function(){};d.prototype.applyFilterOnChannelMap=function(a,d,b,e,f,j){if(f==Xflow.DATA_FILTER_TYPE.REMOVE)for(var l in d.map)-1==this._srcNames.indexOf(l)&&j(a,l,d,l,b,e);else{if(f==Xflow.DATA_FILTER_TYPE.RENAME)for(l in d.map)-1==this._srcNames.indexOf(l)&&j(a,l,d,l,b,e);for(l in this._destNames)j(a,this._destNames[l],d,this._srcNames[l],b,e)}};d.prototype.getRenameSrcName=function(a){return this.getSrcNameFromDestName(a)||a};d.prototype.getScriptInputName=function(a,d){return this.getSrcNameFromDestName(d)};
d.prototype.getScriptOutputName=function(a,d){return this.getDestNameFromSrcName(d)};d.prototype.getScriptOutputNameInv=function(a){a=this._destNames.indexOf(a);return-1==a?null:this._srcNames[a]};d.prototype.applyScriptOutputOnMap=function(a,d){for(var b in this._destNames)a[this._destNames[b]]=d[this._srcNames[b]]}})();
(function(){function b(a,c){a[c]||(a[c]=new Xflow.ChannelMap.Entry);return a[c]}function a(a,c){return c&&0<a.protoNames.length?c.getKey(a.protoNames):0}function f(c,d,b,f){f=a(d,f);d.channels[f]||(d.channels[f]={done:!1,channel:null});f=d.channels[f];f.done?f.channel.map==this&&f.useCount++:(d=d.channel,!d||!d.willMergeWithChannel(b)?c=b:(d=e(c,d),d.addChannelEntries(b),c=d),f.channel=c)}function d(c,d,b,f){f=a(d,f);d.channels[f]||(d.channels[f]={done:!1,channel:null});d=d.channels[f];if(d.done)return d.channel.map==
this&&d.useCount++,d.channel;f=d.channel;!f||!f.willMergeWithDataSlot(b)?c=new Xflow.Channel(c,b):(f=e(c,f),f.addDataSlot(b),c=f);return d.channel=c}function e(a,c){if(c.map!=a){var d=new Xflow.Channel(a);d.addChannelEntries(c);d.creatorProcessNode=c.creatorProcessNode;return d}return c}Xflow.DataSlot=function(a,c){this.key=c||0;this.dataEntry=a;this.parentChannels=[]};Xflow.DataSlot.prototype.addChannel=function(a){this.parentChannels.push(a)};Xflow.DataSlot.prototype.removeChannel=function(a){a=
this.parentChannels.indexOf(a);-1!=a&&this.parentChannels.splice(a,1)};Xflow.DataSlot.prototype.setDataEntry=function(a){this.dataEntry=a;this.notifyOnChange()};Xflow.DataSlot.prototype.notifyOnChange=function(){for(var a=0;a<this.parentChannels.length;++a)this.parentChannels[a].notifyOnChange()};Xflow.ChannelMap=function(){this.map={}};var c=Xflow.ChannelMap;c.prototype.getNames=function(){var a=[],c;for(c in this.map)a.push(c);return a};c.prototype.getChannel=function(c,d){if(!this.map[c])return null;
var b=this.map[c],e=a(b,d);return b.channels[e]?b.channels[e].channel:null};c.prototype.getProtoNames=function(a){return!this.map[a]?null:this.map[a].protoNames};c.prototype.mergeProtoNames=function(a){for(var c in a.map)this.addProtoNames(c,a.getProtoNames(c))};c.prototype.addProtoNames=function(a,c){var d=b(this.map,a);Xflow.nameset.add(d.protoNames,c)};c.prototype.merge=function(a,c){for(var d in a.map)this.addChannel(d,a.getChannel(d,c),c)};c.prototype.addChannel=function(a,c,d){a=b(this.map,
a);f(this,a,c,d)};c.prototype.addDataEntry=function(a,c,e,h){var l=b(this.map,a);e&&h&&h.map[a]?f(this,l,h.map[a],h):d(this,l,c,h)};c.prototype.addOutputDataSlot=function(a,c,e,f){a=b(this.map,a);d(this,a,c,f).creatorProcessNode=e};c.prototype.markAsDone=function(c){for(var d in this.map){var b=this.map[d],e=a(b,c);b.channels[e].done=!0}};c.prototype.clearSubstitution=function(c){for(var d in this.map){var b=this.map[d],e=a(b,c),f=b.channels[e]&&b.channels[e].channel;f&&(f.map==this&&(f.useCount--,
0==f.useCount&&f.clear()),0==f.useCount&&delete b.channels[e])}};c.prototype.clearAll=function(){for(var a in this.map){var c=this.map[a],d;for(d in c.channels){var b=c.channels[d].channel;b&&b.map==this&&b.clear()}}this.map={}};Xflow.ChannelMap.Entry=function(){this.protoNames=[];this.origins=0;this.channels={}};Xflow.Channel=function(a,c){this.entries=[];this.map=a;this.id=++h;this.listeners=[];this.useCount=1;this.creatorProcessNode=null;c&&this.addDataSlot(c)};c=Xflow.Channel;c.prototype.addDataSlot=
function(a){a.addChannel(this);for(var c=0;c<this.entries.length;++c){var d=this.entries[c];if(d.key>=a.key-Xflow.EPSILON){Math.abs(d.key-a.key)<=Xflow.EPSILON?(d.removeChannel(this),this.entries.splice(c,1,a)):this.entries.splice(c,0,a);break}}this.entries.push(a)};c.prototype.getSequenceLength=function(){return this.entries.length};c.prototype.getSequenceMinKey=function(){return this.entries[0].key};c.prototype.getSequenceMaxKey=function(){return this.entries[this.entries.length-1].key};c.prototype.getType=
function(){return 0==this.entries.length?Xflow.DATA_TYPE.UNKNOWN:this.entries[0].dataEntry._type};c.prototype.addChannelEntries=function(a){for(var c=0;c<a.entries.length;++c)this.addDataSlot(a.entries[c])};c.prototype.getDataEntry=function(a,c){if(0==this.entries.length)return null;if(!a)return this.entries[0].dataEntry;for(var d=0,b=this.entries.length;d<b&&this.entries[d].key<c;)++d;if(a==Xflow.SEQUENCE.PREV_BUFFER)return this.entries[d?d-1:0].dataEntry;if(a==Xflow.SEQUENCE.NEXT_BUFFER)return this.entries[d<
b?d:b-1].dataEntry;if(a==Xflow.SEQUENCE.LINEAR_WEIGHT){var e=this.entries[d?d-1:0].key,d=this.entries[d<b?d:b-1].key,b=new Float32Array(1);b[0]=d==e?0:(c-e)/(d-e);return new Xflow.BufferEntry(Xflow.DATA_TYPE.FLOAT,b)}return null};c.prototype.willMergeWithChannel=function(a){if(this.entries.length!=a.entries.length)return!0;if(this.getType()!=a.getType())return!1;for(var c=0;c<this.entries.length;c++)if(Math.abs(this.entries[c].key-a.entries[c].key)>Xflow.EPSILON)return!0;return!1};c.prototype.willMergeWithDataSlot=
function(a){return 1<this.entries.length?!0:this.getType()!=a.dataEntry._type?!1:Math.abs(this.entries[0].key-a.key)>Xflow.EPSILON?!0:!1};c.prototype.notifyOnChange=function(){for(var a=0;a<this.listeners.length;a++)this.listeners[a](this)};c.prototype.addListener=function(a){this.listeners.push(a)};c.prototype.removeListener=function(a){a=this.listeners.indexOf(a);-1!=a&&this.listeners.splice(a,1)};c.prototype.clear=function(){for(var a=0;a<this.entries.length;++a)this.entries[a].removeChannel(this)};
var h=0;Xflow.Substitution=function(a,c){this.map={};for(var d in a.map)this.map[d]=a.getChannel(d,c)};Xflow.Substitution.prototype.getKey=function(a){var c=[];if(a)for(var d=0;d<a.length;++d){var b=this.map[a[d]];c[d]=a[d]+">"+(b&&b.id||"X")}else{var d=0,e;for(e in this.map)b=this.map[e],c[d++]=e+">"+(b&&b.id||"X")}return 0<c.length?c.join(";"):0}})();
(function(){function b(a,c,d,b){d=d.getProtoNames(b);a.addProtoNames(c,d)}function a(a,c,d,b,f){a.addProtoNames(c,f)}function f(a,c,d,b,f,k){d=d.getChannel(b,k);a.addChannel(c,d,f)}Xflow.ChannelNode=function(a){this.owner=a;this.loading=!1;this.inputSlots={};this.inputChannels=new Xflow.ChannelMap;this.protoInputChannels=new Xflow.ChannelMap;this.finalOutputChannels=new Xflow.ChannelMap;this.operator=null;this.protoNames=[];this.operatorProtoNames=[];this.emptySubstitutionNode=null;this.processNodes=
{};this.requestNodes={};this.outOfSync=!0};var d=Xflow.ChannelNode;d.prototype.synchronize=function(){if(this.outOfSync){var d=this.owner;this.loading=d.loading;if(d._sourceNode)d._sourceNode._channelNode.synchronize(),this.loading=this.loading||d._sourceNode._channelNode.loading;else for(var c,f=0;f<d._children.length;++f)if((c=d._children[f]._channelNode)&&!d._children[f].isProtoNode())c.synchronize(),this.loading=this.loading||c.loading;var d=this.owner,g;if(d._sourceNode)this.inputChannels.mergeProtoNames(d._sourceNode._channelNode.finalOutputChannels);
else{for(c=0;c<d._children.length;++c)if((g=d._children[c]._channelNode)&&!d._children[c].isProtoNode())this.inputChannels.mergeProtoNames(g.finalOutputChannels),Xflow.nameset.add(this.protoNames,g.protoNames);for(c=0;c<d._children.length;++c)if((g=d._children[c])&&!g._channelNode)g._param&&(this.inputChannels.addProtoNames(g._name,g._name),Xflow.nameset.add(this.protoNames,g._name)),this.inputSlots[g._name+";"+g._key]=new Xflow.DataSlot(g._data,g._key)}if(this.operator=(g=this.owner._computeOperator)&&
Xflow.getOperator(g)){g=this.operator;d=this.owner._computeInputMapping;for(c=0;c<g.params.length;++c)(f=d.getScriptInputName(c,g.params[c].source))&&Xflow.nameset.add(this.operatorProtoNames,this.inputChannels.getProtoNames(f))}g=this.owner;this.protoInputChannels.mergeProtoNames(this.inputChannels);if(d=this.operator)for(c=0;c<d.outputs.length;++c)this.protoInputChannels.addProtoNames(g._computeOutputMapping.getScriptOutputName(c,d.outputs[c].name),this.operatorProtoNames);g=this.owner;g._filterMapping.applyFilterOnChannelMap(this.finalOutputChannels,
this.protoInputChannels,null,null,g._filterType,b);g._protoNode&&g._filterMapping.applyFilterOnChannelMap(this.finalOutputChannels,g._protoNode._channelNode.finalOutputChannels,this.protoNames,null,g._filterType,a);this.outOfSync=!1}};d.prototype.getSubstitutionNode=function(a){this.synchronize();if(a)return new Xflow.SubstitutionNode(this,a);this.emptySubstitutionNode||(this.emptySubstitutionNode=new Xflow.SubstitutionNode(this,null));return this.emptySubstitutionNode};d.prototype.getProcessNode=
function(a){if(!this.operator)return null;var c=a?a.getKey(this.operatorProtoNames):0;this.processNodes[c]||(this.processNodes[c]=new Xflow.ProcessNode(this,this.operator,a));this.processNodes[c].useCount++;return this.processNodes[c]};d.prototype.clearProcessNode=function(a){if(this.operator){var a=a?a.getKey(this.operatorProtoNames):0,c=this.processNodes[a];c&&(c.useCount--,0==c.useCount&&delete this.processNodes[a])}};d.prototype.notifyDataChange=function(a){var c=a._name+";"+a._key;this.inputSlots[c]&&
this.inputSlots[c].setDataEntry(a._data)};d.prototype.setStructureOutOfSync=function(){if(!this.outOfSync){this.outOfSync=!0;this.inputChannels.clearAll();this.protoInputChannels.clearAll();this.finalOutputChannels.clearAll();this.emptySubstitutionNode&&this.emptySubstitutionNode.clear();this.emptySubstitutionNode=null;for(var a in this.requestNodes)this.requestNodes[a].setStructureOutOfSync();for(a in this.processNodes);}};d.prototype.getOutputNames=function(){this.synchronize();this.getSubstitutionNode(null);
return this.finalOutputChannels.getNames()};d.prototype.getComputeResult=function(a){this.synchronize();this.getSubstitutionNode(null);var c=a?a.join(";"):"[null]";this.requestNodes[c]||(this.requestNodes[c]=new Xflow.RequestNode(this,a));return this.requestNodes[c].getResult(Xflow.RESULT_TYPE.COMPUTE)};d.prototype.getOutputChannelInfo=function(a){this.synchronize();this.getSubstitutionNode(null);var c=this.finalOutputChannels.getChannel(a);if(!c)return null;var d={type:c.getType(),seqLength:c.getSequenceLength(),
seqMinKey:c.getSequenceMinKey(),seqMaxKey:c.getSequenceMaxKey(),origin:0,originalName:""},a=this.owner._filterMapping.getRenameSrcName(a),c=c.getDataEntry();if(this.owner._protoNode){var b=this.protoInputChannels.getChannel(a);if(!b||c!=b.getDataEntry())return d.origin=Xflow.ORIGIN.PROTO,d.originalName=a,d}if(this.operator&&(b=this.inputChannels.getChannel(a),!b||c!=b.getDataEntry()))return d.origin=Xflow.ORIGIN.COMPUTE,d.originalName=this.owner._computeOutputMapping.getScriptOutputNameInv(a,this.operator.outputs),
d;d.origin=Xflow.ORIGIN.CHILD;d.originalName=a;return d};Xflow.SubstitutionNode=function(a,c){this.owner=a;this.substitution=c;this.childSubNodes=[];this.protoSubNode=this.processNode=null;var d=a.owner;if(d._sourceNode)this.childSubNodes.push(d._sourceNode._channelNode.getSubstitutionNode(c));else for(var b,i=0;i<d._children.length;++i)(b=d._children[i]._channelNode)&&!d._children[i].isProtoNode()&&this.childSubNodes.push(b.getSubstitutionNode(c));var d=a.owner,k;if(d._sourceNode)a.inputChannels.merge(d._sourceNode._channelNode.finalOutputChannels,
c);else{for(b=0;b<d._children.length;++b)(k=d._children[b]._channelNode)&&!d._children[b].isProtoNode()&&a.inputChannels.merge(k.finalOutputChannels,c);for(b=0;b<d._children.length;++b)(k=d._children[b])&&!k._channelNode&&a.inputChannels.addDataEntry(k._name,a.inputSlots[k._name+";"+k._key],k._param,c)}this.processNode=a.getProcessNode(c);k=a.owner;a.protoInputChannels.merge(a.inputChannels,c);if(d=this.processNode){b=0;for(var j in d.outputDataSlots)(i=k._computeOutputMapping.getScriptOutputName(b,
j))&&a.protoInputChannels.addOutputDataSlot(i,d.outputDataSlots[j],d,c),b++}j=a.owner;j._protoNode&&(k=new Xflow.Substitution(a.protoInputChannels,c),this.protoSubNode=j._protoNode._channelNode.getSubstitutionNode(k));j=a.owner;j._filterMapping.applyFilterOnChannelMap(a.finalOutputChannels,a.protoInputChannels,c,c,j._filterType,f);this.protoSubNode&&j._filterMapping.applyFilterOnChannelMap(a.finalOutputChannels,this.protoSubNode.owner.finalOutputChannels,c,this.protoSubNode.substitution,j._filterType,
f);a.inputChannels.markAsDone(c);a.protoInputChannels.markAsDone(c);a.finalOutputChannels.markAsDone(c)};Xflow.SubstitutionNode.prototype.clear=function(){if(this.substitution){var a=this.owner,c=this.substitution;a.inputChannels.clearSubstitution(c);a.protoInputChannels.clearSubstitution(c);a.finalOutputChannels.clearSubstitution(c);for(a=0;a<this.childSubNodes.length;++a)this.childSubNodes[a].clear()}this.protoSubNode&&this.protoSubNode.clear();this.processNode&&this.owner.clearProcessNode(this.substitution)}})();
(function(){function b(a,b,c){for(var f in a.params){var g=a.params[f],i=b.getScriptInputName(f,g.source);if(!g.optional&&!i)return XML3D.debug.logError("Xflow: operator "+a.name+": Missing input argument for "+g.source),!1;if(i){var k=c[g.source];if(!k)return XML3D.debug.logError("Xflow: operator "+a.name+": Input of name '"+i+"' not found. Used for parameter "+g.source),!1;i=k.getDataEntry();if(!g.optional&&(!i||i.isEmpty()))return XML3D.debug.logError("Xflow: operator "+a.name+": Input for "+g.source+
" contains no data."),!1;if(i&&i.type!=g.type)return XML3D.debug.logError("Xflow: operator "+a.name+": Input for "+g.source+" has wrong type. Expected: "+Xflow.getTypeName(g.type)+", but got: "+Xflow.getTypeName(i.type)),!1}}return!0}function a(a,b,c){var f,g;for(g in c)if((f=c[g])&&f.creatorProcessNode)Xflow.utils.setAdd(a,f.creatorProcessNode),Xflow.utils.setAdd(b,f.creatorProcessNode.descendants);Xflow.utils.setRemove(a,b);Xflow.utils.setAdd(b,a)}Xflow.ProcessNode=function(d,b,c){this.owner=d;
this.operator=b;this.inputChannels={};this.outputDataSlots={};this.loading=this.valid=this.processed=!1;this.useCount=0;this.children=[];this.descendants=[];this.channelListener=this.onChannelChange.bind(this);for(var b=this.operator,f=d.owner._computeInputMapping,g=0;g<b.params.length;++g){var i=b.params[g].source,k=f.getScriptInputName(g,i);k&&((k=d.inputChannels.getChannel(k,c))&&k.addListener(this.channelListener),this.inputChannels[i]=k)}a(this.children,this.descendants,this.inputChannels);var d=
this.operator,c=this.outputDataSlots,j;for(j in d.outputs)b=d.outputs[j],f=b.type,f=f!=Xflow.DATA_TYPE.TEXTURE?new Xflow.BufferEntry(f,null):window.document?new Xflow.TextureEntry(null):new Xflow.ImageDataTextureEntry(null),c[b.name]=new Xflow.DataSlot(f,0)};var f=Xflow.ProcessNode;f.prototype.onChannelChange=function(){this.processed=!1;for(var a in this.outputDataSlots)this.outputDataSlots[a].notifyOnChange()};f.prototype.clear=function(){for(var a in this.inputChannels)this.inputChannels[a].removeListener(this.channelListener)};
f.prototype.process=function(){if(!this.processed){this.loading=!1;this.valid=!0;for(var a=0;a<this.children.length;++a)if(this.children[a].process(),this.children[a].loading){this.loading=!0;return}this.processed=!0;var e;a:{var a=this.operator,c=this.inputChannels;for(e in a.params){var f=c[a.params[e].source];if(f&&(f=f.getDataEntry())&&f.isLoading&&f.isLoading()){e=!0;break a}}e=!1}e?this.loading=!0:b(this.operator,this.owner.owner._computeInputMapping,this.inputChannels)?this.applyOperator():
this.valid=!1}};Xflow.RequestNode=function(a,b){this.owner=a;this.filter=b;this.results={};this.channels={};this.children=[];this.channelListener=this.onChannelChange.bind(this);this.outOfSync=!0;this.processed=!1};f=Xflow.RequestNode;f.prototype.synchronize=function(){if(this.outOfSync){this.outOfSync=!1;var d=this.owner,b=this.filter;if(!b){var b=[],c;for(c in d.finalOutputChannels.map)b.push(c)}for(var f=0;f<b.length;++f){c=b[f];var g=d.finalOutputChannels.getChannel(c);g&&(this.channels[c]=g,
g.addListener(this.channelListener))}a(this.children,[],this.channels)}};f.prototype.getResult=function(a){this.synchronize();this.loading=this.owner.loading;if(!this.loading&&!this.processed){this.loading=!1;this.processed=!0;for(var b=0;b<this.children.length;++b)if(this.children[b].process(),this.children[b].loading){this.loading=!0;break}}b=null;if(a==Xflow.RESULT_TYPE.COMPUTE){this.results[Xflow.RESULT_TYPE.COMPUTE]||(this.results[Xflow.RESULT_TYPE.COMPUTE]=new Xflow.ComputeResult);a=this.results[Xflow.RESULT_TYPE.COMPUTE];
a._dataEntries={};a._outputNames=[];for(var c in this.channels)b=this.channels[c].getDataEntry(),a._dataEntries[c]=b&&!b.isEmpty()?b:null,a._outputNames.push(c);b=a}b.loading=this.loading;return b};f.prototype.setStructureOutOfSync=function(){this.outOfSync=!0;this.loading=this.processed=!1;for(var a in this.results)this.results[a].notifyChanged(Xflow.RESULT_STATE.CHANGED_STRUCTURE);for(var b in this.channels)this.channels[b].removeListener(this.channelListener);this.channels=[];this.children=[]};
f.prototype.onChannelChange=function(){this.processed=!1;for(var a in this.results)this.results[a].notifyChanged(Xflow.RESULT_STATE.CHANGED_DATA)}})();
(function(){var b=function(a,b,d){this._dataNode=a;this._filter=b?b.slice().sort():null;this._listener=d;this.result=null;this._dataNode._requests.push(this)};Xflow.Request=b;Object.defineProperty(b.prototype,"dataNode",{set:function(){throw Error("dataNode is readonly");},get:function(){return this._dataNode}});Object.defineProperty(b.prototype,"filter",{set:function(){throw Error("filter is read-only");},get:function(){return this._filter}});b.prototype.clear=function(){this._listener=null;this.result&&
this.result.removeListener(this.callback);Array.erase(this._dataNode._requests,this)};b.prototype.notify=function(a){this._listener&&this._listener(this,a)};b=function(a,b,d){Xflow.Request.call(this,a,b,d);this.callback=this.onResultChanged.bind(this)};Xflow.createClass(b,Xflow.Request);Xflow.ComputeRequest=b;b.prototype.getResult=function(){this.result&&this.result.removeListener(this.callback);(this.result=this._dataNode._getComputeResult(this._filter))&&this.result.addListener(this.callback);return this.result};
b.prototype.onResultChanged=function(a,b){this.notify(b)}})();
(function(){Xflow.Result=function(){this.valid=this.loading=!1;this._outputNames=[];this._dataEntries={};this._listeners=[]};var b=Xflow.Result;Object.defineProperty(b.prototype,"outputNames",{set:function(){throw Error("outputNames is readonly");},get:function(){return this._outputNames}});b.prototype.getOutputData=function(a){return this._dataEntries[a]};b.prototype.getOutputMap=function(){return this._dataEntries};b.prototype.addListener=function(a){this._listeners.push(a)};b.prototype.removeListener=
function(a){Array.erase(this._listeners,a)};b.prototype.notifyChanged=function(a){this.valid=!1;for(var b=0;b<this._listeners.length;++b)this._listeners[b](this,a)};Xflow.ComputeResult=function(a){Xflow.Result.call(this,a)};Xflow.createClass(Xflow.ComputeResult,Xflow.Result)})();
(function(){Xflow.utils={};Xflow.utils.setAdd=function(b,a){if(void 0!==a.length)for(var f=0;f<a.length;++f)-1==b.indexOf(a[f])&&b.push(a[f]);else-1==b.indexOf(a)&&b.push(a)};Xflow.utils.setRemove=function(b,a){var f;if(void 0!==a.length)for(var d=0;d<a.length;++d)-1!=(f=b.indexOf(a[d]))&&b.splice(f,1);else-1!=(f=b.indexOf(a))&&b.splice(f,1)};Xflow.nameset={};Xflow.nameset.add=function(b,a){if(a)if("string"==typeof a)-1==b.indexOf(a)&&b.push(a);else for(var f=0;f<a.length;++f)-1==b.indexOf(a[f])&&
b.push(a[f])};Xflow.nameset.remove=function(b,a){if(a)if("string"==typeof a){var f=b.indexOf(a);-1!=f&&b.splice(f,1)}else for(var d=0;d<a.length;++d)f=b.indexOf(a[d]),-1!=f&&b.splice(f,1)};Xflow.nameset.intersection=function(b,a){for(var f=b.length;f--;)-1==a.indexOf(b[f])&&b.splice(f,1)};Xflow.utils.binarySearch=function(b,a,f){for(var d=0,f=f-1;d<=f;){var e=Math.floor((d+f)/2);if(b[e]==a)return e;b[e]<a?d=e+1:f=e-1}return f}})();
(function(){function b(a){var c={},d=a.toString().match(i);if(!d)return XML3D.debug.logError("Xflow Internal: Could not parse function: "+a),null;c.args=d[2].split(",");for(var b in c.args)c.args[b]=c.args[b].trim();c.body=d[3];return c}function a(a,c,d,b){for(var e="",f=0,h=a.indexOf("[",f);-1!=h;){var g=a.substr(f).match(k)[1],i=c.indexOf(g),g=!1,j=0;-1!=i&&(i<d.outputs.length?(g=!0,j=Xflow.DATA_TYPE_TUPLE_SIZE[[d.outputs[i].type]]):(i-=d.outputs.length,g=b.iterFlag[i],j=Xflow.DATA_TYPE_TUPLE_SIZE[d.mapping[i].internalType]));
e+=a.substring(f,h)+"[";g&&(e+=j+"*__xflowI + ");f=h+1;h=a.indexOf("[",f)}return e+=a.substring(f)}function f(c,d){var e="function (",f=b(c.evaluate_core),e=e+(f.args.join(",")+",__xflowMax) {\n"),e=e+"    var __xflowI = __xflowMax\n    while(__xflowI--){\n",h=f.body,h=a(h,f.args,c,d);return eval("("+(e+(h+"\n  }\n}"))+")")}function d(a,d,b,e){if(a.alloc){var f=[j];c(f,d);a.alloc.apply(e,f)}for(var h in a.outputs){var g=a.outputs[h],f=b[g.name].dataEntry;if(f.type==Xflow.DATA_TYPE.TEXTURE)if(g.customAlloc){var g=
j[g.name],i=g.imageFormat.width,k=g.imageFormat.height,l=g.imageFormat.type,g=g.samplerConfig;f.createImage(i,k,l,g)}else if(g.sizeof){var t=null,u;for(u in a.mapping)if(a.mapping[u].source==g.sizeof){t=d[a.mapping[u].paramIdx];break}if(t)i=Math.max(t.getWidth(),1),k=Math.max(t.getHeight(),1),l=g.formatType||t.getFormatType(),g=g.samplerConfig||t.getSamplerConfig(),f.createImage(i,k,l,g);else throw Error("Unknown texture input parameter '"+g.sizeof+"' in operator '"+a.name+"'");}else throw Error("Cannot create texture. Use customAlloc or sizeof parameter attribute");
else if(i=(g.customAlloc?j[g.name]:e.iterateCount)*f.getTupleSize(),!f._value||f._value.length!=i)switch(f.type){case Xflow.DATA_TYPE.FLOAT:case Xflow.DATA_TYPE.FLOAT2:case Xflow.DATA_TYPE.FLOAT3:case Xflow.DATA_TYPE.FLOAT4:case Xflow.DATA_TYPE.FLOAT4X4:f.setValue(new Float32Array(i));break;case Xflow.DATA_TYPE.INT:case Xflow.DATA_TYPE.INT4:case Xflow.DATA_TYPE.BOOL:f.setValue(new Int32Array(i));break;default:XML3D.debug.logWarning("Could not allocate output buffer of TYPE: "+f.type)}else f.notifyChanged()}}
function e(a,d,b){var e=[],f;for(f in a.outputs){var h=b[a.outputs[f].name].dataEntry,h=h?h.getValue():null;e.push(h)}c(e,d);return e}function c(a,c){for(var d=0;d<c.length;++d){var b=c[d],b=b?b.getValue():null;a.push(b)}}function h(a,c,d){var b=[],e=[];b.push(e);b.push(a.evaluate_parallel);for(var f=0;f<a.mapping.length;++f){var h=null;c[f]&&(a.mapping[f].internalType==Xflow.DATA_TYPE.TEXTURE?(0==e.length?(e[0]=c[f].getHeight(),e[1]=c[f].getWidth()):(e[0]=Math.min(e[0],c[f].getHeight()),e[1]=Math.min(e[1],
c[f].getWidth())),h=new ParallelArray(c[f].getFilledCanvas())):h=new ParallelArray(c[f].getValue()));b.push(h)}c=l.apply(this,b);c.materialize();a=d[a.outputs[0].name].dataEntry;window.RiverTrail.compiler.openCLContext.writeToContext2D(a.getContext2D(),c.data,a.getWidth(),a.getHeight());return h=a.getValue()}var g={};Xflow.registerOperator=function(a,c){for(var d={},b=0;b<c.outputs.length;++b)c.outputs[b].type=Xflow.DATA_TYPE_MAP[c.outputs[b].type];for(b=0;b<c.params.length;++b)c.params[b].type=Xflow.DATA_TYPE_MAP[c.params[b].type],
d[c.params[b].source]=b;c.mapping||(c.mapping=c.params);for(b=0;b<c.mapping.length;++b){var e=c.mapping[b],f=d[e.source];e.paramIdx=f;f=c.params[f].type;e.sequence&&(e.keyParamIdx=d[e.keySource]);c.mapping[b].sequence==Xflow.SEQUENCE.LINEAR_WEIGHT&&(f=Xflow.DATA_TYPE.FLOAT);c.mapping[b].internalType=f}g[a]=c;c.name=a};Xflow.getOperator=function(a){return a&&!g[a]?(XML3D.debug.logError("Unknown operator: '"+a+"'"),null):g[a]};var i=/function\s+([^(]*)\(([^)]*)\)\s*\{([\s\S]*)\}/,k=/([a-zA-Z_$][\w$]*)(\[)/,
j={};if(window.ParallelArray)var l=function(){function a(c){return ParallelArray.apply(this,c)}a.prototype=ParallelArray.prototype;return function(){return new a(arguments)}}();Xflow.ProcessNode.prototype.applyOperator=function(){this._operatorData||(this._operatorData={iterateKey:null,iterFlag:{},iterateCount:0});var a=[],c=this.operator,b=this.inputChannels,g;for(g in c.mapping){var i=c.mapping[g],k=b[i.source],j=0;i.sequence&&(j=(j=(j=b[i.keySource])?j.getDataEntry():null)&&j._value?j._value[0]:
0);a.push(k?k.getDataEntry(i.sequence,j):null)}c=this.operator;b=this._operatorData;g=-1;b&&(b.iterateKey="",b.iterFlag={});for(var l in c.mapping)i=a[l],!c.mapping[l].array&&i&&1<i.getIterateCount()?(b&&(b.iterateKey+="i",b.iterFlag[l]=!0),i=i.getIterateCount(),g=-1==g?i:Math.min(i,g)):b&&(b.iterateKey+="a");g=-1==g?1:g;b&&(b.iterateCount=g);this.operator.evaluate_parallel&&window.ParallelArray&&window.RiverTrail&&window.RiverTrail.compiler?(d(this.operator,a,this.outputDataSlots,this._operatorData),
h(this.operator,a,this.outputDataSlots,this._operatorData)):this.operator.evaluate_core?(d(this.operator,a,this.outputDataSlots,this._operatorData),l=this.operator,c=this._operatorData,a=e(l,a,this.outputDataSlots),a.push(c.iterateCount),b=c.iterateKey,l._inlineLoop||(l._inlineLoop={}),l._inlineLoop[b]||(l._inlineLoop[b]=f(l,c)),l._inlineLoop[b].apply(c,a)):(d(this.operator,a,this.outputDataSlots,this._operatorData),l=this.operator,c=this._operatorData,a=e(l,a,this.outputDataSlots),a.push(c),l.evaluate.apply(c,
a));for(var r in this.outputDataSlots)a=this.outputDataSlots[r].dataEntry,a.finish&&a.finish()}})();
Xflow.registerOperator("xflow.morph",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value"},{type:"float3",source:"valueAdd"},{type:"float",source:"weight"}],evaluate:function(b,a,f,d,e){for(var c=0;c<e.iterateCount;c++){var h=d[e.iterFlag[2]?c:0];b[3*c]=a[e.iterFlag[0]?3*c:0]+h*f[e.iterFlag[1]?3*c:0];b[3*c+1]=a[e.iterFlag[0]?3*c+1:1]+h*f[e.iterFlag[1]?3*c+1:1];b[3*c+2]=a[e.iterFlag[0]?3*c+2:2]+h*f[e.iterFlag[1]?3*c+2:2]}return!0},evaluate_core:function(b,a,f,d){b[0]=a[0]+
d[0]*f[0];b[1]=a[1]+d[0]*f[1];b[2]=a[2]+d[0]*f[2]}});Xflow.registerOperator("xflow.sub",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value1"},{type:"float3",source:"value2"}],evaluate:function(){throw"Not used!";},evaluate_core:function(b,a,f){b[0]=a[0]-f[0];b[1]=a[1]-f[1];b[2]=a[2]-f[2]}});
Xflow.registerOperator("xflow.normalize",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value"}],evaluate:function(b,a,f){for(var d=0;d<f.iterateCount;d++){var e=3*d,c=a[e],h=a[e+1],g=a[e+2],i=1/Math.sqrt(c*c+h*h+g*g);b[e]=c*i;b[e+1]=h*i;b[e+2]=g*i}}});
Xflow.registerOperator("xflow.lerpSeq",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"sequence"},{type:"float",source:"key"}],mapping:[{source:"sequence",sequence:Xflow.SEQUENCE.PREV_BUFFER,keySource:"key"},{source:"sequence",sequence:Xflow.SEQUENCE.NEXT_BUFFER,keySource:"key"},{source:"sequence",sequence:Xflow.SEQUENCE.LINEAR_WEIGHT,keySource:"key"}],evaluate_core:function(b,a,f,d){var e=1-d[0];b[0]=e*a[0]+d[0]*f[0];b[1]=e*a[1]+d[0]*f[1];b[2]=e*a[2]+d[0]*f[2]},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.lerpKeys",{outputs:[{type:"float3",name:"result"}],params:[{type:"float",source:"keys",array:!0},{type:"float3",source:"values",array:!0},{type:"float",source:"key"}],alloc:function(b){b.result=3},evaluate:function(b,a,f,d){var e=Math.min(a.length,Math.floor(f.length/3)),c=Xflow.utils.binarySearch(a,d[0],e);0>c||c==e-1?(c=Math.max(0,c),b[0]=f[3*c],b[1]=f[3*c+1],b[2]=f[3*c+2]):(a=(d-a[c])/(a[c+1]-a[c]),d=1-a[0],b[0]=d*f[3*c]+a*f[3*c+3],b[1]=d*f[3*c+1]+a*f[3*c+4],b[2]=
d*f[3*c+2]+a*f[3*c+5])}});
Xflow.registerOperator("xflow.slerpSeq",{outputs:[{type:"float4",name:"result"}],params:[{type:"float4",source:"sequence"},{type:"float",source:"key"}],mapping:[{source:"sequence",sequence:Xflow.SEQUENCE.PREV_BUFFER,keySource:"key"},{source:"sequence",sequence:Xflow.SEQUENCE.NEXT_BUFFER,keySource:"key"},{source:"sequence",sequence:Xflow.SEQUENCE.LINEAR_WEIGHT,keySource:"key"}],evaluate:function(b,a,f,d,e){for(var c=0;c<e.iterateCount;++c)XML3D.math.quat.slerpOffset(a,e.iterFlag[0]?4*c:0,f,e.iterFlag[1]?
4*c:0,d[0],b,4*c,!0)},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.slerpKeys",{outputs:[{type:"float4",name:"result"}],params:[{type:"float",source:"keys",array:!0},{type:"float4",source:"values",array:!0},{type:"float",source:"key"}],alloc:function(b){b.result=4},evaluate:function(b,a,f,d){var e=Math.min(a.length,Math.floor(f.length/4)),c=Xflow.utils.binarySearch(a,d[0],e);0>c||c==e-1?(c=Math.max(0,c),b[0]=f[4*c],b[1]=f[4*c+1],b[2]=f[4*c+2],b[3]=f[4*c+3]):XML3D.math.quat.slerpOffset(f,4*c,f,4*(c+1),(d-a[c])/(a[c+1]-a[c]),b,0,!0)}});
Xflow.registerOperator("xflow.createTransform",{outputs:[{type:"float4x4",name:"result"}],params:[{type:"float3",source:"translation",optional:!0},{type:"float4",source:"rotation",optional:!0},{type:"float3",source:"scale",optional:!0},{type:"float3",source:"center",optional:!0},{type:"float4",source:"scaleOrientation",optional:!0}],evaluate:function(b,a,f,d,e,c,h){for(var g=0;g<h.iterateCount;g++)XML3D.math.mat4.makeTransformXflow(a?a.subarray(h.iterFlag[0]?3*g:0):null,f?f.subarray(h.iterFlag[1]?
4*g:0):null,d?d.subarray(h.iterFlag[2]?3*g:0):null,e?e.subarray(h.iterFlag[3]?3*g:0):null,c?c.subarray(h.iterFlag[4]?4*g:0):null,b.subarray(16*g));return!0}});
Xflow.registerOperator("xflow.createTransformInv",{outputs:[{type:"float4x4",name:"result"}],params:[{type:"float3",source:"translation",optional:!0},{type:"float4",source:"rotation",optional:!0},{type:"float3",source:"scale",optional:!0},{type:"float3",source:"center",optional:!0},{type:"float4",source:"scaleOrientation",optional:!0}],evaluate:function(b,a,f,d,e,c,h){for(var g=0;g<h.iterateCount;g++)XML3D.math.mat4.makeTransformInvXflow(a?a.subarray(h.iterFlag[0]?3*g:0):null,f?f.subarray(h.iterFlag[1]?
4*g:0):null,d?d.subarray(h.iterFlag[2]?3*g:0):null,e?e.subarray(h.iterFlag[3]?3*g:0):null,c?c.subarray(h.iterFlag[4]?4*g:0):null,b.subarray(16*g))},evaluate_parallel:function(){return!0}});Xflow.registerOperator("xflow.mul",{outputs:[{type:"float4x4",name:"result"}],params:[{type:"float4x4",source:"value1"},{type:"float4x4",source:"value2"}],evaluate:function(b,a,f,d){for(var e=0;e<d.iterateCount;e++)XML3D.math.mat4.multiplyOffset(b,16*e,a,d.iterFlag[0]?16*e:0,f,d.iterFlag[0]?16*e:0)},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.skinDirection",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"dir"},{type:"int4",source:"boneIdx"},{type:"float4",source:"boneWeight"},{type:"float4x4",source:"boneXform",array:!0}],evaluate:function(b,a,f,d,e,c){for(var h=XML3D.math.vec3.create(),g=XML3D.math.vec3.create(),i=0;i<c.iterateCount;++i){for(var k=3*i,j=h[0]=h[1]=h[2]=0;4>j;j++){var l=d[c.iterFlag[2]?4*i+j:j];l&&(XML3D.math.mat4.multiplyOffsetDirection(e,16*f[c.iterFlag[1]?4*i+j:j],
a,k,g),XML3D.math.vec3.scale(g,g,l),XML3D.math.vec3.add(h,h,g))}XML3D.math.vec3.normalize(h,h);b[k]=h[0];b[k+1]=h[1];b[k+2]=h[2]}},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.skinPosition",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"pos"},{type:"int4",source:"boneIdx"},{type:"float4",source:"boneWeight"},{type:"float4x4",source:"boneXform",array:!0}],evaluate:function(b,a,f,d,e,c){for(var h=XML3D.math.vec3.create(),g=XML3D.math.vec3.create(),i=0;i<c.iterateCount;++i){for(var k=3*i,j=h[0]=h[1]=h[2]=0;4>j;j++){var l=d[c.iterFlag[2]?4*i+j:j];l&&(XML3D.math.mat4.multiplyOffsetVec3(e,16*f[c.iterFlag[1]?4*i+j:j],a,k,
g),XML3D.math.vec3.scale(g,g,l),XML3D.math.vec3.add(h,h,g))}b[k]=h[0];b[k+1]=h[1];b[k+2]=h[2]}},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.forwardKinematics",{outputs:[{type:"float4x4",name:"result",customAlloc:!0}],params:[{type:"int",source:"parent",array:!0},{type:"float4x4",source:"xform",array:!0}],alloc:function(b,a,f){a=Math.min(a.length,f.length/16);b.result=a},evaluate:function(b,a,f){for(var d=b.length/16,e=[],c=0;c<d;){if(!e[c]){var h=a[c];if(0<=h)if(e[h])XML3D.math.mat4.multiplyOffset(b,16*c,f,16*c,b,16*h);else{for(;0<=a[h]&&!e[a[h]];)h=a[h];if(0<=a[h])XML3D.math.mat4.multiplyOffset(b,16*h,f,
16*h,b,16*a[h]);else for(var g=0;16>g;g++)b[16*h+g]=f[16*h+g];e[h]=!0;continue}else for(g=0;16>g;g++)b[16*c+g]=f[16*c+g];e[c]=!0}c++}},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.forwardKinematicsInv",{outputs:[{type:"float4x4",name:"result",customAlloc:!0}],params:[{type:"int",source:"parent",array:!0},{type:"float4x4",source:"xform",array:!0}],alloc:function(b,a,f){a=Math.min(a.length,f.length/16);b.result=a},evaluate:function(b,a,f){for(var d=f.length/16,e=[],c=0;c<d;){if(!e[c]){var h=a[c];if(0<=h)if(e[h])XML3D.math.mat4.multiplyOffset(b,16*c,b,16*h,f,16*c);else{for(;0<=a[h]&&!e[a[h]];)h=a[h];if(0<=a[h])XML3D.math.mat4.multiplyOffset(b,16*
h,b,16*a[h],f,16*h);else for(var g=0;16>g;g++)b[16*h+g]=f[16*h+g];e[h]=!0;continue}else for(g=0;16>g;g++)b[16*c+g]=f[16*c+g];e[c]=!0}c++}}});Xflow.registerOperator("xflow.flipNormal",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value"}],evaluate:function(b,a,f){for(var d=0;d<3*f.iterateCount;d++)b[d]=-a[d]}});
Xflow.registerOperator("xflow.createIGIndex",{outputs:[{type:"float2",name:"texcoord",customAlloc:!0}],params:[{type:"int",source:"vertexCount",optional:!1},{type:"texture",source:"positionTex",optional:!1}],alloc:function(b,a,f){b.texcoord=f.width*f.height},evaluate:function(b,a,f){for(var a=0.5/f.width,d=0.5/f.height,e=0,c=0,h=f.height;c<h;c++)for(var g=0,i=f.width;g<i;g++)b[e++]=g/i+a,b[e++]=1-(c/h+d);return!0}});
XML3D.math.vec3.reciprocal=function(b,a){a||(a=b);a[0]=1/b[0];a[1]=1/b[1];a[2]=1/b[2];return a};XML3D.math.mat4.multiplyOffsetVec3=function(b,a,f,d,e){e||(e=f);d||(d=0);var c=f[d+0],h=f[d+1],f=f[d+2];e[0]=b[a+0]*c+b[a+4]*h+b[a+8]*f+b[a+12];e[1]=b[a+1]*c+b[a+5]*h+b[a+9]*f+b[a+13];e[2]=b[a+2]*c+b[a+6]*h+b[a+10]*f+b[a+14];return e};
XML3D.math.mat4.multiplyOffsetDirection=function(b,a,f,d,e){e||(e=f);d||(d=0);var c=f[d+0],h=f[d+1],f=f[d+2];e[0]=b[a+0]*c+b[a+4]*h+b[a+8]*f;e[1]=b[a+1]*c+b[a+5]*h+b[a+9]*f;e[2]=b[a+2]*c+b[a+6]*h+b[a+10]*f;return e};var IDENT_MAT=XML3D.math.mat4.identity(XML3D.math.mat4.create()),TMP_MATRIX=XML3D.math.mat4.create(),TMP_VEC=XML3D.math.vec3.create();
XML3D.math.mat4.makeTransformXflow=function(b,a,f,d,e,c){XML3D.math.mat4.identity(c);b&&XML3D.math.mat4.translate(c,c,b);d&&XML3D.math.mat4.translate(c,c,d);a&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[a[0],a[1],a[2],a[3]],[0,0,0]),XML3D.math.mat4.multiply(c,c,TMP_MATRIX));e&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[e[0],e[1],e[2],e[3]],[0,0,0]),XML3D.math.mat4.multiply(c,c,TMP_MATRIX));f&&XML3D.math.mat4.scale(c,c,f);e&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[e[0],
e[1],e[2],-e[3]],[0,0,0]),XML3D.math.mat4.multiply(c,c,TMP_MATRIX));d&&XML3D.math.mat4.translate(c,c,XML3D.math.vec3.negate(TMP_VEC,d))};
XML3D.math.mat4.makeTransformInvXflow=function(b,a,f,d,e,c){XML3D.math.mat4.identity(c);d&&XML3D.math.mat4.translate(c,c,d);e&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[e[0],e[1],e[2],e[3]],[0,0,0]),XML3D.math.mat4.multiply(c,c,TMP_MATRIX));f&&XML3D.math.mat4.scale(c,c,XML3D.math.vec3.reciprocal(f,TMP_VEC));e&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[e[0],e[1],e[2],-e[3]],[0,0,0]),XML3D.math.mat4.multiply(c,c,TMP_MATRIX));a&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,
[a[0],a[1],a[2],-a[3]],[0,0,0]),XML3D.math.mat4.multiply(c,c,TMP_MATRIX));d&&XML3D.math.mat4.translate(c,c,XML3D.math.vec3.negate(TMP_VEC,d));b&&XML3D.math.mat4.translate(c,c,XML3D.math.vec3.negate(TMP_VEC,b))};
XML3D.math.mat4.multiplyOffset=function(b,a,f,d,e,c){var h=e[c+0],g=e[c+1],i=e[c+2],k=e[c+3],j=e[c+4],l=e[c+5],m=e[c+6],x=e[c+7],w=e[c+8],o=e[c+9],q=e[c+10],s=e[c+11],n=e[c+12],p=e[c+13],r=e[c+14],e=e[c+15],c=f[d+0],v=f[d+1],t=f[d+2],u=f[d+3],y=f[d+4],z=f[d+5],A=f[d+6],B=f[d+7],E=f[d+8],C=f[d+9],D=f[d+10],G=f[d+11],H=f[d+12],I=f[d+13],J=f[d+14],f=f[d+15];b[a+0]=c*h+v*j+t*w+u*n;b[a+1]=c*g+v*l+t*o+u*p;b[a+2]=c*i+v*m+t*q+u*r;b[a+3]=c*k+v*x+t*s+u*e;b[a+4]=y*h+z*j+A*w+B*n;b[a+5]=y*g+z*l+A*o+B*p;b[a+6]=
y*i+z*m+A*q+B*r;b[a+7]=y*k+z*x+A*s+B*e;b[a+8]=E*h+C*j+D*w+G*n;b[a+9]=E*g+C*l+D*o+G*p;b[a+10]=E*i+C*m+D*q+G*r;b[a+11]=E*k+C*x+D*s+G*e;b[a+12]=H*h+I*j+J*w+f*n;b[a+13]=H*g+I*l+J*o+f*p;b[a+14]=H*i+I*m+J*q+f*r;b[a+15]=H*k+I*x+J*s+f*e};
XML3D.math.quat.slerpOffset=function(b,a,f,d,e,c,h,g){c||(c=b);var i=a+1,k=a+2,j=a+3,l=d+1,m=d+2,x=d+3,w=h+1,o=h+2,q=h+3,s=b[a]*f[d]+b[i]*f[l]+b[k]*f[m]+b[j]*f[x],n;if(0.01>1-Math.abs(s))n=1-e;else{var p=Math.acos(Math.abs(s)),r=Math.sin(p);n=Math.sin(p*(1-e))/r;e=Math.sin(p*e)/r}g&&0>s&&(n=-n);c[h]=n*b[a]+e*f[d];c[w]=n*b[i]+e*f[l];c[o]=n*b[k]+e*f[m];c[q]=n*b[j]+e*f[x]};
Xflow.registerOperator("xflow.noiseImage",{outputs:[{type:"texture",name:"image",customAlloc:!0}],params:[{type:"int",source:"width"},{type:"int",source:"height"},{type:"float2",source:"scale"},{type:"float",source:"minFreq"},{type:"float",source:"maxFreq"}],alloc:function(b,a,f){var d=new Xflow.SamplerConfig;d.setDefaults();b.image={imageFormat:{width:a[0],height:f[0]},samplerConfig:d}},evaluate:function(b,a,f,d,e,c){for(var a=a[0],f=f[0],e=e[0],c=c[0],b=b.data,h=this.noise=this.noise||new SimplexNoise,
g=0!=e&&0!=c&&e<c,i=0;i<f;++i)for(var k=i/f*d[1],j=1/a,l=0;l<a;++l){var m=l*j*d[0],x;if(g){x=c;for(var w=k,o=0,q=e;q<x;q*=2)o+=Math.abs(h.noise(m*q,w*q))/q;x=o}else x=h.noise(m,k);m=4*(l*a+i);b[m]=Math.floor(255*x);b[m+1]=Math.floor(255*x);b[m+2]=Math.floor(255*x);b[m+3]=255}return!0}});
(function(){Xflow.Filters={};var b=null,a=null;Xflow.Filters.createImageData=function(f,d){b||(b=document.createElement("canvas"));a||(a=b.getContext("2d"));return a.createImageData(f,d)};Xflow.Filters.createImageDataFloat32=function(a,d){return{width:a,height:d,data:new Float32Array(4*a*d)}};Xflow.Filters.grayscale=function(a,d){for(var b=a.data,c=d.data,h=0;h<b.length;h+=4){var g=b[h+3];c[h]=c[h+1]=c[h+2]=0.2126*b[h]+0.7152*b[h+1]+0.0722*b[h+2];c[h+3]=g}return a};Xflow.Filters.convolute=function(a,
d,b,c){for(var h=Math.round(Math.sqrt(b.length)),g=Math.floor(h/2),i=a.data,k=a.width,a=a.height,j=d.data,c=c?1:0,l=0;l<a;l++)for(var m=0;m<k;m++){for(var x=l,w=m,o=4*(l*k+m),q=0,s=0,n=0,p=0,r=0;r<h;r++)for(var v=0;v<h;v++){var t=x+r-g,u=w+v-g;0<=t&&t<a&&0<=u&&u<k&&(t=4*(t*k+u),u=b[r*h+v],q+=i[t]*u,s+=i[t+1]*u,n+=i[t+2]*u,p+=i[t+3]*u)}j[o]=q;j[o+1]=s;j[o+2]=n;j[o+3]=p+c*(255-p)}return d}})();
function float4(b,a,f,d){var e=new Float32Array(4);switch(arguments.length){case 0:e[0]=0;e[1]=0;e[2]=0;e[3]=0;break;case 1:e[0]=b;e[1]=b;e[2]=b;e[3]=b;break;case 2:e[0]=b;e[1]=a;e[2]=0;e[3]=0;break;case 3:e[0]=b;e[1]=a;e[2]=f;e[3]=0;break;default:e[0]=b,e[1]=a,e[2]=f,e[3]=d}return e}function hypot(b,a){return Math.sqrt(b*b+a*a)}function hypot4(b,a){return float4(hypot(b[0],a[0]),hypot(b[1],a[1]),hypot(b[2],a[2]),hypot(b[3],a[3]))}
function hypot4To(b,a,f){b[0]=hypot(a[0],f[0]);b[1]=hypot(a[1],f[1]);b[2]=hypot(a[2],f[2]);b[3]=hypot(a[3],f[3])}function getTexel2D(b,a,f){a=4*(f*b.width+a);b=b.data;f=new Float32Array(4);f[0]=b[a]/255;f[1]=b[a+1]/255;f[2]=b[a+2]/255;f[3]=b[a+3]/255;return f}function getTexel2DTo(b,a,f,d){f=4*(d*a.width+f);a=a.data;b[0]=a[f]/255;b[1]=a[f+1]/255;b[2]=a[f+2]/255;b[3]=a[f+3]/255;return b}
function setTexel2D(b,a,f,d){a=4*(f*b.width+a);b=b.data;b[a]=255*d[0];b[a+1]=255*d[1];b[a+2]=255*d[2];b[a+3]=255*d[3]}
Xflow.registerOperator("xflow.sobelImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(b,a){for(var f=a.width,d=a.height,e=float4(0),c=float4(0),h=float4(),h=float4(),g=float4(),i=float4(),k=float4(),j=float4(),l=float4(),m=float4(),x=float4(),w=float4(),o=float4(),q=0;q<d;++q)for(var s=0;s<f;++s)1<=s&&s<f-1&&1<=q&&q<d-1&&(getTexel2DTo(h,a,s-1,q-1),getTexel2DTo(g,a,s,q-1),getTexel2DTo(i,a,s+1,q-1),getTexel2DTo(k,a,s-1,q),getTexel2DTo(j,
a,s,q),getTexel2DTo(l,a,s+1,q),getTexel2DTo(m,a,s-1,q+1),getTexel2DTo(x,a,s,q+1),getTexel2DTo(w,a,s+1,q+1),e[0]=h[0]+2*g[0]+i[0]-m[0]-2*x[0]-w[0],e[1]=h[1]+2*g[1]+i[1]-m[1]-2*x[1]-w[1],e[2]=h[2]+2*g[2]+i[2]-m[2]-2*x[2]-w[2],c[0]=h[0]-i[0]+2*k[0]-2*l[0]+m[0]-w[0],c[1]=h[1]-i[1]+2*k[1]-2*l[1]+m[1]-w[1],c[2]=h[2]-i[2]+2*k[2]-2*l[2]+m[2]-w[2],hypot4To(o,e,c),o[0]/=2,o[1]/=2,o[2]/=2,o[3]=1,setTexel2D(b,s,q,o));return!0}});
Xflow.registerOperator("xflow.grayscaleImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(b,a){for(var f=a.data,d=b.data,e=0;e<f.length;e+=4){var c=f[e+3];d[e]=d[e+1]=d[e+2]=0.2126*f[e]+0.7152*f[e+1]+0.0722*f[e+2];d[e+3]=c}return!0}});
Xflow.registerOperator("xflow.sepiaImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(b,a){for(var f=a.data,d=b.data,e=0,c=0,h=0,g=0;g<f.length;g+=4)e=0.393*f[g]+0.769*f[g+1]+0.189*f[g+2],c=0.349*f[g]+0.686*f[g+1]+0.168*f[g+2],h=0.272*f[g]+0.534*f[g+1]+0.131*f[g+2],255<e&&(e=255),255<c&&(c=255),255<h&&(h=255),0>e&&(e=0),0>c&&(c=0),0>h&&(h=0),d[g]=e,d[g+1]=c,d[g+2]=h,d[g+3]=255;return!0},evaluate_parallel:function(b,a){var f=b[0],
d=b[1],e=0.393*a[f][d][0]+0.769*a[f][d][1]+0.189*a[f][d][2],c=0.349*a[f][d][0]+0.686*a[f][d][1]+0.168*a[f][d][2],f=0.272*a[f][d][0]+0.534*a[f][d][1]+0.131*a[f][d][2];255<e&&(e=255);255<c&&(c=255);255<f&&(f=255);0>e&&(e=0);0>c&&(c=0);0>f&&(f=0);return[e,c,f,255]}});
Xflow.registerOperator("xflow.clampImage",{outputs:[{type:"texture",name:"result",sizeof:"image",formatType:"ImageData"}],params:[{type:"texture",source:"image"},{type:"float",source:"min"},{type:"float",source:"max"}],evaluate:function(b,a,f,d){for(var e=a.data,b=b.data,f=f[0],d=d[0],a=a.data.length,c=0;c<a;c++){var h=e[c];h<f&&(h=f);h>d&&(h=d);b[c]=h}return!0}});
(function(){function b(a,b,d,e){for(var c=Math.round(Math.sqrt(d.length)),h=Math.floor(c/2),g=a.data,i=a.width,a=a.height,k=b.data,e=e?1:0,j=0;j<a;j++)for(var l=0;l<i;l++){for(var m=j,x=l,w=4*(j*i+l),o=0,q=0,s=0,n=0,p=0;p<c;p++)for(var r=0;r<c;r++){var v=m+p-h,t=x+r-h;0<=v&&v<a&&0<=t&&t<i&&(v=4*(v*i+t),t=d[p*c+r],o+=g[v]*t,q+=g[v+1]*t,s+=g[v+2]*t,n+=g[v+3]*t)}k[w]=o;k[w+1]=q;k[w+2]=s;k[w+3]=n+e*(255-n)}return b}Xflow.registerOperator("xflow.convoluteImage",{outputs:[{type:"texture",name:"result",
sizeof:"image"}],params:[{type:"texture",source:"image"},{type:"float",source:"kernel"}],evaluate:function(a,f,d){b(f,a,d,!0);return!0}});Xflow.registerOperator("xflow.convoluteImageToFloat",{outputs:[{type:"texture",name:"result",sizeof:"image",formatType:"float32"}],params:[{type:"texture",source:"image"},{type:"float",source:"kernel"}],evaluate:function(a,f,d){b(f,a,d,!0);return!0}})})();
Xflow.registerOperator("xflow.funMirrorImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"},{type:"float",source:"time"}],evaluate:function(b,a,f){for(var d=b.width,e=b.height,f=f[0],a=a.data,b=b.data,c=0;c<e;++c)for(var h=0;h<d;++h){var g=h/d,i=c/e,g=2*g-1,k=2*i-1,i=Math.sqrt(g*g+k*k),k=Math.atan2(k,g),i=Math.pow(i,1/1.8)*f,g=i*Math.cos(k),k=i*Math.sin(k),g=g/2+0.5,i=k/2+0.5,g=Math.round(g*d),g=4*(Math.round(i*e)*d+g),i=a[g],k=a[g+1],j=a[g+2],l=
a[g+3],g=4*(c*d+h);b[g]=i;b[g+1]=k;b[g+2]=j;b[g+3]=l}return!0}});Xflow.registerOperator("xflow.popartImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"},{type:"float",source:"time"}],evaluate:function(b,a){for(var f=a.data,d=b.data,e=0;e<f.length;e+=4){var c=0.3*(f[e]/255)+0.59*(f[e+1]/255)+0.11*(f[e+2]/255),c=0.3>c?0:0.6>c?0.5:1;0.5==c?(d[e]=204,d[e+1]=0):1==c?(d[e]=229.5,d[e+1]=229.5):(d[e]=0,d[e+1]=0);d[e+2]=0;d[e+3]=f[e+3]}return!0}});
Xflow.registerOperator("xflow.magnitudeImage",{outputs:[{type:"texture",name:"result",sizeof:"image1"}],params:[{type:"texture",source:"image1"},{type:"texture",source:"image2"}],evaluate:function(b,a,f){for(var a=a.data,f=f.data,b=b.data,d=a.length,e=0;e<d;e+=1){var c=a[e],h=f[e];b[e]=Math.sqrt(c*c+h*h)}return!0}});
Xflow.registerOperator("xflow.flipVerticalImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(b,a){for(var f=a.width,d=a.height,e=b.data,c=a.data,h=0;h<d;++h)for(var g=0;g<f;++g){var i=h*f,k=4*(i+g),i=4*(i+(f-1-g));e[i]=c[k];e[i+1]=c[k+1];e[i+2]=c[k+2];e[i+3]=c[k+3]}return!0}});
Xflow.registerOperator("xflow.selectTransform",{outputs:[{type:"float4x4",name:"result",customAlloc:!0}],params:[{type:"int",source:"index"},{type:"float4x4",source:"transform"}],alloc:function(b){b.result=1},evaluate:function(b,a,f){a=16*a[0];a<f.length&&a+15<f.length?(b[0]=f[a+0],b[1]=f[a+1],b[2]=f[a+2],b[3]=f[a+3],b[4]=f[a+4],b[5]=f[a+5],b[6]=f[a+6],b[7]=f[a+7],b[8]=f[a+8],b[9]=f[a+9],b[10]=f[a+10],b[11]=f[a+11],b[12]=f[a+12],b[13]=f[a+13],b[14]=f[a+14],b[15]=f[a+15]):(b[0]=1,b[1]=0,b[2]=0,b[3]=
0,b[4]=0,b[5]=1,b[6]=0,b[7]=0,b[8]=0,b[9]=0,b[10]=1,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1)}});Xflow.registerOperator("xflow.selectBool",{outputs:[{type:"bool",name:"result",customAlloc:!0}],params:[{type:"int",source:"index"},{type:"bool",source:"value"}],alloc:function(b){b.result=1},evaluate:function(b,a,f){a=a[0];b[0]=a<f.length?f[a]:!1}});XML3D.data={toString:function(){return"data"}};XML3D.data=XML3D.data||{};
(function(){function b(a){var b=!1,d=a.getAdapterHandle(a.node.getAttribute("src"));d&&d.status==XML3D.base.AdapterHandle.STATUS.LOADING&&(b=!0);(d=a.getAdapterHandle(a.node.getAttribute("proto")))&&d.status==XML3D.base.AdapterHandle.STATUS.LOADING&&(b=!0);a.xflowDataNode.loading=b}XML3D.data.xflowGraph=new Xflow.Graph;XML3D.data.DataAdapter=function(a,b){XML3D.base.NodeAdapter.call(this,a,b);this.handles={};this.xflowDataNode=null};XML3D.createClass(XML3D.data.DataAdapter,XML3D.base.NodeAdapter);
XML3D.data.DataAdapter.prototype.init=function(){this.xflowDataNode=XML3D.data.xflowGraph.createDataNode("proto"==this.node.localName);this.updateHandle("src");this.updateHandle("proto");this.xflowDataNode.setFilter(this.node.getAttribute("filter"));this.xflowDataNode.setCompute(this.node.getAttribute("compute"));for(var a=this.node.firstElementChild;null!==a;a=a.nextElementSibling){var b=this.factory.getAdapter(a);b&&this.xflowDataNode.appendChild(b.getXflowNode())}};XML3D.data.DataAdapter.prototype.getXflowNode=
function(){return this.xflowDataNode};XML3D.data.DataAdapter.prototype.getComputeRequest=function(a,b){return new Xflow.ComputeRequest(this.xflowDataNode,a,b)};XML3D.data.DataAdapter.prototype.getComputeResult=function(a){return this.xflowDataNode._getComputeResult(a)};XML3D.data.DataAdapter.prototype.getOutputNames=function(){return this.xflowDataNode.getOutputNames()};XML3D.data.DataAdapter.prototype.getOutputChannelInfo=function(a){return this.xflowDataNode.getOutputChannelInfo(a)};XML3D.data.DataAdapter.prototype.notifyChanged=
function(a){if(a.type==XML3D.events.ADAPTER_HANDLE_CHANGED)this.connectedAdapterChanged(a.key,a.adapter),a.handleStatus==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find <data> element of url '"+a.url+"' for "+a.key);else if(a.type==XML3D.events.NODE_INSERTED){var b=a.wrapped.target,a=this.factory.getAdapter(b).getXflowNode(),d=null;do b=b.nextSibling;while(b&&!(d=this.factory.getAdapter(b)));d?this.xflowDataNode.insertBefore(a,d.getXflowNode()):this.xflowDataNode.appendChild(a)}else a.type==
XML3D.events.NODE_REMOVED?this.xflowDataNode.removeChild(this.factory.getAdapter(a.wrapped.target).getXflowNode()):a.type==XML3D.events.VALUE_MODIFIED?(a=a.wrapped.attrName,"filter"==a?this.xflowDataNode.setFilter(this.node.getAttribute(a)):"compute"==a?this.xflowDataNode.setCompute(this.node.getAttribute(a)):("src"==a||"proto"==a)&&this.updateHandle(a)):a.type==XML3D.events.THIS_REMOVED&&this.clearAdapterHandles()};XML3D.data.DataAdapter.prototype.updateHandle=function(a){var f=this.getAdapterHandle(this.node.getAttribute(a));
f&&f.status==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find <data> element of url '"+f.url+"' for "+a);this.connectAdapterHandle(a,f);this.connectedAdapterChanged(a,f?f.getAdapter():null);b(this)};XML3D.data.DataAdapter.prototype.connectedAdapterChanged=function(a,f){"src"==a&&(this.xflowDataNode.sourceNode=f?f.getXflowNode():null);"proto"==a&&(this.xflowDataNode.protoNode=f?f.getXflowNode():null);b(this)};XML3D.data.DataAdapter.prototype.toString=function(){return"XML3D.data.DataAdapter"}})();
(function(){var b={};b["float"]=Xflow.DATA_TYPE.FLOAT;b["int"]=Xflow.DATA_TYPE.INT;b["byte"]=Xflow.DATA_TYPE.BYTE;b.ubyte=Xflow.DATA_TYPE.UBYTE;b.bool=Xflow.DATA_TYPE.BOOL;b.float2=Xflow.DATA_TYPE.FLOAT2;b.float3=Xflow.DATA_TYPE.FLOAT3;b.float4=Xflow.DATA_TYPE.FLOAT4;b.int4=Xflow.DATA_TYPE.INT4;b.float4x4=Xflow.DATA_TYPE.FLOAT4X4;XML3D.data.BUFFER_TYPE_TABLE=b;var a=function(a,d){XML3D.data.DataAdapter.call(this,a,d);this.xflowInputNode=null};XML3D.createClass(a,XML3D.base.NodeAdapter);a.prototype.init=
function(){var a=new Xflow.BufferEntry(b[this.node.localName],this.node.value);this.xflowInputNode=XML3D.data.xflowGraph.createInputNode();this.xflowInputNode.name=this.node.name;this.xflowInputNode.data=a;this.xflowInputNode.key=this.node.key;this.xflowInputNode.param=this.node.param};a.prototype.getXflowNode=function(){return this.xflowInputNode};a.prototype.notifyChanged=function(a){a.type==XML3D.events.VALUE_MODIFIED&&((a=a.wrapped.attrName)?"name"==a?this.xflowInputNode.name=this.node.name:"key"==
a?this.xflowInputNode.key=this.node.key:"param"==a&&(this.xflowInputNode.param=this.node.param):this.xflowInputNode.data.setValue(this.node.value))};a.prototype.toString=function(){return"XML3D.data.ValueDataAdapter"};XML3D.data.ValueDataAdapter=a})();
(function(){var b=function(a){return"clamp"==a?WebGLRenderingContext.CLAMP_TO_EDGE:"repeat"==a?WebGLRenderingContext.REPEAT:WebGLRenderingContext.CLAMP_TO_EDGE},a=function(a){return"nearest"==a?WebGLRenderingContext.NEAREST:"linear"==a?WebGLRenderingContext.LINEAR:"mipmap_linear"==a?WebGLRenderingContext.LINEAR_MIPMAP_NEAREST:"mipmap_nearest"==a?WebGLRenderingContext.NEAREST_MIPMAP_NEAREST:WebGLRenderingContext.LINEAR},f=function(a,b){XML3D.data.DataAdapter.call(this,a,b)};XML3D.createClass(f,XML3D.base.NodeAdapter);
f.prototype.init=function(){this.xflowInputNode=this.createXflowNode();this.xflowInputNode.data=this.createTextureEntry()};f.prototype.createTextureEntry=function(){var d=this.node,e=new Xflow.TextureEntry(null),c=e.getSamplerConfig();c.wrapS=b(d.wrapS);c.wrapT=b(d.wrapT);c.minFilter=a(d.filterMin);c.magFilter=a(d.filterMin);(d=this.factory.getAdapter(this.node.firstElementChild,XML3D.data.XML3DDataAdapterFactory.prototype))&&d.setTextureEntry(e);return e};f.prototype.createXflowNode=function(){var a=
XML3D.data.xflowGraph.createInputNode();a.name=this.node.name;return a};f.prototype.getOutputs=function(){var a={};a[this.node.name]=this;return a};f.prototype.getValue=function(){return this.value};f.prototype.getXflowNode=function(){return this.xflowInputNode};f.prototype.toString=function(){return"XML3D.data.TextureDataAdapter"};XML3D.data.TextureDataAdapter=f})();
(function(){var b=function(a,b){XML3D.data.DataAdapter.call(this,a,b)};XML3D.createClass(b,XML3D.data.DataAdapter);b.prototype.isSinkAdapter=function(){return!0};b.prototype.toString=function(){return"XML3D.data.SinkDataAdapter"};XML3D.data.SinkDataAdapter=b;b=function(a,b){XML3D.base.NodeAdapter.call(this,a,b);this.image=this.textureEntry=null;b.src&&this.createImageFromURL(b.src)};XML3D.createClass(b,XML3D.base.NodeAdapter);b.prototype.createImageFromURL=function(a){var b=this,a=(new XML3D.URI(a)).getAbsoluteURI(this.node.ownerDocument.documentURI);
this.image=XML3D.base.resourceManager.getImage(a,function(a,d){b.textureEntry&&b.textureEntry.setImage(d)},function(a,b){XML3D.debug.logError("Could not load image URI="+b.src)})};b.prototype.setTextureEntry=function(a){this.textureEntry=a;this.image&&this.textureEntry.setImage(this.image)};b.prototype.notifyChanged=function(a){a.type==XML3D.events.VALUE_MODIFIED&&"src"==a.wrapped.attrName&&this.createImageFromURL(this.node.src)};b.prototype.getValue=function(){return this.image};b.prototype.getOutputs=
function(){return{image:this}};b.prototype.resolveScript=function(){return null};var a=function(a,b){XML3D.data.DataAdapter.call(this,a,b);this.video=this.textureEntry=null;this._ticking=!1;this._boundTick=this._tick.bind(this);b.src&&this.createVideoFromURL(b.src)};XML3D.createClass(a,XML3D.base.NodeAdapter);a.prototype.createVideoFromURL=function(a){var b=this,a=(new XML3D.URI(a)).getAbsoluteURI(this.node.ownerDocument.documentURI);this.video=XML3D.base.resourceManager.getVideo(a,this.node.autoplay,
{canplay:function(){XML3D.util.dispatchCustomEvent(b.node,"canplay",!0,!0,null);b._startVideoRefresh()},ended:function(){XML3D.util.dispatchCustomEvent(b.node,"ended",!0,!0,null)},load:function(){XML3D.util.dispatchEvent(b.node,"load")},error:function(a,d){XML3D.util.dispatchCustomEvent(b.node,"error",!0,!0,null);XML3D.debug.logError("Could not load video URI="+d.src)}});this.textureEntry&&this.textureEntry.setImage(this.video)};a.prototype.play=function(){this.video&&this.video.play()};a.prototype.pause=
function(){this.video&&this.video.pause()};a.prototype._startVideoRefresh=function(){this._ticking||this._tick()};a.prototype._tick=function(){this._ticking=!0;window.requestAnimFrame(this._boundTick,XML3D.webgl.MAXFPS);this.textureEntry&&this.textureEntry.setImage(this.video)};a.prototype.setTextureEntry=function(a){this.textureEntry=a;this.video&&this.textureEntry.setImage(this.video)};a.prototype.notifyChanged=function(a){a.type==XML3D.events.VALUE_MODIFIED&&"src"==a.wrapped.attrName&&this.createVideoFromURL(this.node.src)};
a.prototype.getValue=function(){return this.video};a.prototype.getOutputs=function(){return{video:this}};var f=function(a,b){XML3D.base.NodeAdapter.call(this,a,b);this.image=this.textureEntry=null;this.createImageFromIFrame(b)};XML3D.createClass(f,XML3D.base.NodeAdapter);f.prototype.createImageFromIFrame=function(a){var b=document.createElement("canvas");b.width=a.getAttribute("width");b.height=a.getAttribute("height");b.complete=!1;document.body.appendChild(b);var c=document.createElement("iframe");
c.id="newIFrame";c.setAttribute("scrolling","no");c.width=a.getAttribute("width");c.height=a.getAttribute("height");c.style.position="absolute";c.style.left=-c.width-8+"px";document.body.appendChild(c);c.addEventListener("load",function(){var a={_iframe:c,_canvas:b},d=document.createEvent("CustomEvent");d.initCustomEvent("XML3D_XML3DINIT",!0,!1,a);document.dispatchEvent(d);a._canvas.complete=!0;f.textureEntry&&f.textureEntry.setImage(b)},!0);c.src=a.src;var f=this;this.image=b};f.prototype.setTextureEntry=
function(a){this.textureEntry=a;this.image&&this.textureEntry.setImage(this.image)};XML3D.data.IFrameDataAdapter=f;XML3D.data.ImgDataAdapter=b;XML3D.data.VideoDataAdapter=a})();
(function(){var b=function(){XML3D.base.NodeAdapterFactory.call(this,XML3D.data)};XML3D.createClass(b,XML3D.base.NodeAdapterFactory);var a=XML3D.data,f={};f.mesh=a.SinkDataAdapter;f.shader=a.SinkDataAdapter;f.lightshader=a.SinkDataAdapter;f["float"]=a.ValueDataAdapter;f.float2=a.ValueDataAdapter;f.float3=a.ValueDataAdapter;f.float4=a.ValueDataAdapter;f.float4x4=a.ValueDataAdapter;f["int"]=a.ValueDataAdapter;f.int4=a.ValueDataAdapter;f.bool=a.ValueDataAdapter;f["byte"]=a.ValueDataAdapter;f.ubyte=a.ValueDataAdapter;
f.img=a.ImgDataAdapter;f.texture=a.TextureDataAdapter;f.data=a.DataAdapter;f.proto=a.DataAdapter;f.iframe=a.IFrameDataAdapter;f.video=a.VideoDataAdapter;b.prototype.createAdapter=function(a){var b=f[a.localName];if(void 0!==b)return new b(this,a);XML3D.debug.logWarning("Not supported as data element: "+a.localName);return null};XML3D.data.XML3DDataAdapterFactory=b;XML3D.data.factory=new b})();
(function(){function b(a,c,b,d,e){e=new f[c](e);c=new Xflow.BufferEntry(XML3D.data.BUFFER_TYPE_TABLE[c],e);e=XML3D.data.xflowGraph.createInputNode();e.data=c;e.name=b;e.key=d;a.appendChild(e)}function a(a,c,e){if(f[e.type])for(var k=0;k<e.seq.length;++k){var j=e.seq[k],l=j.value,m=j.key;if("Object"===Object.prototype.toString.call(l).slice(8,-1)&&l.url){if(!d())throw Error("Big-endian binary data are not supported yet");XML3D.base.resourceManager.loadData(l.url,function(b){var d=e.type,k=m,j=f[d],
b=new j(b,l.byteOffset,l.byteLength/j.BYTES_PER_ELEMENT),d=new Xflow.BufferEntry(XML3D.data.BUFFER_TYPE_TABLE[d],b),b=XML3D.data.xflowGraph.createInputNode();b.data=d;b.name=c;b.key=k;a.appendChild(b)},null)}else b(a,e.type,c,m,l)}}var f={"int":Int32Array,int4:Int32Array,"float":Float32Array,float2:Float32Array,float3:Float32Array,float4:Float32Array,float4x4:Float32Array,bool:Uint8Array,"byte":Int8Array,ubyte:Uint8Array},d=function(){var a=new ArrayBuffer(4),c=new DataView(a);(new Int32Array(a))[0]=
16909060;var b=16909060===c.getInt32(0,!0);return function(){return b}}(),e=function(c){this.json=c;try{if("xml3d-json"!=c.format)throw Error("Unknown JSON format: "+c.format);if("0.4.0"!=c.version)throw Error("Unknown JSON version: "+c.version);var b=XML3D.data.xflowGraph.createDataNode(),d=c.data,e;for(e in d)a(b,e,d[e]);this.xflowDataNode=b}catch(f){XML3D.debug.logException(f,"Failed to process XML3D json file")}};e.prototype.getXflowNode=function(){return this.xflowDataNode};var c=function(){XML3D.base.AdapterFactory.call(this,
XML3D.data,"application/json")};XML3D.createClass(c,XML3D.base.AdapterFactory);c.prototype.createAdapter=function(a){return new e(a)};new c})();
(function(){var b={"int":Int32Array,int4:Int32Array,"float":Float32Array,float2:Float32Array,float3:Float32Array,float4:Float32Array,float4x4:Float32Array,bool:Uint8Array,"byte":Int8Array,ubyte:Uint8Array},a=function(a){this.data=a;try{if(!a instanceof ArrayBuffer&&!a instanceof ArrayBufferView)throw Error("Unknown binary type: "+typeof a);var e=XML3D.data.xflowGraph.createDataNode(),c="ubyte",f=null;if(b[c]){var f=new b[c](a),c=XML3D.data.BUFFER_TYPE_TABLE[c],g=new Xflow.BufferEntry(c,f),i=XML3D.data.xflowGraph.createInputNode();
i.data=g;i.name="data";e.appendChild(i)}this.xflowDataNode=e}catch(k){XML3D.debug.logException(k,"Failed to process binary file")}};a.prototype.getXflowNode=function(){return this.xflowDataNode};var f=function(){XML3D.base.AdapterFactory.call(this,XML3D.data,["application/octet-stream","text/plain; charset=x-user-defined"])};XML3D.createClass(f,XML3D.base.AdapterFactory);f.prototype.createAdapter=function(b){return new a(b)};new f})();XML3D.webgl={toString:function(){return"webgl"}};XML3D.webgl.DataChangeListener=function(b){this.requestRedraw=b.requestRedraw;Xflow.DataChangeNotifier.addListener(this.dataEntryChanged)};XML3D.webgl.DataChangeListener.prototype.dataEntryChanged=function(b,a){if(b.userData.webglData)for(var f in b.userData.webglData)b.userData.webglData[f].changed=a};
XML3D.webgl.getXflowEntryWebGlData=function(b,a){if(!b)return null;b.userData.webglData||(b.userData.webglData={});b.userData.webglData[a]||(b.userData.webglData[a]={changed:Xflow.DATA_ENTRY_STATE.CHANGED_NEW});return b.userData.webglData[a]};XML3D.webgl.MAXFPS=30;
(function(){function b(a,b){this.canvas=a;this.xml3dElem=b;this.id=++f;this.needPickingDraw=this.needDraw=!0;this._pickingDisabled=!1;this.lastPickObj=this.currentPickObj=null;this.timeNow=Date.now()/1E3;this.lastKnownDimensions={width:a.width,height:a.height};var c=this.getContextForCanvas(a);c&&this.initialize(c)}var a=document.createElement("canvas");XML3D.webgl.supported=function(){try{return!(!window.WebGLRenderingContext||!a.getContext("experimental-webgl"))}catch(b){return!1}};XML3D.webgl.configure=
function(a){for(var b in a){var c=XML3D.webgl.createCanvas(a[b],b);(new XML3D.webgl.CanvasHandler(c,a[b])).tick()}};var f=0;b.prototype.getContextForCanvas=function(a){try{return a.getContext("experimental-webgl",{preserveDrawingBuffer:!0})}catch(b){return null}};b.prototype.initialize=function(a){this.registerCanvasListeners();var b=this;this.tick=function(){XML3D.updateXflowObserver();if(b.canvasSizeChanged()||b.needDraw)b.dispatchUpdateEvent(),b.draw();window.requestAnimFrame(b.tick,XML3D.webgl.MAXFPS)};
this.redraw=function(a,d){void 0!==this.needDraw?(this.needDraw=!0,this.needPickingDraw=this.needPickingDraw||(void 0===d?!0:d)):b.needDraw=!0};this.renderer=new XML3D.webgl.Renderer(this,a,{width:this.canvas.clientWidth,height:this.canvas.clientHeight})};b.prototype.registerCanvasListeners=function(){var a=this,b=this.canvas;b.addEventListener("mousedown",function(c){a.mousedown(c)},!1);b.addEventListener("mouseup",function(c){a.mouseup(c)},!1);b.addEventListener("mousemove",function(c){a.mousemove(c)},
!1);b.addEventListener("click",function(c){a.click(c)},!1);b.addEventListener("dblclick",function(c){a.click(c,!0)},!1);b.addEventListener("mousewheel",function(c){a.mousewheel(c)},!1);b.addEventListener("DOMMouseScroll",function(c){a.mousewheel(c)},!1);b.addEventListener("mouseout",function(c){a.mouseout(c)},!1);b.addEventListener("drop",function(c){a.drop(c)},!1);b.addEventListener("dragover",function(c){a.dragover(c)},!1);b=this.xml3dElem.getAttribute("contextmenu");(!b||"false"==b)&&this.canvas.addEventListener("contextmenu",
function(a){XML3D.webgl.stopEvent(a)},!1)};b.prototype.canvasToGlY=function(a){return this.canvas.height-a-1};b.prototype.updatePickObjectByPoint=function(a,b){if(this._pickingDisabled)return null;this.needPickingDraw&&(this.renderer.prepareRendering(),this.renderer.renderSceneToPickingBuffer());this.needDraw||(this.needPickingDraw=!1);var c=this.canvasToGlY(b);return this.currentPickObj=this.renderer.getRenderObjectFromPickingBuffer(a,c)};b.prototype.getWorldSpaceNormalByPoint=function(a,b,c){if(!a||
this._pickingDisabled)return null;c=this.canvasToGlY(c);this.renderer.renderPickedNormals(a);return this.renderer.readNormalFromPickingBuffer(b,c)};b.prototype.getWorldSpacePositionByPoint=function(a,b,c){if(!a)return null;c=this.canvasToGlY(c);this.renderer.renderPickedPosition(a);return this.renderer.readPositionFromPickingBuffer(b,c)};b.prototype.getCanvasHeight=function(){return this.canvas.height};b.prototype.getCanvasWidth=function(){return this.canvas.width};b.prototype.canvasSizeChanged=function(){var a=
this.canvas.getBoundingClientRect();return a.width!==this.lastKnownDimensions.width||a.height!==this.lastKnownDimensions.height?(this.renderer.resizeCanvas(a.width,a.height),this.lastKnownDimensions.width=this.canvas.width=a.width,this.lastKnownDimensions.height=this.canvas.height=a.height,this.needDraw=this.needPickingDraw=!0):!1};b.prototype.generateRay=function(a,b){var c=this.canvasToGlY(b),f=[0,0];f[2]=this.renderer.width;f[3]=this.renderer.height;var g=this.renderer.camera.viewMatrix,i=this.renderer.camera.getProjectionMatrix(f[2]/
f[3]),k=new window.XML3DRay,j=[],l=[];if(!1===GLU.unProject(a,c,0,g,i,f,j)||!1===GLU.unProject(a,c,1,g,i,f,l))return k;c=this.renderer.currentView.getViewMatrix().inverse();c=new window.XML3DVec3(c.m41,c.m42,c.m43);k.origin.set(c);k.direction.set(l[0]-j[0],l[1]-j[1],l[2]-j[2]);k.direction.set(k.direction.normalize());return k};b.prototype.dispatchUpdateEvent=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("update",!0,!0,null);this.xml3dElem.dispatchEvent(a)};b.prototype.draw=
function(){try{var a=Date.now();this.renderer.prepareRendering();var b=this.renderer.render(),c=Date.now();this.needDraw=!1;this.dispatchFrameDrawnEvent(a,c,b)}catch(f){XML3D.debug.logException(f)}};b.prototype.dispatchMouseEvent=function(a,b,c,f,g,i){if(null===g||void 0===g)g=document.createEvent("MouseEvents"),g.initMouseEvent(a,!0,!0,window,0,0,0,c,f,!1,!1,!1,!1,b,null);a=this.copyMouseEvent(g);this.initExtendedMouseEvent(a,c,f);c=null;c=void 0!==i&&null!==i?i:this.currentPickObj?this.currentPickObj.meshAdapter.node:
this.xml3dElem;c.dispatchEvent(a)};b.prototype.copyMouseEvent=function(a){var b=document.createEvent("MouseEvents");b.initMouseEvent(a.type,a.bubbles,a.cancelable,a.view,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);a.dataTransfer&&(b.data={url:a.dataTransfer.getData("URL"),text:a.dataTransfer.getData("Text")});return b};b.prototype.initExtendedMouseEvent=function(a,b,c){var f=this;(function(){var g=void 0,i=void 0;a.__defineGetter__("normal",
function(){if(void 0!==i)return i;var a=f.getWorldSpaceNormalByPoint(f.currentPickObj,b,c);return i=a?new window.XML3DVec3(a[0],a[1],a[2]):null});a.__defineGetter__("position",function(){if(!g){var a=f.getWorldSpacePositionByPoint(f.currentPickObj,b,c);g=a?new window.XML3DVec3(a[0],a[1],a[2]):null}return g})})()};b.prototype.drop=function(a){var b=this.getMousePosition(a);this.updatePickObjectByPoint(b.x,b.y);this.dispatchMouseEvent("drop",a.button,b.x,b.y,a);a.preventDefault()};b.prototype.dragover=
function(a){a.preventDefault()};b.prototype.mouseup=function(a){var b=this.getMousePosition(a);this.updatePickObjectByPoint(b.x,b.y);this.dispatchMouseEvent("mouseup",a.button,b.x,b.y,a)};b.prototype.mousedown=function(a){var b=this.getMousePosition(a);this.updatePickObjectByPoint(b.x,b.y);this.dispatchMouseEvent("mousedown",a.button,b.x,b.y,a)};b.prototype.click=function(a,b){var c=this.getMousePosition(a);!0==b?this.dispatchMouseEvent("dblclick",a.button,c.x,c.y,a):this.dispatchMouseEvent("click",
a.button,c.x,c.y,a)};b.prototype.mousemove=function(a){var b=this.getMousePosition(a);this.updatePickObjectByPoint(b.x,b.y);this.dispatchMouseEvent("mousemove",0,b.x,b.y,a);a=this.currentPickObj?this.currentPickObj.meshAdapter.node:null;a!==this.lastPickObj&&(this.lastPickObj&&this.dispatchMouseEvent("mouseout",0,b.x,b.y,null,this.lastPickObj),a&&this.dispatchMouseEvent("mouseover",0,b.x,b.y),this.lastPickObj=a)};b.prototype.mouseout=function(a){a=this.getMousePosition(a);this.dispatchMouseEvent("mouseout",
0,a.x,a.y,null,this.lastPickObj)};b.prototype.mousewheel=function(a){var b=this.getMousePosition(a);this.dispatchMouseEvent("mousewheel",0,b.x,b.y,a,this.xml3dElem)};b.prototype.dispatchFrameDrawnEvent=function(a,b,c){var f=document.createEvent("CustomEvent");f.initCustomEvent("framedrawn",!0,!0,{timeStart:a,timeEnd:b,renderTimeInMilliseconds:b-a,numberOfObjectsDrawn:c[0],numberOfTrianglesDrawn:Math.floor(c[1])});this.xml3dElem.dispatchEvent(f)};b.prototype.shutdown=function(){this.renderer&&this.renderer.dispose()};
b.prototype.getMousePosition=function(a){var b=this.canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}};b.prototype.setMouseMovePicking=function(){};XML3D.webgl.CanvasHandler=b})();
XML3D.webgl.createCanvas=function(b){var a=b.parentNode,f=a.ownerDocument.createElement("div");f.style.display="none";a.insertBefore(f,b);f.appendChild(b);var d=b._configured.canvas;a.insertBefore(d,f);b=d.ownerDocument.defaultView.getComputedStyle(b);if(!d.style.backgroundColor&&(b=b.getPropertyValue("background-color"))&&"transparent"!=b)d.style.backgroundColor=b;d.width=d.clientWidth;d.height=d.clientHeight;return d};
XML3D.webgl.stopEvent=function(b){b.preventDefault&&b.preventDefault();b.stopPropagation&&b.stopPropagation();b.returnValue=!1};
(function(){function b(a,b,c){var f=XML3D.math.vec3.create();f[0]=c(a[0],b[0]);f[1]=c(a[1],b[1]);f[2]=c(a[2],b[2]);return f}XML3D.webgl.checkError=function(a,b){var c=a.getError();if(c!==a.NO_ERROR){var f=""+c;switch(c){case 1280:f="1280 ( GL_INVALID_ENUM )";break;case 1281:f="1281 ( GL_INVALID_VALUE )";break;case 1282:f="1282 ( GL_INVALID_OPERATION )";break;case 1283:f="1283 ( GL_STACK_OVERFLOW )";break;case 1284:f="1284 ( GL_STACK_UNDERFLOW )";break;case 1285:f="1285 ( GL_OUT_OF_MEMORY )"}c="GL error "+
f+" occured.";void 0!==b&&(c+=" "+b);XML3D.debug.trace(c)}};var a=new Float32Array(6);XML3D.webgl.calculateBoundingBox=function(b,e){var c=new window.XML3DBox;if(!b||3>b.length)return c;if(e){var f=3*e[0];a[0]=b[f];a[1]=b[f+1];a[2]=b[f+2];a[3]=b[f];a[4]=b[f+1];a[5]=b[f+2];for(f=1;f<e.length;f++){var g=3*e[f],i=b[g],k=b[g+1],g=b[g+2];i<a[0]&&(a[0]=i);k<a[1]&&(a[1]=k);g<a[2]&&(a[2]=g);i>a[3]&&(a[3]=i);k>a[4]&&(a[4]=k);g>a[5]&&(a[5]=g)}}else{a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[0];a[4]=b[1];a[5]=b[2];
for(f=3;f<b.length;f+=3)b[f]<a[0]&&(a[0]=b[f]),b[f+1]<a[1]&&(a[1]=b[f+1]),b[f+2]<a[2]&&(a[2]=b[f+2]),b[f]>a[3]&&(a[3]=b[f]),b[f+1]>a[4]&&(a[4]=b[f+1]),b[f+2]>a[5]&&(a[5]=b[f+2])}c.min.set(a[0],a[1],a[2]);c.max.set(a[3],a[4],a[5]);return c};var f=XML3D.math.mat4.create();XML3D.webgl.transformAABB=function(a,b){if(!a.isEmpty()){var c=a.min._data,h=a.max._data,g=XML3D.math.vec3.scale(XML3D.math.vec3.create(),XML3D.math.vec3.add(XML3D.math.vec3.create(),c,h),0.5),c=XML3D.math.vec3.scale(XML3D.math.vec3.create(),
XML3D.math.vec3.subtract(XML3D.math.vec3.create(),h,c),0.5);XML3D.math.mat4.copy(f,b);f.set([0,0,0,1],12);for(h=0;16>h;h++)f[h]=Math.abs(f[h]);XML3D.math.vec3.transformMat4(c,c,f);XML3D.math.vec3.transformMat4(g,g,b);XML3D.math.vec3.add(a.max._data,g,c);XML3D.math.vec3.subtract(a.min._data,g,c)}};XML3D.webgl.splitMesh=function(a,b){var b=3*Math.floor(b/3),c=a.position.data,f=a.index?a.index.data:void 0,g=a.normal?a.normal.data:void 0,i=a.texcoord?a.texcoord.data:void 0,k=a.color?a.color.data:void 0,
j=a.position.tupleSize,l=a.texcoord?a.texcoord.tupleSize:void 0,m=f.length;if(f){for(var x=[],w=Math.ceil(m/b),m=[],o=0;o<w;o++)if(m[o]={},m[o].index=new Uint16Array(b),m[o].index.nextFreeSlot=0,m[o].position=new Float32Array(b*j),g&&(m[o].normal=new Float32Array(b*j)),i&&(m[o].texcoord=new Float32Array(b*l)),k)m[o].color=new Float32Array(3*b);for(o=0;o<f.length;o+=3){var q=!0,w=Math.floor(f[o]/b);m[w].index.nextFreeSlot+3>b&&(q=!1);for(s=1;3>s;s++)if(Math.floor(f[o+s]/b)!=w){q=!1;break}if(q)for(var q=
b*w,s=0;3>s;s++){var n=f[o+s],p=n-q,r=m[w];r.index[r.index.nextFreeSlot]=p;r.index.nextFreeSlot++;for(var v=n*j,t=[],u=0;u<j;u++)t[u]=c[v+u];r.position.set(t,p*j);if(g){t=[];for(u=0;u<j;u++)t[u]=g[v+u];r.normal.set(t,p*j)}n*=l;if(i){t=[];for(u=0;u<l;u++)t[u]=i[n+u];r.texcoord.set(t,p*l)}if(k){t=[];for(u=0;3>u;u++)t[u]=k[v+u];r.color.set(t,3*p)}}else x.push(o)}for(o=w=0;o<x.length;o++){for(;m[w].index.nextFreeSlot+3>b;)if(w++,w>=m.length){m[w]={};m[w].index=new Uint16Array(b);m[w].index.nextFreeSlot=
0;m[w].position=new Float32Array(b*j);g&&(m[w].normal=new Float32Array(b*j));i&&(m[w].texcoord=new Float32Array(b*l));k&&(m[w].color=new Float32Array(3*b));break}for(s=0;3>s;s++){r=m[w];n=f[x[o]+s];p=r.index.nextFreeSlot;r.index[p]=p;r.index.nextFreeSlot++;t=[];for(u=0;u<j;u++)t[u]=c[n*j+u];r.position.set(t,p*j);if(g){t=[];for(u=0;u<j;u++)t[u]=g[n*j+u];r.normal.set(t,p*j)}if(i){t=[];for(u=0;u<l;u++)t[u]=i[n*l+u];r.texcoord.set(t,p*l)}if(k){t=[];for(u=0;u<j;u++)t[u]=k[3*n+u];r.color.set(t,3*p)}}}a.index=
[];a.position=[];g&&(a.normal=[]);i&&(a.texcoord=[]);k&&(a.color=[]);for(o=0;o<m.length;o++)0<m[o].index.nextFreeSlot&&(a.index[o]={data:m[o].index,tupleSize:j},a.position[o]={data:m[o].position,tupleSize:j},g&&(a.normal[o]={data:m[o].normal,tupleSize:j}),i&&(a.texcoord[o]={data:m[o].texcoord,tupleSize:l}),k&&(a.color[o]={data:m[o].color,tupleSize:3}))}};XML3D.webgl.adjustMinMax=function(a,e,c,f){var g=XML3D.math.vec3.create(),i=XML3D.math.vec3.create();XML3D.math.vec3.transformMat4(g,a.min._data,
f);XML3D.math.vec3.transformMat4(i,a.max._data,f);a=b(g,i,Math.min);g=b(g,i,Math.max);a[0]<e[0]&&(e[0]=a[0]);a[1]<e[1]&&(e[1]=a[1]);a[2]<e[2]&&(e[2]=a[2]);g[0]>c[0]&&(c[0]=g[0]);g[1]>c[1]&&(c[1]=g[1]);g[2]>c[2]&&(c[2]=g[2])};XML3D.webgl.createEmptyTexture=function(a){var b=a.createTexture();a.bindTexture(a.TEXTURE_2D,b);b=new Uint8Array([255,128,128,255]);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,1,1,0,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_MIN_FILTER,a.NEAREST)};XML3D.webgl.convertPageCoords=function(a,b,c){var f;f=a.getBoundingClientRect();var g=document.body,i=document.documentElement,a=f.left+(window.pageXOffset||i.scrollLeft||g.scrollLeft)-(i.clientLeft||g.clientLeft||0);f=Math.round(f.top+(window.pageYOffset||i.scrollTop||g.scrollTop)-(i.clientTop||g.clientTop||0));a=Math.round(a);return{x:b-a,y:c-f}}})();
(function(){var b=function(a,b){b=b||{};this.handle=a;this.status=b.status||-1;this.onload=b.onload;this.unit=b.unit||0;this.image=b.image||null;this.config=b.config||null;this.canvas=b.canvas||null;this.context=b.context||null};b.prototype.setLoaded=function(){0!=this.status&&XML3D.debug.logError("Trying to set Texture with state "+this.status+" to 'loaded'");this.status=1;this.onload&&this.onload.call(this)};var a=function(){this.status=-1},f=function(a,b){this.attributes={};this.uniforms={};this.samplers=
{};this.handle=a;this.needsLights=!0;this.vSource=b.vertex;this.fSource=b.fragment;var d=0;this.nextTextureUnit=function(){return d++}},d=function(a,b){this.renderer=a;this.gl=a.gl;this.factory=b;this.shaderCache={fragment:{},vertex:{}};this.currentProgram=null;this.shaders={};this.createDefaultShaders()};d.addDirectivesToSource=function(a,b){var d="";Array.forEach(a,function(a){d+="#define "+a+"\n"});return d+"\n"+b};d.prototype.createDefaultShaders=function(){this.createFallbackShader();this.createPickingShader()};
d.prototype.createFallbackShader=function(){var a=this.createMaterialFromShaderDescriptor(XML3D.shaders.getScript("matte")).getProgram();this.bindShader(a);d.setUniform(this.gl,a.uniforms.diffuseColor,[1,0,0]);this.unbindShader(a);this.shaders.defaultShader=a};d.prototype.createPickingShader=function(){this.shaders.pickobjectid=this.getStandardShaderProgram("pickobjectid");this.shaders.pickedposition=this.getStandardShaderProgram("pickedposition");this.shaders.pickedNormals=this.getStandardShaderProgram("pickedNormals")};
d.prototype.createMaterialFromShaderDescriptor=function(a){var b=new Material(this);XML3D.extend(b,a);return b};d.prototype.createShader=function(a,b){if(!a||!a.node.script)return"defaultShader";var e=a.node,f=(new XML3D.URI("#"+e.id)).getAbsoluteURI(e.ownerDocument.documentURI).toString(),k=this.shaders[f];if(k&&!b.structureChanged)return f;var j=new XML3D.URI(e.script);if("urn"!=j.scheme)return"defaultShader";k=this.createMaterialFromShaderDescriptor(d.getShaderDescriptor(j.path));e=a.requestData(k.getRequestFields());
k=k.getProgram(b,e);if(!k)return XML3D.debug.logError("Unknown shader URI: "+j+". Using default shader instead."),"defaultShader";this.shaders[f]=k;this.gl.useProgram(k.handle);j=a.factory.canvasId;this.setUniformsFromComputeResult(k,e,j,{force:!0});this.createTexturesFromComputeResult(k,e,j,{force:!0});return f};d.getShaderDescriptor=function(a){a=a.substring(a.lastIndexOf(":")+1);return XML3D.shaders.getScript(a)};d.prototype.getStandardShaderProgram=function(a){var b={},b=XML3D.shaders.getScript(a);
if(!b||!b.vertex)b={},XML3D.debug.logError("Unknown shader: "+a+". Using flat shader instead.");return this.createProgramFromSources(b)};d.prototype.createProgramFromSources=function(a){var b=this.gl;if(!a.vertex||!a.fragment)return this.shaders.defaultShader;var e=this.shaderCache,i=e.vertex[a.vertex];i||(i=e.vertex[a.vertex]=d.createWebGLShaderFromSource(b,b.VERTEX_SHADER,a.vertex));var k=e.fragment[a.fragment];k||(k=e.fragment[a.fragment]=d.createWebGLShaderFromSource(b,b.FRAGMENT_SHADER,a.fragment));
if(!i||!k)return this.shaders.defaultShader;e=b.createProgram();b.attachShader(e,i);b.attachShader(e,k);b.linkProgram(e);if(0==b.getProgramParameter(e,b.LINK_STATUS))return e="Shader linking failed: \n"+b.getProgramInfoLog(e),XML3D.debug.logError(e+"\n--------\n"),b.getError(),this.shaders.defaultShaders;a=new f(e,a);this.currentProgram=e;b.useProgram(e);k=b.getProgramParameter(e,b.ACTIVE_ATTRIBUTES);for(i=0;i<k;i++){var j=b.getActiveAttrib(e,i);if(j){var l={};l.name=j.name;l.size=j.size;l.glType=
j.type;l.location=b.getAttribLocation(e,j.name);a.attributes[j.name]=l}}k=b.getProgramParameter(e,b.ACTIVE_UNIFORMS);for(i=0;i<k;i++)if(j=b.getActiveUniform(e,i)){l={};l.name=j.name;l.size=j.size;l.glType=j.type;l.location=b.getUniformLocation(e,j.name);var m=l.name;"[0]"==m.substring(m.length-3)&&(m=m.substring(0,m.length-3));j.type==b.SAMPLER_2D||j.type==b.SAMPLER_CUBE?(l.unit=a.nextTextureUnit(),a.samplers[m]=l):a.uniforms[m]=l}a.changes=[];return a};d.createWebGLShaderFromSource=function(a,b,
d){var e=a.createShader(b);a.shaderSource(e,d);a.compileShader(e);return 0==a.getShaderParameter(e,a.COMPILE_STATUS)?(d="",d=b==a.VERTEX_SHADER?"Vertex shader failed to compile: \n":"Fragment shader failed to compile: \n",d+=a.getShaderInfoLog(e)+"\n--------\n",XML3D.debug.logError(d),a.getError(),null):e};d.prototype.resetUniformVariables=function(a,b,e){if(a){var a=a.computeRequest.getResult(),f;for(f in e){var k=e[f],j=a.getOutputData(k);j&&d.setUniform(this.gl,b.uniforms[k],j.getValue())}}};d.prototype.recompileShader=
function(a,b){var d=a.node.id,e=this.shaders[d];e&&(this.destroyShader(e),delete this.shaders[d],this.createShader(a,b))};d.prototype.shaderDataChanged=function(a,b){var d=a.factory.canvasId,e=this.shaders[(new XML3D.URI("#"+a.node.id)).getAbsoluteURI(a.node.ownerDocument.documentURI).toString()];if(e){var f=b.getResult();this.bindShader(e);this.setUniformsFromComputeResult(e,f,d);this.createTexturesFromComputeResult(e,f);e.material&&(e.material.parametersChanged(f.getOutputMap()),e.hasTransparency=
e.material.isTransparent);this.renderer.requestRedraw("Shader data changed")}};d.prototype.getShaderById=function(a){var b=this.shaders[a];if(!b){if(b=this.factory.getAdapter(document.getElementById(a)))if(this.createShader(b,this.renderer.lights),this.shaders[a])return this.shaders[a];XML3D.debug.logError("Could not find the shader [ "+a+" ]");b=this.shaders["default"]}return b};d.prototype.setUniformsFromComputeResult=function(a,b,e,f){var b=b.getOutputMap(),a=a.uniforms,f=f||{},f=f.force||!1,k;
for(k in a){var j=b[k];if(j){var l=XML3D.webgl.getXflowEntryWebGlData(j,e);if(f||l.changed)d.setUniform(this.gl,a[k],j.getValue()),l.changed=0}}};d.prototype.createTexturesFromComputeResult=function(b,d,e,f){var k=0,b=b.samplers,f=f||{},f=f.force||!1,j;for(j in b){var l=b[j],m=d.getOutputData(j);if(m){var x=XML3D.webgl.getXflowEntryWebGlData(m,e);if(f||x.changed)this.createTextureFromEntry(m,l,k),x.changed=0;k++}else l.info=new a}};d.prototype.setUniformVariables=function(a,b){for(var e in b){var f=
b[e];f.value&&(f=f.value);a.uniforms[e]&&d.setUniform(this.gl,a.uniforms[e],f)}};d.prototype.bindShader=function(a){a="string"==typeof a?this.getShaderById(a):a;this.currentProgram!=a.handle&&(this.currentProgram=a.handle,this.gl.useProgram(a.handle));var a=a.samplers,b;for(b in a)this.bindTexture(a[b])};d.prototype.updateActiveShader=function(a){for(var b=0,e=a.changes.length;b<e;b++){var f=a.changes[b];"uniform"==f.type&&a.uniforms[f.name]&&d.setUniform(this.gl,a.uniforms[f.name],f.newValue)}a.changes=
[]};d.prototype.unbindShader=function(a){var a=("string"==typeof a?this.getShaderById(a):a).samplers,b;for(b in a)this.unbindTexture(a[b]);this.currentProgram=null;this.gl.useProgram(null)};var e=window.WebGLRenderingContext;d.setUniform=function(a,b,d,f){switch(b.glType){case e.BOOL:case e.INT:case e.SAMPLER_2D:d.length?a.uniform1i(b.location,d[0]):a.uniform1i(b.location,d);break;case 35671:case 35667:a.uniform2iv(b.location,d);break;case 35672:case 35668:a.uniform3iv(b.location,d);break;case 35673:case 35669:a.uniform4iv(b.location,
d);break;case 5126:null!=d.length?a.uniform1fv(b.location,d):a.uniform1f(b.location,d);break;case 35664:a.uniform2fv(b.location,d);break;case 35665:a.uniform3fv(b.location,d);break;case 35666:a.uniform4fv(b.location,d);break;case 35674:a.uniformMatrix2fv(b.location,f||!1,d);break;case 35675:a.uniformMatrix3fv(b.location,f||!1,d);break;case 35676:a.uniformMatrix4fv(b.location,f||!1,d);break;default:XML3D.debug.logError("Unknown uniform type "+b.glType)}};d.prototype.destroyShader=function(a){for(var b in a.samplers)this.destroyTexture(a.samplers[b]);
this.gl.deleteProgram(a.handle)};d.prototype.createTexturesFromComputeResult=function(b,d){var e=b.samplers,f;for(f in e){var k=e[f],j=d.getOutputData(f);j?this.createTextureFromEntry(j,k):k.info=k.info||new a}};d.prototype.createTextureFromEntry=function(c,d){var e=c.getImage();if(e){var f=null,k=null,j=null;d.info&&-1!=d.info.status?(f=d.info.handle,k=d.info.canvas,j=d.info.context):f=this.gl.createTexture();var l=this.renderer,e=new b(f,{status:e.complete||e.readyState?1:0,onload:function(){l.requestRedraw.call(l,
"Texture loaded")},unit:d.unit,image:e,config:c.getSamplerConfig(),canvas:k,context:j});d.info=e}else d.info=new a,XML3D.debug.logWarning("No image found for texture: "+d)};d.prototype.replaceTexture=function(a,b){this.destroyTexture(b);var d=a.requestData([b.name])[b.name].getValue();d.imageAdapter.image=null;this.createTexture(d,b,b.texUnit);return b};d.prototype.createTex2DFromData=function(a,b,d,e,f,j,l){var m=this.gl,x={};j||(j=f==m.FLOAT?new Float32Array(4*b*d):new Uint8Array(4*b*d));var w=
m.createTexture();m.bindTexture(m.TEXTURE_2D,w);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,l.wrapS);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,l.wrapT);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,l.minFilter);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,l.magFilter);m.texImage2D(m.TEXTURE_2D,0,a,b,d,0,e,f,j);l.isDepth&&(m.texParameteri(m.TEXTURE_2D,m.DEPTH_TEXTURE_MODE,l.depthMode),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_COMPARE_MODE,l.depthCompareMode),m.texParameteri(m.TEXTURE_2D,
m.TEXTURE_COMPARE_FUNC,l.depthCompareFunc));l.generateMipmap&&m.generateMipmap(m.TEXTURE_2D);m.bindTexture(m.TEXTURE_2D,null);x.handle=w;x.options=l;x.status=2;x.glType=m.TEXTURE_2D;x.format=a;return x};d.prototype.createTex2DFromImage=function(a){if(-1==a.status)throw Error("Invalid texture");var b=this.gl,d=a.config||{},e=a.image;b.bindTexture(b.TEXTURE_2D,a.handle);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,d.wrapS);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,d.wrapT);b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MIN_FILTER,d.minFilter);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,d.magFilter);var f=e.videoWidth||e.width,j=e.videoHeight||e.height;if((d.wrapS!=b.CLAMP_TO_EDGE||d.wrapT!=b.CLAMP_TO_EDGE)&&(!this.isPowerOfTwo(f)||!this.isPowerOfTwo(j))){var l=null!==a.canvas?a.canvas:document.createElement("canvas"),f=this.nextHighestPowerOfTwo(f),j=this.nextHighestPowerOfTwo(j),m=null;null!==a.context&&f==l.width&&j==l.height?m=a.context:(l.width=f,l.height=j,m=l.getContext("2d"));m.drawImage(e,
0,0,l.width,l.height);e=l;a.canvas=l;a.context=m}b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,e);d.generateMipmap&&b.generateMipmap(b.TEXTURE_2D);b.bindTexture(b.TEXTURE_2D,null);a.status=2;a.glType=b.TEXTURE_2D;a.format=b.RGBA;return a};d.prototype.bindTexture=function(a){var b=a.info,e=this.gl;switch(b.status){case 2:e.activeTexture(e.TEXTURE0+b.unit+1);e.bindTexture(b.glType,b.handle);d.setUniform(e,a,b.unit+1);break;case 1:this.createTex2DFromImage(b);this.bindTexture(a);break;case 0:e.activeTexture(e.TEXTURE0+
b.unit+1);e.bindTexture(e.TEXTURE_2D,null);d.setUniform(e,a,b.unit+1);break;default:XML3D.debug.logDebug("Invalid texture: ",a.name,a)}};d.prototype.unbindTexture=function(a){this.gl.activeTexture(this.gl.TEXTURE1+a.info.unit);this.gl.bindTexture(a.info.glType,null)};d.prototype.destroyTexture=function(a){a.info&&a.info.handle&&this.gl.deleteTexture(a.info.handle)};d.prototype.isPowerOfTwo=function(a){return 0==(a&a-1)};d.prototype.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>
b;return a+1};XML3D.webgl.XML3DShaderManager=d})();var Material=function(b){this.shaderManager=b;this.isTransparent=!1};Material.prototype.parametersChanged=function(b){this.hasTransparency&&(this.isTransparent=this.hasTransparency(b))};Material.prototype.uniforms={};Material.prototype.samplers={};Material.prototype.fragment=null;Material.prototype.vertex=null;Material.prototype.meshRequest={index:null,position:{required:!0},normal:null,color:null,texcoord:null};
Material.prototype.getRequestFields=function(){return Object.keys(this.uniforms).concat(Object.keys(this.samplers))};Material.prototype.addDirectives=function(){};
Material.prototype.createProgram=function(b,a){if(!this.fragment||!this.vertex)return null;var f=[],d={};this.addDirectives(f,b||{},a?a.getOutputMap():{});d.fragment=Material.addDirectivesToSource(f,this.fragment);d.vertex=Material.addDirectivesToSource(f,this.vertex);f=this.shaderManager.createProgramFromSources(d);this.shaderManager.setUniformVariables(f,this.uniforms);a&&this.parametersChanged(a.getOutputMap());f.hasTransparency=this.isTransparent;f.material=this;return f};
Material.addDirectivesToSource=function(b,a){var f="";Array.forEach(b,function(a){f+="#define "+a+"\n"});return f+"\n"+a};Material.prototype.getProgram=function(b,a){this.program||(this.program=this.createProgram(b,a));return this.program};XML3D.webgl.MAX_PICK_BUFFER_WIDTH=512;XML3D.webgl.MAX_PICK_BUFFER_HEIGHT=512;XML3D.webgl.XML3DBufferHandler=function(b,a,f){this.renderer=a;this.gl=b;this.shaderManager=f};
XML3D.webgl.XML3DBufferHandler.prototype.createPickingBuffer=function(b,a){var f=this.gl,d=1,e=a-XML3D.webgl.MAX_PICK_BUFFER_HEIGHT,c=b-XML3D.webgl.MAX_PICK_BUFFER_WIDTH;if(0<e||0<c)d=e>c?XML3D.webgl.MAX_PICK_BUFFER_HEIGHT/a:XML3D.webgl.MAX_PICK_BUFFER_WIDTH/b;b=Math.floor(b*d);a=Math.floor(a*d);return this.createFrameBuffer(b,a,f.RGBA,f.DEPTH_COMPONENT16,null,{depthAsRenderbuffer:!0},d)};XML3D.webgl.XML3DBufferHandler.prototype.createShadowBuffer=function(){};
XML3D.webgl.XML3DBufferHandler.prototype.createFrameBuffer=function(b,a,f,d,e,c,h){var g=this.gl,c=this.fillOptions(c),i=g.createFramebuffer();g.bindFramebuffer(g.FRAMEBUFFER,i);var k={handle:null,isTexture:!1};if(f)if(c.colorAsRenderbuffer){var j=g.createRenderbuffer();g.bindRenderbuffer(g.RENDERBUFFER,j);g.renderbufferStorage(g.RENDERBUFFER,f,b,a);g.bindRenderbuffer(g.RENDERBUFFER,null);g.framebufferRenderbuffer(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.RENDERBUFFER,j);k.handle=j;k.isTexture=!1}else f=
this.shaderManager.createTex2DFromData(f,b,a,g.RGBA,g.UNSIGNED_BYTE,null,c),g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,f.handle,0),k.handle=i,k.isTexture=!0;f={handle:null,isTexture:!1};d&&(c.isDepth=!0,c.depthAsRenderbuffer?(j=g.createRenderbuffer(),g.bindRenderbuffer(g.RENDERBUFFER,j),g.renderbufferStorage(g.RENDERBUFFER,d,b,a),g.bindRenderbuffer(g.RENDERBUFFER,null),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,j),f.handle=j,f.isTexture=!1):
(d=this.shaderManager.createTex2DFromData(d,b,a,g.DEPTH_COMPONENT,g.FLOAT,null,c),g.framebufferTexture2D(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.TEXTURE_2D,d.handle,0),f.handle=d.handle,f.isTexture=!0));d={handle:null,isTexture:!1};e&&(c.isDepth=!1,c.stencilAsRenderbuffer?(c=g.createRenderbuffer(),g.bindRenderbuffer(g.RENDERBUFFER,c),g.renderbufferStorage(g.RENDERBUFFER,e,b,a),g.bindRenderbuffer(g.RENDERBUFFER,null),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.STENCIL_ATTACHMENT,g.RENDERBUFFER,c),d.handle=
c,d.isTexture=!1):(e=this.shaderManager.createTex2DFromData(e,b,a,g.STENCIL_COMPONENT,g.UNSIGNED_BYTE,null,c),g.framebufferTexture2D(g.FRAMEBUFFER,g.STENCIL_ATTACHMENT,g.TEXTURE_2D,e.handle,0),d.handle=e.handle,d.isTexture=!0));e=g.checkFramebufferStatus(g.FRAMEBUFFER);switch(e){case g.FRAMEBUFFER_COMPLETE:break;case g.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case g.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case g.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case g.FRAMEBUFFER_UNSUPPORTED:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");break;default:XML3D.debug.logError("Incomplete framebuffer: "+e)}g.bindFramebuffer(g.FRAMEBUFFER,null);c={};c.handle=i;c.valid=e==g.FRAMEBUFFER_COMPLETE;c.width=b;c.height=a;c.colorTarget=k;c.depthTarget=f;c.stencilTarget=d;c.scale=h;return c};
XML3D.webgl.XML3DBufferHandler.prototype.destroyFrameBuffer=function(b){if(b.handle){var a=this.gl;a.deleteFramebuffer(b.handle);null!==b.colorTarget&&(b.colorTarget.isTexture?a.deleteTexture(b.colorTarget.handle):a.deleteRenderBuffer(b.colorTarget.handle));null!==b.depthTarget&&(b.depthTarget.isTexture?a.deleteTexture(b.depthTarget.handle):a.deleteRenderBuffer(b.depthTarget.handle));null!==b.stencilTarget&&(b.stencilTarget.isTexture?a.deleteTexture(b.stencilTarget.handle):a.deleteRenderBuffer(b.stencilTarget.handle))}};
XML3D.webgl.XML3DBufferHandler.prototype.fillOptions=function(b){var a=this.gl,a={wrapS:a.CLAMP_TO_EDGE,wrapT:a.CLAMP_TO_EDGE,minFilter:a.NEAREST,magFilter:a.NEAREST,depthMode:a.LUMINANCE,depthCompareMode:a.COMPARE_R_TO_TEXTURE,depthCompareFunc:a.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,isDepth:!1},f;for(f in b)a[f]=b[f];return a};
(function(){var b=window.StateMachine,a=function(b){this.handler=b.handler;this.meshAdapter=b.meshAdapter;this.shaderAdapter=null;this.shader=b.shader||null;this.transform=b.transform||a.IDENTITY_MATRIX;this.visible=void 0!==b.visible?b.visible:!0;this.meshAdapter.renderObject=this;this.override=null;this.create()};a.IDENTITY_MATRIX=XML3D.math.mat4.identity(XML3D.math.mat4.create());a.prototype={onenterReady:function(){this.handler.moveFromQueueToReady(this)},onleaveReady:function(){this.handler.moveFromReadyToQueue(this)},
onafterlightsChanged:function(a,b,e,c,h){c&&(this.shaderAdapter=(a=this.meshAdapter.getShaderHandle())&&a.getAdapter(),this.shader=h.createShader(this.shaderAdapter,c))},onbeforedataComplete:function(){return!this.meshAdapter.finishMesh()?!1:!0},onbeforeprogress:function(a,b,e){switch(e){case "NoMaterial":return null!=this.shader}switch(b){case "DirtyMeshData":this.meshAdapter.createMeshData()}},onenterNoMesh:function(){return!0},onenterDisposed:function(){this.handler.remove(this)},onchangestate:function(a,
b,e){XML3D.debug.logInfo("Changed: ",a,b,e)}};a.prototype.setOverride=function(a){if(a.outputNames.length){var b=this.meshAdapter.factory.renderer.shaderManager.getShaderById(this.shader);this.override=Object.create(null);for(var e in b.uniforms){var c=a.getOutputData(e);c&&c.getValue()&&(this.override[e]=c.getValue())}XML3D.debug.logInfo("Shader attribute override",a,this.override)}};b.create({target:a.prototype,events:[{name:"create",from:"none",to:"NoLights"},{name:"progress",from:"NoLights",to:"NoMaterial"},
{name:"progress",from:"NoMaterial",to:"NoMesh"},{name:"dataNotComplete",from:"NoMesh",to:"NoMeshData"},{name:"dataComplete",from:"NoMesh",to:"Ready"},{name:"progress",from:"DirtyMeshData",to:"Ready"},{name:"lightsChanged",from:"NoLights,NoMaterial,NoMesh,Ready,NoMeshData,DirtyMeshData".split(","),to:"NoLights"},{name:"materialChanged",from:["NoMaterial","NoMesh","Ready","NoMeshData","DirtyMeshData"],to:"NoMaterial"},{name:"dataStructureChanged",from:["NoMesh","Ready","NoMeshData","DirtyMeshData"],
to:"NoMesh"},{name:"dataValueChanged",from:["Ready","DirtyMeshData"],to:"DirtyMeshData"},{name:"dispose",from:"*",to:"Disposed"}]});XML3D.webgl.RenderObject=a;XML3D.webgl.RenderObjectHandler=function(){this.remove=function(a){var b=this.ready.indexOf(a);-1==b?(b=this.queue.indexOf(a),this.queue.splice(b,1)):this.ready.splice(b,1)};this.clear=function(){this.ready=[];this.queue=[]};this.moveFromQueueToReady=function(a){var b=this.queue.indexOf(a);-1!=b&&(this.queue.splice(b,1),this.ready.push(a))};
this.moveFromReadyToQueue=function(a){var b=this.ready.indexOf(a);-1!=b&&(this.ready.splice(b,1),this.queue.push(a))};this.remove=function(a){var b=this.queue.indexOf(a);-1!=b&&this.queue.splice(b,1);b=this.ready.indexOf(a);-1!=b&&this.ready.splice(b,1)};this.consolidate=function(){this.queue.slice().forEach(function(a){for(;a.can("progress")&&a.progress()==b.Result.SUCCEEDED;);"NoMesh"==a.current&&a.dataComplete()!==b.Result.SUCCEEDED&&a.dataNotComplete()})};this.updateLights=function(a,b){a.structureChanged?
(this.forEach(function(e){e.lightsChanged(a,b)},this),a.structureChanged=!1):this.queue.forEach(function(e){"NoLights"==e.current&&e.lightsChanged(a,b)},this)};this.forEach=function(a,b){this.queue.slice().forEach(a,b);this.ready.slice().forEach(a,b)};this.clear()}})();
(function(){var b=function(a,b,c){this.handler=a;this.gl=b;this.setGlobalGLStates();this.currentView=null;this.xml3dNode=a.xml3dElem;this.width=c.width;this.height=c.height;this.renderObjects=new XML3D.webgl.RenderObjectHandler;this.initialize()};b.prototype.initialize=function(){this.factory=new XML3D.webgl.RenderAdapterFactory(this.handler,this);this.shaderManager=new XML3D.webgl.XML3DShaderManager(this,this.factory);this.bufferHandler=new XML3D.webgl.XML3DBufferHandler(this.gl,this,this.shaderManager);
this.changeListener=new XML3D.webgl.DataChangeListener(this);this.camera=this.initCamera();this.fbos=this.initFrameBuffers(this.gl);this.initializeScenegraph()};b.prototype.initializeScenegraph=function(){this.lights={changed:!0,structureChanged:!0,point:{length:0,adapter:[],intensity:[],position:[],attenuation:[],visibility:[]},directional:{length:0,adapter:[],intensity:[],direction:[],attenuation:[],visibility:[]},spot:{length:0,adapter:[],intensity:[],direction:[],attenuation:[],visibility:[],
position:[],falloffAngle:[],softness:[]}};this.recursiveBuildScene(this.xml3dNode,this.renderObjects.queue,null);1>this.lights.length&&XML3D.debug.logWarning("No lights were found. The scene will be rendered without lighting!")};b.prototype.setGlobalGLStates=function(){var a=this.gl;a.pixelStorei(a.PACK_ALIGNMENT,1);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL)};
b.prototype.initCamera=function(){var a=XML3D.util.getOrCreateActiveView(this.xml3dNode);this.currentView=a;return this.factory.getAdapter(a)};var a=function(a){a=a||{};this.visible=void 0!==a.visible?a.visible:!0;this.pickable=void 0!==a.pickable?a.visible:!0;this.transform=a.transform?XML3D.math.mat4.copy(XML3D.math.mat4.create(),a.transform):XML3D.math.mat4.identity(XML3D.math.mat4.create());this.shader=a.shader||null};b.prototype.recursiveBuildScene=function(b,c,d){var e=this.factory.getAdapter(b),
d=d||new a,f=new a(d);switch(b.nodeName){case "group":e.parentVisible=d.visible;e.parentTransform=XML3D.math.mat4.copy(XML3D.math.mat4.create(),d.transform);e.parentShaderHandle=d.shader;f.visible=d.visible&&b.visible;(b.onmouseover||b.onmouseout)&&this.handler.setMouseMovePicking(!0);if(d=e.getShaderHandle())f.shader=d;f.transform=e.applyTransformMatrix(XML3D.math.mat4.identity(XML3D.math.mat4.create()));break;case "mesh":e.parentVisible=d.visible;(b.onmouseover||b.onmouseout)&&this.handler.setMouseMovePicking(!0);
if(!this.factory.getAdapter(b))break;e.setShaderHandle(d.shader);e=new XML3D.webgl.RenderObject({handler:this.renderObjects,meshAdapter:e,visible:d.visible&&b.visible,transform:d.transform,pickable:d.pickable});c.push(e);break;case "light":e.transform=XML3D.math.mat4.copy(XML3D.math.mat4.create(),d.transform);e.visible=d.visible&&b.visible;e.addLight(this.lights);break;case "view":e.parentTransform=XML3D.math.mat4.copy(XML3D.math.mat4.create(),d.transform),e.updateViewMatrix()}for(b=b.firstElementChild;b;)this.recursiveBuildScene(b,
c,f),b=b.nextElementSibling};b.prototype.initFrameBuffers=function(){var a={};a.picking=this.bufferHandler.createPickingBuffer(this.width,this.height);a.vectorPicking=this.bufferHandler.createPickingBuffer(this.width,this.height);if(!a.picking.valid||!a.vectorPicking.valid)this.handler._pickingDisabled=!0;return a};b.prototype.recompileShader=function(a){this.shaderManager.recompileShader(a,this.lights);this.handler.redraw("A shader was recompiled")};b.prototype.changeLightData=function(a,b,c,d){if(a=
this.lights[a][b]){if("falloffAngle"==b||"softness"==b)c/=3;Array.set(a,c,d);this.lights.changed=!0}};b.prototype.setGLContext=function(a){this.shaderManager.setGLContext(a);this.meshManager.setGLContext(a)};b.prototype.resizeCanvas=function(a,b){this.width=a;this.height=b;this.fbos=this.initFrameBuffers(this.gl);this.camera&&(this.camera.projMatrix=null)};b.prototype.activeViewChanged=function(){this._viewMatrix=this._projMatrix=null;this.camera=this.initCamera();this.requestRedraw("Active view changed",
!0)};b.prototype.requestRedraw=function(a,b){this.handler.redraw(a,b)};b.prototype.sceneTreeAddition=function(b){var c=b.wrapped.target,d=this.factory.getAdapter(c);if(d){var e=d.getShaderHandle?d.getShaderHandle():null;d.updateTransformAdapter&&d.updateTransformAdapter();var d=c.visible,c=c.parentElement,f=XML3D.math.mat4.identity(XML3D.math.mat4.create());c&&"group"==c.nodeName&&(d=this.factory.getAdapter(c),f=d.applyTransformMatrix(f),e||(e=d.getShaderHandle()),d=c.visible&&d.parentVisible);e=
new a({visible:d,pickable:!0,transform:f,shader:e});this.recursiveBuildScene(b.wrapped.target,this.renderObjects.queue,e);this.requestRedraw("A node was added.")}};b.prototype.sceneTreeRemoval=function(a){(a=this.factory.getAdapter(a.wrapped.target))&&a.destroy&&a.destroy();this.requestRedraw("A node was removed.")};b.prototype.prepareRendering=function(){var a=this.renderObjects;a.updateLights(this.lights,this.shaderManager);a.consolidate()};b.prototype.render=function(){var a=this.gl;a.clear(a.COLOR_BUFFER_BIT|
a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);a.viewport(0,0,this.width,this.height);a.enable(a.DEPTH_TEST);if(!this.camera)return[0,0];var b={};b.view=this.camera.viewMatrix;b.proj=this.camera.getProjectionMatrix(this.width/this.height);for(var c={objCount:0,triCount:0},d=this.renderObjects.ready,e=0,f=d.length;e<f;e++){var h=d[e];h&&h.mesh&&h.mesh.update()}f={};e=[];this.sortObjects(d,f,e,b);for(var g in f)d=f[g],this.drawObjects(d,g,b,this.lights,c);if(0<e.length){a.enable(a.BLEND);a.blendFuncSeparate(a.SRC_ALPHA,
a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);for(g=0;g<e.length;g++)d=[e[g]],this.drawObjects(d,d[0].shader,b,this.lights,c);a.disable(a.BLEND)}this.lights.changed=!1;return[c.objCount,c.triCount]};b.prototype.sortObjects=function(a,b,c,d){for(var e=[],f=0,h=a.length;f<h;f++){var g=a[f],q=g.shader;this.shaderManager.getShaderById(q).hasTransparency?e.push(g):(b[q]=b[q]||[],b[q].push(g))}a=e.length;if(1<a){for(f=0;f<a;f++)g=e[f],b=g.transform,h=g.mesh.bbox.center()._data,h=XML3D.math.vec4.transformMat4(XML3D.math.vec4.create(),
[h[0],h[1],h[2],1],b),h=XML3D.math.vec4.transformMat4(XML3D.math.vec4.create(),[h[0],h[1],h[2],1],d.view),e[f]=[g,h[2]];e.sort(function(a,b){return a[1]-b[1]});for(f=0;f<a;f++)c[f]=e[f][0]}else 1==a&&(c[0]=e[0])};var f=XML3D.math.mat4.create(),d=XML3D.math.mat4.create(),e=XML3D.math.mat3.identity(XML3D.math.mat3.create()),c=XML3D.math.mat4.identity(XML3D.math.mat4.create());b.prototype.drawObjects=function(a,b,e,h,g){var x=0,w=0,o={},b=b||a[0].shader||"defaultShader",b=this.shaderManager.getShaderById(b);
if(b.needsLights||h.changed){o.pointLightPosition=h.point.position;o.pointLightAttenuation=h.point.attenuation;o.pointLightVisibility=h.point.visibility;o.pointLightIntensity=h.point.intensity;o.directionalLightDirection=h.directional.direction;o.directionalLightVisibility=h.directional.visibility;o.directionalLightIntensity=h.directional.intensity;o.spotLightAttenuation=h.spot.attenuation;o.spotLightPosition=h.spot.position;o.spotLightIntensity=h.spot.intensity;o.spotLightVisibility=h.spot.visibility;
o.spotLightDirection=h.spot.direction;o.spotLightCosFalloffAngle=h.spot.falloffAngle.map(Math.cos);for(var q=h.spot.falloffAngle.slice(),s=0;s<q.length;s++)q[s]*=1-h.spot.softness[s];o.spotLightCosSoftFalloffAngle=q.map(Math.cos);o.spotLightSoftness=h.spot.softness;b.needsLights=!1}this.shaderManager.bindShader(b);this.shaderManager.updateActiveShader(b);o.viewMatrix=this.camera.viewMatrix;o.cameraPosition=this.camera.getWorldSpacePosition();this.shaderManager.setUniformVariables(b,o);o={};s=0;for(h=
a.length;s<h;s++){var q=a[s],n=q.mesh;if(n&&n.valid&&q.visible){e.model=q.transform;e.modelView=XML3D.math.mat4.multiply(f,this.camera.viewMatrix,e.model);o.modelMatrix=e.model;o.modelViewMatrix=e.modelView;o.modelViewProjectionMatrix=XML3D.math.mat4.multiply(d,this.camera.projMatrix,e.modelView);var p=XML3D.math.mat4.invert(XML3D.math.mat4.create(),e.modelView),p=p?XML3D.math.mat4.transpose(p,p):c;o.normalMatrix=XML3D.math.mat3.copy(XML3D.math.mat3.create(),[p[0],p[1],p[2],p[4],p[5],p[6],p[8],p[9],
p[10]]);this.shaderManager.setUniformVariables(b,o);null!==q.override&&this.shaderManager.setUniformVariables(b,q.override);w+=this.drawObject(b,n);x++;null!==q.override&&this.shaderManager.resetUniformVariables(q.shaderAdapter,b,Object.keys(q.override))}}g.objCount+=x;g.triCount+=w};b.prototype.drawObject=function(a,b){var c=a.attributes,d=this.gl,e=0,f=b.vbos;if(b.complete){for(var h=b.isIndexed?f.index.length:f.position?f.position.length:1,g=0;g<h;g++){for(var q in c){var s=c[q];f[q]&&(e=1<f[q].length?
f[q][g]:f[q][0],d.enableVertexAttribArray(s.location),d.bindBuffer(d.ARRAY_BUFFER,e),d.vertexAttribPointer(s.location,e.tupleSize,e.glType,!1,0,0))}if(b.isIndexed){d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,f.index[g]);if(b.segments)for(var s=0,e=b.segments.value,n=0;n<e.length;n++)d.drawElements(b.glType,e[n],d.UNSIGNED_SHORT,s),s+=2*e[n];else d.drawElements(b.glType,b.getVertexCount(),d.UNSIGNED_SHORT,0);e=b.getVertexCount()/3}else{if(b.size){s=0;e=b.size.data;for(n=0;n<e.length;n++)d.drawArrays(b.glType,
s,e[n]),s+=2*e[n]}else d.drawArrays(b.glType,0,b.getVertexCount());e=f.position?f.position[g].length/3:0}for(q in c)s=c[q],d.disableVertexAttribArray(s.location)}d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return e}};b.prototype.renderSceneToPickingBuffer=function(){var a=this.gl,b=this.fbos.picking;a.bindFramebuffer(a.FRAMEBUFFER,b.handle);a.enable(a.DEPTH_TEST);a.disable(a.CULL_FACE);a.disable(a.BLEND);a.viewport(0,0,b.width,b.height);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|
a.STENCIL_BUFFER_BIT);var c=this.camera.viewMatrix,b=this.camera.getProjectionMatrix(b.width/b.height),d=XML3D.math.mat4.create(),e=this.shaderManager.getShaderById("pickobjectid");this.shaderManager.bindShader(e);for(var f=this.renderObjects.ready,h=0,g=f.length;h<g;h++){var q=f[h],s=q.mesh;if(s.valid&&q.visible){var n={};XML3D.math.mat4.multiply(d,c,q.transform);XML3D.math.mat4.multiply(d,b,d);var q=h+1,p=q&255,q=q>>8,r=q&255,q=q>>8;n.id=[(q&255)/255,r/255,p/255];n.modelViewProjectionMatrix=d;this.shaderManager.setUniformVariables(e,
n);this.drawObject(e,s)}}this.shaderManager.unbindShader(e);a.disable(a.DEPTH_TEST);a.bindFramebuffer(a.FRAMEBUFFER,null)};b.prototype.renderPickedPosition=function(a){var b=this.gl;b.bindFramebuffer(b.FRAMEBUFFER,this.fbos.vectorPicking.handle);b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT);b.enable(b.DEPTH_TEST);b.disable(b.CULL_FACE);b.disable(b.BLEND);this.bbMax=(new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE))._data;this.bbMin=(new window.XML3DVec3(Number.MAX_VALUE,
Number.MAX_VALUE,Number.MAX_VALUE))._data;XML3D.webgl.adjustMinMax(a.mesh.bbox,this.bbMin,this.bbMax,a.transform);var c=this.shaderManager.getShaderById("pickedposition");this.shaderManager.bindShader(c);var d,e;d=a.transform;e=this.camera.getModelViewMatrix(d);d={min:this.bbMin,max:this.bbMax,modelMatrix:d,modelViewProjectionMatrix:this.camera.getModelViewProjectionMatrix(e)};this.shaderManager.setUniformVariables(c,d);this.drawObject(c,a.mesh);this.shaderManager.unbindShader(c);b.bindFramebuffer(b.FRAMEBUFFER,
null)};b.prototype.renderPickedNormals=function(a){var b=this.gl;b.bindFramebuffer(b.FRAMEBUFFER,this.fbos.vectorPicking.handle);b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT);b.enable(b.DEPTH_TEST);b.disable(b.CULL_FACE);b.disable(b.BLEND);var c=a.transform,a=a.mesh,d=this.shaderManager.getShaderById("pickedNormals");this.shaderManager.bindShader(d);var f;f=this.camera.getModelViewMatrix(c);var h=XML3D.math.mat4.invert(XML3D.math.mat4.create(),c),h=XML3D.math.mat3.copy(XML3D.math.mat3.create(),
[h[0],h[1],h[2],h[4],h[5],h[6],h[8],h[9],h[10]]),c={modelViewMatrix:c,modelViewProjectionMatrix:this.camera.getModelViewProjectionMatrix(f),normalMatrix:h?XML3D.math.mat3.transpose(h,h):e};this.shaderManager.setUniformVariables(d,c);this.drawObject(d,a);this.shaderManager.unbindShader(d);b.bindFramebuffer(b.FRAMEBUFFER,null)};var h=XML3D.math.vec3.create(),g=new Uint8Array(8);b.prototype.getRenderObjectFromPickingBuffer=function(a,b){var c=this.readPixelDataFromBuffer(a,b,this.fbos.picking);if(!c)return null;
var d=null,c=65536*c[0]+256*c[1]+c[2];0<c&&(d=this.renderObjects.ready[c-1]);return d};b.prototype.readPixelDataFromBuffer=function(a,b,c){var d=c.scale,a=a*d,b=b*d,d=this.gl;d.bindFramebuffer(d.FRAMEBUFFER,c.handle);try{return d.readPixels(a,b,1,1,d.RGBA,d.UNSIGNED_BYTE,g),d.bindFramebuffer(d.FRAMEBUFFER,null),g}catch(e){return XML3D.debug.logException(e),d.bindFramebuffer(d.FRAMEBUFFER,null),null}};b.prototype.readNormalFromPickingBuffer=function(a,b){var c=this.readPixelDataFromBuffer(a,b,this.fbos.vectorPicking);
return c?(h[0]=c[0]/254,h[1]=c[1]/254,h[2]=c[2]/254,h=XML3D.math.vec3.subtract(XML3D.math.vec3.create(),XML3D.math.vec3.scale(XML3D.math.vec3.create(),h,2),[1,1,1])):null};b.prototype.readPositionFromPickingBuffer=function(a,b){var c=this.readPixelDataFromBuffer(a,b,this.fbos.vectorPicking);return c?(h[0]=c[0]/255,h[1]=c[1]/255,h[2]=c[2]/255,c=XML3D.math.vec3.subtract(XML3D.math.vec3.create(),this.bbMax,this.bbMin),c=XML3D.math.vec3.fromValues(h[0]*c[0],h[1]*c[1],h[2]*c[2]),XML3D.math.vec3.add(c,
this.bbMin,c),c):null};b.prototype.dispose=function(){this.renderObjects.clear()};b.prototype.notifyDataChanged=function(){this.handler.redraw("Unspecified data change.")};XML3D.webgl.Renderer=b})();
(function(){var b=0;XML3D.webgl.RenderAdapter=function(a,b){XML3D.base.NodeAdapter.call(this,a,b)};XML3D.createClass(XML3D.webgl.RenderAdapter,XML3D.base.NodeAdapter);XML3D.webgl.RenderAdapter.prototype.getShader=function(){return null};XML3D.webgl.RenderAdapter.prototype.getAdapterHandle=function(a){return XML3D.base.resourceManager.getAdapterHandle(this.node.ownerDocument,a,XML3D.webgl,this.factory.handler.id)};XML3D.webgl.RenderAdapter.prototype.applyTransformMatrix=function(a){return a};XML3D.webgl.DefsRenderAdapter=
function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b)};XML3D.createClass(XML3D.webgl.DefsRenderAdapter,XML3D.webgl.RenderAdapter);XML3D.webgl.ImgRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.textureAdapter=a.getAdapter(b.parentNode)};XML3D.createClass(XML3D.webgl.ImgRenderAdapter,XML3D.webgl.RenderAdapter);XML3D.webgl.ImgRenderAdapter.prototype.notifyChanged=function(a){this.textureAdapter.notifyChanged(a)};var a="position,direction,intensity,attenuation,softness,falloffAngle".split(",");
XML3D.webgl.LightShaderRenderAdapter=function(b,d){XML3D.webgl.RenderAdapter.call(this,b,d);this.dataAdapter=XML3D.data.factory.getAdapter(this.node);this.computeRequest=this.dataAdapter.getComputeRequest(a,this.dataChanged.bind(this));this.offsets=[];this.listeners=[]};XML3D.createClass(XML3D.webgl.LightShaderRenderAdapter,XML3D.webgl.RenderAdapter);var f=XML3D.math.vec3.fromValues(1,1,1),d=XML3D.math.vec3.fromValues(0,0,1),e=Math.PI/4;XML3D.webgl.LightShaderRenderAdapter.prototype.fillPointLight=
function(a,b,e){this.callback=a.dataChanged;this.offsets.push(e);var i=this.computeRequest.getResult().getOutputMap(),k=i.intensity?i.intensity.getValue():f,i=i.attenuation?i.attenuation.getValue():d;Array.set(a.intensity,e,[k[0]*b,k[1]*b,k[2]*b]);Array.set(a.attenuation,e,i)};XML3D.webgl.LightShaderRenderAdapter.prototype.fillDirectionalLight=function(a,b,d){this.callback=a.dataChanged;this.offsets.push(d);var e=this.computeRequest.getResult().getOutputMap(),e=e.intensity?e.intensity.getValue():
f;Array.set(a.intensity,d,[e[0]*b,e[1]*b,e[2]*b])};XML3D.webgl.LightShaderRenderAdapter.prototype.fillSpotLight=function(a,b,g){this.callback=a.dataChanged;this.offsets.push(g);var i=this.computeRequest.getResult().getOutputMap(),k=i.intensity?i.intensity.getValue():f,j=i.attenuation?i.attenuation.getValue():d,l=i.falloffAngle?i.falloffAngle.getValue():[e],i=i.softness?i.softness.getValue():[0];Array.set(a.intensity,g,[k[0]*b,k[1]*b,k[2]*b]);Array.set(a.attenuation,g,j);Array.set(a.falloffAngle,g/
3,l);Array.set(a.softness,g/3,i)};XML3D.webgl.LightShaderRenderAdapter.prototype.removeLight=function(a,b,d){var e=b[a];if(e){switch(a){case "point":e.intensity.splice(d,3);e.attenuation.splice(d,3);break;case "directional":e.intensity.splice(d,3);break;case "spot":e.intensity.splice(d,3),e.attenuation.splice(d,3),e.beamWidth.splice(d/3,1),e.cutOffAngle.splice(d/3,1)}b.changed=!0}};XML3D.webgl.LightShaderRenderAdapter.prototype.dataChanged=function(b){for(var b=b.getResult(),d=0;d<a.length;d++){var e=
b.getOutputData(a[d]),f=XML3D.webgl.getXflowEntryWebGlData(e,this.factory.canvasId);if(e&&f&&f.changed){for(var e=e.getValue(),k=0;k<this.listeners.length;k++)this.listeners[k].func(a[d],e);f.changed=0}}};XML3D.webgl.LightShaderRenderAdapter.prototype.notifyChanged=function(a){a.type!=XML3D.events.NODE_REMOVED&&a.type==XML3D.events.THIS_REMOVED&&this.notifyOppositeAdapters()};XML3D.webgl.LightShaderRenderAdapter.prototype.registerLightListener=function(a){b++;this.listeners.push({id:b,func:a});return b};
XML3D.webgl.LightShaderRenderAdapter.prototype.removeLightListener=function(a){for(var b=0;b<this.listeners.length;b++)if(this.listeners[b].id==a){this.listeners.splice(b,1);break}};XML3D.webgl.LightShaderRenderAdapter.prototype.destroy=function(){this.notifyOppositeAdapters()};XML3D.webgl.LightShaderRenderAdapter.prototype.requestParameter=function(a){return this.computeRequest.getResult().getOutputData(a)}})();
(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.factory=a;this.processListeners()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){a.type==XML3D.events.NODE_INSERTED?this.factory.renderer.sceneTreeAddition(a):a.type==XML3D.events.NODE_REMOVED&&this.factory.renderer.sceneTreeRemoval(a);"activeView"==(a.internalType||a.attrName||a.wrapped.attrName)&&this.factory.renderer.activeViewChanged()};b.prototype.processListeners=function(){var a=
this.node.attributes,b;for(b in a){var d=a[b];if(d.name){var e=d.name;if(e.match(/onmouse/)||"onclick"==e||"ondblclick"==e){var c=e.substring(2);this.node.addEventListener(c,new Function("evt",d.value),!1)}"onload"==e&&(c=e.substring(2),this.node.addEventListener(c,new Function("evt",d.value),!1))}}};b.prototype.onConfigured=function(){var a=function(a){var b=2;return function(){b--;0==b&&XML3D.util.dispatchEvent(a,"load")}}(this.node,this.factory.handler.id);XML3D.base.resourceManager.addLoadCompleteListener(0,
a);XML3D.base.resourceManager.addLoadCompleteListener(this.factory.handler.id,a)};b.prototype.getBoundingBox=function(){var a=new window.XML3DBox;Array.prototype.forEach.call(this.node.childNodes,function(b){b.getBoundingBox&&a.extend(b.getBoundingBox())});return a};b.prototype.getElementByPoint=function(a,b,d,e){var b=XML3D.webgl.convertPageCoords(this.node,a,b),a=b.x,b=b.y,c=this.factory.handler,h=c.updatePickObjectByPoint(a,b);if(h){if(d){var g=c.getWorldSpacePositionByPoint(h,a,b);d.set(g[0],
g[1],g[2])}e&&(g=c.getWorldSpaceNormalByPoint(h,a,b),e.set(g[0],g[1],g[2]))}else d&&d.set(NaN,NaN,NaN),e&&e.set(NaN,NaN,NaN);return h?h.meshAdapter.node:null};b.prototype.generateRay=function(a,b){var d=XML3D.webgl.convertPageCoords(this.node,a,b);return this.factory.handler.generateRay(d.x,d.y)};XML3D.webgl.XML3DRenderAdapter=b})();
(function(){function b(a,b){a.requests[b]||(a.requests[b]=a.dataAdapter.getComputeRequest([b],function(b,c){a.dataChanged(b,c)}))}var a=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.needsUpdate=this.isValid=!0};XML3D.createClass(a,XML3D.webgl.RenderAdapter);var f=a.prototype,d=XML3D.math.mat4.identity(XML3D.math.mat4.create());f.init=function(){this.matrix=XML3D.math.mat4.create();this.transform={translate:XML3D.math.mat4.create(),scale:XML3D.math.mat4.create(),scaleOrientationInv:XML3D.math.mat4.create(),
center:XML3D.math.mat4.create(),centerInverse:XML3D.math.mat4.create()};this.needsUpdate=!0};f.updateMatrix=function(){var a=this.node,b=this.transform,f=a.translation._data,g=a.center._data,i=a.scale._data,k=a.scaleOrientation.toMatrix()._data,a=a.rotation.toMatrix()._data;XML3D.math.mat4.translate(b.translate,d,f);XML3D.math.mat4.translate(b.center,d,g);XML3D.math.mat4.translate(b.centerInverse,d,XML3D.math.vec3.negate(g,g));XML3D.math.mat4.scale(b.scale,d,i);XML3D.math.mat4.invert(b.scaleOrientationInv,
k);XML3D.math.mat4.multiply(this.matrix,b.translate,b.center);XML3D.math.mat4.multiply(this.matrix,this.matrix,a);XML3D.math.mat4.multiply(this.matrix,this.matrix,k);XML3D.math.mat4.multiply(this.matrix,this.matrix,b.scale);XML3D.math.mat4.multiply(this.matrix,this.matrix,b.scaleOrientationInv);XML3D.math.mat4.multiply(this.matrix,this.matrix,b.centerInverse);this.needsUpdate=!1};f.getMatrix=function(){this.needsUpdate&&this.updateMatrix();return this.matrix};f.notifyChanged=function(a){1==a.type?
(this.needsUpdate=!0,this.factory.renderer.requestRedraw("Transformation changed.",!0)):2==a.type&&this.dispose();this.notifyOppositeAdapters()};f.dispose=function(){this.isValid=!1};XML3D.webgl.TransformRenderAdapter=a;a=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b)};XML3D.createClass(a,XML3D.webgl.RenderAdapter);f=a.prototype;f.init=function(){this.dataAdapter=XML3D.data.factory.getAdapter(this.node);this.matrixReady={};this.matrices={};this.requests={}};f.updateMatrix=function(a){b(this,
a);this.matrices[a]=XML3D.math.mat4.create();var c=this.requests[a].getResult();if(c=c.getOutputData(a)&&c.getOutputData(a).getValue()){for(var d=0;16>d;++d)this.matrices[a][d]=c[d];this.matrixReady[a]=!0}else XML3D.math.mat4.identity(this.matrices[a])};f.getMatrix=function(a){!this.matrixReady[a]&&this.updateMatrix(a);return this.matrices[a]};f.dataChanged=function(a){this.factory.renderer.requestRedraw("Transformation changed.",!0);for(var b in this.requests)this.requests[b]==a&&delete this.matrixReady[b];
this.notifyOppositeAdapters()};XML3D.webgl.DataRenderAdapter=a})();
(function(){function b(a){var b=a.node.getAttribute("perspective");b?a.connectAdapterHandle("perspective",a.getAdapterHandle(b)):a.disconnectAdapterHandle("perspective")}var a=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.zFar=1E5;this.zNear=0.1;this.parentTransform=null;this.viewMatrix=XML3D.math.mat4.create();this.projMatrix=null;this.worldPosition=[0,0,0];this.updateViewMatrix()};XML3D.createClass(a,XML3D.webgl.RenderAdapter);var f=a.prototype,d=XML3D.math.mat4.create(),e=XML3D.math.mat4.create();
f.updateViewMatrix=function(){var a=this.node.position._data,f=this.node.orientation.toMatrix()._data;XML3D.math.mat4.identity(d);d[12]=a[0];d[13]=a[1];d[14]=a[2];XML3D.math.mat4.multiply(d,d,f);(this.parentTransform=this.factory.getAdapter(this.node.parentNode).applyTransformMatrix(XML3D.math.mat4.identity(e)))&&XML3D.math.mat4.multiply(d,this.parentTransform,d);this.worldPosition=[d[12],d[13],d[14]];XML3D.math.mat4.copy(this.viewMatrix,XML3D.math.mat4.invert(d,d));b(this)};f.getProjectionMatrix=
function(a){if(null==this.projMatrix){var b=this.getConnectedAdapter("perspective");if(b)this.projMatrix=b.getMatrix("perspective");else{var b=this.zFar,d=this.zNear,e=1/Math.tan(this.node.fieldOfView/2);this.projMatrix=XML3D.math.mat4.copy(XML3D.math.mat4.create(),[e/a,0,0,0,0,e,0,0,0,0,(d+b)/(d-b),-1,0,0,2*d*b/(d-b),0])}}return this.projMatrix};f.getViewMatrix=function(){var a=new window.XML3DMatrix;a._data.set(this.viewMatrix);return a};f.getWorldMatrix=function(){var a=new window.XML3DMatrix,
b=XML3D.math.mat4.create();XML3D.math.mat4.invert(b,this.viewMatrix);a._data.set(b);return a};f.getModelViewMatrix=function(a){return XML3D.math.mat4.multiply(XML3D.math.mat4.create(),this.viewMatrix,a)};f.getModelViewProjectionMatrix=function(a){return XML3D.math.mat4.multiply(XML3D.math.mat4.create(),this.projMatrix,a)};f.getWorldSpacePosition=function(){return this.worldPosition};f.notifyChanged=function(a){if(a.type==XML3D.events.ADAPTER_HANDLE_CHANGED&&!a.internalType)this.projMatrix=null;else{var d=
a.internalType||a.attrName||a.wrapped.attrName;switch(d){case "parenttransform":this.parentTransform=a.newValue;this.updateViewMatrix();break;case "orientation":case "position":this.updateViewMatrix();break;case "perspective":case "fieldOfView":b(this);this.projMatrix=null;break;default:XML3D.debug.logWarning("Unhandled event in view adapter for parameter "+d)}}this.factory.handler.redraw("View changed")};XML3D.webgl.ViewRenderAdapter=a})();
(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.renderer=this.factory.renderer;this.dataAdapter=XML3D.data.factory.getAdapter(this.node);this.computeRequest};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.notifyChanged=function(a){if(a.type==XML3D.events.NODE_INSERTED)this.factory.renderer.sceneTreeAddition(a);else if(a.type==XML3D.events.NODE_REMOVED)this.factory.renderer.sceneTreeRemoval(a);else if(a.type==XML3D.events.THIS_REMOVED)(a=a.wrapped.target)&&
"texture"==a.nodeName&&this.renderer.recompileShader(this);else switch(a=a.internalType||a.attrName||a.wrapped.attrName,a){case "script":this.renderer.recompileShader(this);break;default:XML3D.debug.logWarning("Unhandled mutation event in shader adapter for parameter '"+a+"'")}};a.requestData=function(a){if(!this.computeRequest){var b=this;this.computeRequest=this.dataAdapter.getComputeRequest(a,function(a,c){b.notifyDataChanged(a,c)})}return this.computeRequest.getResult()};a.notifyDataChanged=function(a,
b){this.renderer.shaderManager.shaderDataChanged(this,a,b)};a.destroy=function(){Array.forEach(this.textures,function(a){a.adapter.destroy()});this.computeRequest&&this.computeRequest.clear()};XML3D.webgl.ShaderRenderAdapter=b})();
(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.gl=a.renderer.handler.gl;this.factory=a;this.node=b;this.dataAdapter=XML3D.data.factory.getAdapter(this.node)};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){var b=this.factory.getAdapter(this.node.parentElement);b&&b.notifyChanged(a)};b.prototype.getDataTable=function(){return this.dataAdapter.createDataTable()};b.prototype.destroy=function(){this.info&&null!==this.info.handle&&(this.gl.deleteTexture(this.info.handle),
this.info=null,this.bind=function(){},this.unbind=function(){})};b.prototype.dispose=function(){};XML3D.webgl.TextureRenderAdapter=b})();XML3D.webgl.MAX_MESH_INDEX_COUNT=65535;
(function(){function b(a){var b=window.WebGLRenderingContext;a&&a.toLoweGLase&&(a=a.toLowerCase());switch(a){case "triangles":return b.TRIANGLES;case "tristrips":return b.TRIANGLE_STRIP;case "points":return b.POINTS;case "lines":return b.LINES;case "linestrips":return b.LINE_STRIP;default:return b.TRIANGLES}}var a={onclick:1,ondblclick:1,ondrop:1,ondragenter:1,ondragleave:1},f=["boundingBox"],d=function(a){this.vbos={};this.complete=this.isIndexed=!1;this.glType=b(a);this.bbox=new window.XML3DBox;
this.getVertexCount=function(){try{return this.isIndexed?this.vbos.index[0].length:void 0!==this.vertexCount?this.vertexCount[0]:this.vbos.position[0].length}catch(a){return 0}};this.update=g},e=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.processListeners();this.dataAdapter=XML3D.data.factory.getAdapter(this.node);this.parentVisible=!0;this.renderObject=null;this.requestObject={};this.bboxComputeRequest=this.computeRequest=null};XML3D.createClass(e,XML3D.webgl.RenderAdapter);var c=
e.prototype;c.applyTransformMatrix=function(a){this.renderObject.transform&&XML3D.math.mat4.multiply(a,a,this.renderObject.transform);return a};c.processListeners=function(){var b=this.node.attributes,c;for(c in b){var d=b[c];if(d.name){var e=d.name;(e.match(/onmouse/)||a[e])&&this.node.addEventListener(e.substring(2),new Function("evt",d.value),!1)}}};c.notifyChanged=function(a){if(a.type==XML3D.events.ADAPTER_HANDLE_CHANGED&&!a.internalType)"shader"==a.key&&(this.updateShader(a.adapter),a.handleStatus==
XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logWarning("Missing shader with id '"+a.url+"', falling back to default shader."));else if(a.type!=XML3D.events.NODE_INSERTED){if(a.type==XML3D.events.NODE_REMOVED)return this.factory.renderer.sceneTreeRemoval(a);if(a.type==XML3D.events.THIS_REMOVED)this.clearAdapterHandles();else{var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "parenttransform":this.renderObject.transform=a.newValue;break;case "parentshader":a=a.newValue;
this.setShaderHandle(a);this.updateShader(a?a.getAdapter():null);break;case "parentvisible":this.renderObject.visible=a.newValue&&this.node.visible;break;case "visible":this.renderObject.visible="true"==a.wrapped.newValue&&this.node.parentNode.visible;break;case "src":break;case "type":this.renderObject.mesh.glType=this.getGLTypeFromString(a.wrapped.newValue);break;default:XML3D.debug.logWarning("Unhandled mutation event in mesh adapter for parameter '"+b+"'",a)}}}};c.getShaderHandle=function(){return this.getConnectedAdapterHandle("shader")};
c.setShaderHandle=function(a){this.connectAdapterHandle("shader",a);a&&a.status==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find <shader> element of url '"+a.url)};c.updateShader=function(a){a=this.factory.renderer.shaderManager.createShader(a,this.factory.renderer.lights);this.renderObject.shader=a;XML3D.debug.logInfo("New shader, clearing requests: ",a);this.clearRequests();this.renderObject.materialChanged();this.factory.renderer.requestRedraw("Shader changed.",
!1)};var h=function(a,b,c){var d=a.createBuffer();a.bindBuffer(b,d);a.bufferData(b,c,a.STATIC_DRAW);d.length=c.length;a=window.WebGLRenderingContext;d.glType=c instanceof Int8Array?a.BYTE:c instanceof Uint8Array?a.UNSIGNED_BYTE:c instanceof Int16Array?a.SHORT:c instanceof Uint16Array?a.UNSIGNED_SHORT:c instanceof Int32Array?a.INT:c instanceof Uint32Array?a.UNSIGNED_INT:a.FLOAT;return d};c.createRequests=function(a,b){var c=this;this.computeRequest=this.computeRequest||this.dataAdapter.getComputeRequest(a,
function(a,b){c.dataChanged(a,b)});this.objectRequest=this.objectRequest||this.dataAdapter.getComputeRequest(b,function(a,b){XML3D.debug.logInfo("Per object shader attributes changes not handled yet",a,b)});this.bboxComputeRequest=this.bboxComputeRequest||this.dataAdapter.getComputeRequest(f)};c.clearRequests=function(){this.computeRequest&&this.computeRequest.clear();this.objectRequest&&this.objectRequest.clear();this.computeRequest=this.objectRequest=null};c.finishMesh=function(){var a=this.factory.renderer.shaderManager.getShaderById(this.renderObject.shader);
this.requestObject=a.material.meshRequest;this.createRequests(Object.keys(this.requestObject),Object.keys(a.uniforms));this.createMeshData();this.createPerObjectData();return this.renderObject.mesh.valid};var g=function(){};c.dataChanged=function(a,b){switch(b){case Xflow.RESULT_STATE.CHANGED_STRUCTURE:XML3D.debug.logInfo("Mesh structure changed",arguments);this.renderObject.can("dataStructureChanged")&&this.renderObject.dataStructureChanged();this.factory.renderer.requestRedraw("Mesh structure changed.");
break;case Xflow.RESULT_STATE.CHANGED_DATA:XML3D.debug.logInfo("Mesh values changed",arguments);this.renderObject.can("dataValueChanged")&&this.renderObject.dataValueChanged();this.factory.renderer.requestRedraw("Mesh values changed.");break;default:XML3D.debug.logInfo("Unknown state: "+b)}};c.createPerObjectData=function(){this.renderObject.setOverride(this.objectRequest.getResult())};c.createMeshData=function(){var a=this.renderObject;a.mesh=a.mesh||new d(this.node.type);var b=this.computeRequest.getResult();
a.mesh.valid=a.mesh.complete=!0;for(var c in this.requestObject){var e=this.requestObject[c]||{},f=b.getOutputData(c);if(!f||!f.getValue())e.required&&(XML3D.debug.logInfo("Mesh not complete, missing: ",c,f),a.mesh.complete=!1);else if("vertexCount"==c)a.mesh.vertexCount=f.getValue();else switch(f.type){case Xflow.DATA_TYPE.TEXTURE:this.handleTexture(c,f,a.shader,a.mesh);break;default:this.handleBuffer(c,e,f,a.mesh)}}(b=this.calcBoundingBox())&&a.mesh.bbox.set(b);a.mesh.valid=!0};c.handleBuffer=function(a,
b,c,d){var b=XML3D.webgl.getXflowEntryWebGlData(c,this.factory.canvasId),e=b.buffer,f=this.factory.renderer.gl;switch(b.changed){case Xflow.DATA_ENTRY_STATE.CHANGED_VALUE:var g="index"==a?f.ELEMENT_ARRAY_BUFFER:f.ARRAY_BUFFER;f.bindBuffer(g,e);f.bufferSubData(g,0,c.getValue());break;case Xflow.DATA_ENTRY_STATE.CHANGED_NEW:case Xflow.DATA_ENTRY_STATE.CHANGE_SIZE:e="index"==a?h(f,f.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.getValue())):h(f,f.ARRAY_BUFFER,c.getValue()),e.tupleSize=c.getTupleSize(),b.buffer=
e}d.vbos[a]=[];d.vbos[a][0]=e;d.isIndexed=d.isIndexed||"index"==a;b.changed=0};c.handleTexture=function(a,b,c,d){c=this.factory.renderer.shaderManager.getShaderById(c);d.sampler=d.sampler||{};d=XML3D.webgl.getXflowEntryWebGlData(b,this.factory.canvasId);d.changed&&a in c.samplers&&this.factory.renderer.shaderManager.createTextureFromEntry(b,c.samplers[a]);d.changed=0};c.destroy=function(){this.renderObject.dispose();this.computeRequest&&this.computeRequest.clear();this.bboxComputeRequest&&this.bboxComputeRequest.clear();
this.clearAdapterHandles()};c.getBoundingBox=function(){return new window.XML3DBox(this.renderObject.mesh.bbox)};c.getWorldMatrix=function(){var a=new window.XML3DMatrix,b=this.renderObject;b&&a._data.set(b.transform);return a};c.calcBoundingBox=function(){var a=new window.XML3DBox,b=this.bboxComputeRequest.getResult().getOutputData("boundingBox");if(b)return b=b.getValue(),a.extend(b[0]),a.extend(b[1]),a;var b=this.computeRequest.getResult(),c=b.getOutputData("position");if(!c)return a;a=c.getValue();
b=(b=b.getOutputData("index"))?b.getValue():null;return XML3D.webgl.calculateBoundingBox(a,b)};XML3D.webgl.MeshRenderAdapter=e})();
(function(){var b={onclick:1,ondblclick:1,ondrop:1,ondragenter:1,ondragleave:1},a=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.processListeners();this.factory=a;this.parentShaderHandle=this.parentTransform=null;this.isValid=this.parentVisible=!0;this.updateTransformAdapter()};XML3D.createClass(a,XML3D.webgl.RenderAdapter);var f=a.prototype;f.applyTransformMatrix=function(a){null!==this.parentTransform&&XML3D.math.mat4.multiply(a,this.parentTransform,a);var b=this.getLocalMatrixInternal();
b&&XML3D.math.mat4.multiply(a,a,b);return a};f.getLocalMatrixInternal=function(){var a=XML3D.css.getCSSMatrix(this.node);return a?XML3D.css.convertCssToMat4(a):(a=this.getConnectedAdapter("transform"))?a.getMatrix("transform"):null};f.updateTransformAdapter=function(){this.connectAdapterHandle("transform",this.getAdapterHandle(this.node.transform))};f.processListeners=function(){var a=this.node.attributes,c;for(c in a){var d=a[c];if(d.name){var f=d.name;(f.match(/onmouse/)||b[f])&&this.node.addEventListener(f.substring(2),
new Function("evt",d.value),!1)}}};f.notifyChanged=function(a){if(a.type==XML3D.events.NODE_INSERTED)this.factory.renderer.sceneTreeAddition(a);else if(a.type==XML3D.events.NODE_REMOVED)this.factory.renderer.sceneTreeRemoval(a);else if(a.type==XML3D.events.THIS_REMOVED)this.clearAdapterHandles();else if(a.type==XML3D.events.ADAPTER_HANDLE_CHANGED&&!a.internalType)this.propagateTransform(a);else{var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "shader":a.internalType="parentshader";
a.newValue=this.getShaderHandle();this.notifyChildren(a);this.factory.renderer.requestRedraw("Group shader changed.",!1);break;case "parentshader":this.parentShaderHandle=null;this.getShaderHandle()||this.notifyChildren(a);this.parentShaderHandle=a.newValue;break;case "transform":this.updateTransformAdapter();this.propagateTransform(a);break;case "parenttransform":this.parentTransform=b=d=a.newValue;var d,f=this.getLocalMatrixInternal();f&&(d=XML3D.math.mat4.multiply(XML3D.math.mat4.create(),b,f));
a.newValue=d;this.notifyChildren(a);a.newValue=b;break;case "visible":if(!1==this.parentVisible)break;else a.internalType="parentvisible",a.newValue="true"==a.wrapped.newValue,this.notifyChildren(a),delete a.internalType,delete a.newValue,this.factory.renderer.requestRedraw("Group visibility changed.",!0);break;case "parentvisible":this.parentVisible=a.newValue;if(!1==this.node.visible)break;else this.notifyChildren(a);break;default:XML3D.debug.logWarning("Unhandled mutation event in group adapter for parameter '"+
b+"'")}}};f.notifyChildren=function(a){for(var b=this.node.firstElementChild;b;){var d=this.factory.getAdapter(b);d&&d.notifyChanged(a);b=b.nextElementSibling}};f.propagateTransform=function(a){var b;b=(b=this.getLocalMatrixInternal())?b:this.parentTransform?XML3D.math.mat4.identity(XML3D.math.mat4.create()):null;this.parentTransform&&(b=XML3D.math.mat4.multiply(XML3D.math.mat4.create(),this.parentTransform,b));a.internalType="parenttransform";a.newValue=b;this.notifyChildren(a);delete a.internalType;
delete a.newValue;this.factory.renderer.requestRedraw("Group transform changed.",!0)};f.getShaderHandle=function(){var a=this.node.shader;if(""==a){var b=this.node.getAttribute("style");b&&(b=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(b))&&(a=b[1])}return a?this.getAdapterHandle(a):this.parentShaderHandle};f.destroy=function(){for(var a=this.node.firstElementChild;a;){var b=this.factory.getAdapter(a);b&&b.destroy&&b.destroy();a=a.nextElementSibling}this.isValid=!1};f.getBoundingBox=function(){var a=
new window.XML3DBox;Array.prototype.forEach.call(this.node.childNodes,function(b){b.getBoundingBox&&a.extend(b.getBoundingBox())});var b=this.getLocalMatrixInternal();b&&XML3D.webgl.transformAABB(a,b);return a};f.getLocalMatrix=function(){var a=new window.XML3DMatrix,b=this.getLocalMatrixInternal();b&&a._data.set(b);return a};var d=XML3D.math.mat4.create();f.getWorldMatrix=function(){var a=new window.XML3DMatrix;XML3D.math.mat4.identity(d);a._data.set(this.applyTransformMatrix(d));return a};XML3D.webgl.GroupRenderAdapter=
a})();
(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.visible=!0;this.lightShader=this.transform=null;this.renderer=a.renderer;this.offset=0;this.lightType="point";this.updateLightShader();this.listenerID=-1};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(b){if(b.type==XML3D.events.NODE_REMOVED)this.destroy();else if(b.type!=XML3D.events.THIS_REMOVED)if(b.type==XML3D.events.ADAPTER_HANDLE_CHANGED&&"shader"==b.key)b=this.renderer.lights,this.removeLight(b);
else{switch(b.internalType||b.wrapped.attrName){case "visible":this.visible="true"==b.wrapped.newValue&&this.node.parentNode.visible;this.renderer.changeLightData(this.lightType,"visibility",this.offset,this.visible?[1,1,1]:[0,0,0]);break;case "parentvisible":this.visible=b.newValue&&this.node.visible;this.renderer.changeLightData(this.lightType,"visibility",this.offset,this.visible?[1,1,1]:[0,0,0]);break;case "intensity":var b=this.intensity=b.wrapped.newValue,e=this.lightShader.requestParameter("intensity");
if(e)e=e.getValue();else return;this.renderer.changeLightData(this.lightType,"intensity",this.offset,[e[0]*b,e[1]*b,e[2]*b]);break;case "parenttransform":this.transform=b.newValue;"directional"==this.lightType?this.renderer.changeLightData(this.lightType,"direction",this.offset,this.applyTransformDir(a)):("spot"==this.lightType&&this.renderer.changeLightData(this.lightType,"direction",this.offset,this.applyTransformDir(f)),this.renderer.changeLightData(this.lightType,"position",this.offset,this.applyTransform([0,
0,0])));break;case "shader":b=this.renderer.lights,this.removeLight(b),this.updateLightShader(),this.addLight(b)}this.factory.handler.redraw("Light attribute changed.")}};var a=XML3D.math.vec3.fromValues(0,0,-1);XML3D.math.vec3.create();var f=XML3D.math.vec3.fromValues(0,0,1);b.prototype.applyTransform=function(a){if(this.transform){var b=this.transform,a=XML3D.math.vec4.transformMat4(XML3D.math.vec4.create(),[a[0],a[1],a[2],1],b);return[a[0]/a[3],a[1]/a[3],a[2]/a[3]]}return a};b.prototype.applyTransformDir=
function(a){if(this.transform){var b=this.transform,a=XML3D.math.vec4.transformMat4(XML3D.math.vec4.create(),[a[0],a[1],a[2],0],b);return[a[0],a[1],a[2]]}return a};b.prototype.addLight=function(b){this.callback=b.dataChanged;var e=this.getLightShader();if(e){var c;this.listenerID=e.registerLightListener(this.dataChanged.bind(this));c=e.node.script;if(0===c.indexOf("urn:xml3d:lightshader:"))switch(c.substring(22,c.length)){case "point":c=b.point;this.offset=3*c.length;this.lightType="point";Array.set(c.position,
this.offset,this.applyTransform([0,0,0]));Array.set(c.visibility,this.offset,this.visible?[1,1,1]:[0,0,0]);e.fillPointLight(c,this.node.intensity,this.offset);c.length++;break;case "directional":c=b.directional;this.offset=3*c.length;this.lightType="directional";Array.set(c.direction,this.offset,this.applyTransformDir(a));Array.set(c.visibility,this.offset,this.visible?[1,1,1]:[0,0,0]);e.fillDirectionalLight(c,this.node.intensity,this.offset);c.length++;break;case "spot":c=b.spot;this.offset=3*c.length;
this.lightType="spot";Array.set(c.position,this.offset,this.applyTransform([0,0,0]));Array.set(c.direction,this.offset,this.applyTransformDir(f));Array.set(c.visibility,this.offset,this.visible?[1,1,1]:[0,0,0]);e.fillSpotLight(c,this.node.intensity,this.offset);c.length++;break;default:XML3D.debug.logWarning("Unsupported lightshader type: "+c)}b.changed=!0;b.structureChanged=!0}};b.prototype.removeLight=function(a){var b=a[this.lightType],c=this.getLightShader();if(c){switch(this.lightType){case "point":b.position.splice(this.offset,
3);break;case "directional":b.direction.splice(this.offset,3);break;case "spot":b.position.splice(this.offset,3),b.direction.splice(this.offset,3)}b.visibility.splice(this.offset,3);c.removeLight(this.lightType,a,this.offset);c.removeLightListener(this.listenerID);b.length--;a.changed=!0;a.structureChanged=!0}};b.prototype.updateLightShader=function(){var a=this.node.shader;if(!a){var b=this.node.getAttribute("style");b&&(b=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(b))&&(a=b[1])}this.connectAdapterHandle("shader",
this.getAdapterHandle(a))};b.prototype.getLightShader=function(){return this.getConnectedAdapter("shader")};b.prototype.dispose=function(){this.isValid=!1};b.prototype.destroy=function(){this.clearAdapterHandles()};b.prototype.destroy=function(){this.removeLight(this.renderer.lights)};b.prototype.getWorldMatrix=function(){var a=new window.XML3DMatrix;a._data.set(this.transform);return a};b.prototype.dataChanged=function(a,b){this.renderer.changeLightData(this.lightType,a,this.offset,b)};XML3D.webgl.LightRenderAdapter=
b})();
(function(){var b=function(a,b){XML3D.base.NodeAdapterFactory.call(this,XML3D.webgl,a.id);this.handler=a;this.renderer=b;this.type="RenderAdapterFactory"};XML3D.createClass(b,XML3D.base.NodeAdapterFactory);var a=XML3D.webgl,f={xml3d:a.XML3DRenderAdapter,view:a.ViewRenderAdapter,defs:a.DefsRenderAdapter,mesh:a.MeshRenderAdapter,data:a.DataRenderAdapter,transform:a.TransformRenderAdapter,shader:a.ShaderRenderAdapter,texture:a.TextureRenderAdapter,group:a.GroupRenderAdapter,img:a.ImgRenderAdapter,light:a.LightRenderAdapter,
lightshader:a.LightShaderRenderAdapter};b.prototype.createAdapter=function(a){var b=f[a.localName];return void 0!==b?new b(this,a):null};XML3D.webgl.RenderAdapterFactory=b})();(function(){var b={},a={};b.register=function(b,d){a[b]=d;d.name=b};b.getScript=function(b){return a[b]};XML3D.shaders=b})();
XML3D.shaders.register("matte",{vertex:"attribute vec3 position;\nattribute vec3 color;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n   fragVertexColor = color;\n   gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 diffuseColor;\nuniform bool useVertexColor;\nvarying vec3 fragVertexColor;\nvoid main(void) {\n    vec3 color = diffuseColor;\n    if (useVertexColor)\n       color *=  fragVertexColor;\n    gl_FragColor = vec4(diffuseColor, 1.0);\n}",
uniforms:{diffuseColor:[1,1,1],useVertexColor:!1}});XML3D.shaders.register("flat",XML3D.shaders.getScript("matte"));
XML3D.shaders.register("diffuse",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = texcoord;\n    fragVertexColor = color;\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float transparency;\nuniform mat4 viewMatrix;\nuniform bool useVertexColor;\n#if HAS_EMISSIVETEXTURE\nuniform sampler2D emissiveTexture;\n#endif\n#if HAS_DIFFUSETEXTURE\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\n#if MAX_POINTLIGHTS > 0\nuniform vec3 pointLightAttenuation[MAX_POINTLIGHTS];\nuniform vec3 pointLightPosition[MAX_POINTLIGHTS];\nuniform vec3 pointLightIntensity[MAX_POINTLIGHTS];\nuniform vec3 pointLightVisibility[MAX_POINTLIGHTS];\n#endif\n#if MAX_DIRECTIONALLIGHTS > 0\nuniform vec3 directionalLightDirection[MAX_DIRECTIONALLIGHTS];\nuniform vec3 directionalLightIntensity[MAX_DIRECTIONALLIGHTS];\nuniform vec3 directionalLightVisibility[MAX_DIRECTIONALLIGHTS];\n#endif\n#if MAX_SPOTLIGHTS > 0\nuniform vec3 spotLightAttenuation[MAX_SPOTLIGHTS];\nuniform vec3 spotLightPosition[MAX_SPOTLIGHTS];\nuniform vec3 spotLightIntensity[MAX_SPOTLIGHTS];\nuniform vec3 spotLightVisibility[MAX_SPOTLIGHTS];\nuniform vec3 spotLightDirection[MAX_SPOTLIGHTS];\nuniform float spotLightCosFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightCosSoftFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightSoftness[MAX_SPOTLIGHTS];\n#endif\nvoid main(void) {\n  float alpha =  max(0.0, 1.0 - transparency);\n  vec3 objDiffuse = diffuseColor;\n  if(useVertexColor)\n    objDiffuse *= fragVertexColor;\n  #if HAS_DIFFUSETEXTURE\n    vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n    alpha *= texDiffuse.a;\n    objDiffuse *= texDiffuse.rgb;\n  #endif\n  if (alpha < 0.05) discard;\n  #if HAS_EMISSIVETEXTURE\n    vec3 color = emissiveColor * texture2D(emissiveTexture, fragTexCoord).rgb + (ambientIntensity * objDiffuse);\n  #else\n    vec3 color = emissiveColor + (ambientIntensity * objDiffuse);\n  #endif\n  #if MAX_POINTLIGHTS > 0\n    for (int i=0; i<MAX_POINTLIGHTS; i++) {\n      vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\n      vec3 L = lPosition.xyz - fragVertexPosition;\n      float dist = length(L);\n      L = normalize(L);\n      float atten = 1.0 / (pointLightAttenuation[i].x + pointLightAttenuation[i].y * dist + pointLightAttenuation[i].z * dist * dist);\n      vec3 Idiff = pointLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n      color = color + (atten*Idiff) * pointLightVisibility[i];\n    }\n  #endif\n#if MAX_DIRECTIONALLIGHTS > 0\n  for (int i=0; i<MAX_DIRECTIONALLIGHTS; i++) {\n    vec4 lDirection = viewMatrix * vec4(directionalLightDirection[i], 0.0);\n    vec3 L =  normalize(-lDirection.xyz);\n    vec3 Idiff = directionalLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    color = color + (Idiff * directionalLightVisibility[i]);\n  }\n#endif\n#if MAX_SPOTLIGHTS > 0\n  for (int i=0; i<MAX_SPOTLIGHTS; i++) {\n    vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\n    vec3 L = lPosition.xyz - fragVertexPosition;\n    float dist = length(L);\n    L = normalize(L);\n    float atten = 1.0 / (spotLightAttenuation[i].x + spotLightAttenuation[i].y * dist + spotLightAttenuation[i].z * dist * dist);\n    vec3 Idiff = spotLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    float spot = 0.0;\n    vec4 lDirection = viewMatrix * vec4(spotLightDirection[i], 0.0);\n    vec3 D = normalize(lDirection.xyz);\n    float angle = dot(L, D);\n    if(angle > spotLightCosFalloffAngle[i]) {\n       float softness = 1.0;\n       if (angle < spotLightCosSoftFalloffAngle[i])\n           softness = (angle - spotLightCosFalloffAngle[i]) /  (spotLightCosSoftFalloffAngle[i] -  spotLightCosFalloffAngle[i]);\n       color += (atten*softness*Idiff) * spotLightVisibility[i];\n    }\n  }\n#endif\n  gl_FragColor = vec4(color, alpha);\n}",
addDirectives:function(b,a,f){var d=a.directional?a.directional.length:0,e=a.spot?a.spot.length:0;b.push("MAX_POINTLIGHTS "+(a.point?a.point.length:0));b.push("MAX_DIRECTIONALLIGHTS "+d);b.push("MAX_SPOTLIGHTS "+e);b.push("HAS_DIFFUSETEXTURE "+("diffuseTexture"in f?"1":"0"));b.push("HAS_EMISSIVETEXTURE "+("emissiveTexture"in f?"1":"0"))},hasTransparency:function(b){return b.transparency&&0.001<b.transparency.getValue()[0]},uniforms:{diffuseColor:[1,1,1],emissiveColor:[0,0,0],transparency:0,ambientIntensity:0,
useVertexColor:!1},samplers:{diffuseTexture:null,emissiveTexture:null}});
XML3D.shaders.register("phong",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = texcoord;\n    fragVertexColor = color;\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nuniform mat4 viewMatrix;\nuniform bool useVertexColor;\n#if HAS_EMISSIVETEXTURE\nuniform sampler2D emissiveTexture;\n#endif\n#if HAS_DIFFUSETEXTURE\nuniform sampler2D diffuseTexture;\n#endif\n#if HAS_SPECULARTEXTURE\nuniform sampler2D specularTexture;\n#endif\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\n#if MAX_POINTLIGHTS > 0\nuniform vec3 pointLightAttenuation[MAX_POINTLIGHTS];\nuniform vec3 pointLightPosition[MAX_POINTLIGHTS];\nuniform vec3 pointLightIntensity[MAX_POINTLIGHTS];\nuniform vec3 pointLightVisibility[MAX_POINTLIGHTS];\n#endif\n#if MAX_DIRECTIONALLIGHTS > 0\nuniform vec3 directionalLightDirection[MAX_DIRECTIONALLIGHTS];\nuniform vec3 directionalLightIntensity[MAX_DIRECTIONALLIGHTS];\nuniform vec3 directionalLightVisibility[MAX_DIRECTIONALLIGHTS];\n#endif\n#if MAX_SPOTLIGHTS > 0\nuniform vec3 spotLightAttenuation[MAX_SPOTLIGHTS];\nuniform vec3 spotLightPosition[MAX_SPOTLIGHTS];\nuniform vec3 spotLightIntensity[MAX_SPOTLIGHTS];\nuniform vec3 spotLightVisibility[MAX_SPOTLIGHTS];\nuniform vec3 spotLightDirection[MAX_SPOTLIGHTS];\nuniform float spotLightCosFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightCosSoftFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightSoftness[MAX_SPOTLIGHTS];\n#endif\nvoid main(void) {\n  float alpha =  max(0.0, 1.0 - transparency);\n  vec3 objDiffuse = diffuseColor;\n  if(useVertexColor)\n    objDiffuse *= fragVertexColor;\n  #if HAS_DIFFUSETEXTURE\n    vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n    alpha *= texDiffuse.a;\n    objDiffuse *= texDiffuse.rgb;\n  #endif\n  if (alpha < 0.05) discard;\n  #if HAS_EMISSIVETEXTURE\n    vec3 color = emissiveColor * texture2D(emissiveTexture, fragTexCoord).rgb + (ambientIntensity * objDiffuse);\n  #else\n    vec3 color = emissiveColor + (ambientIntensity * objDiffuse);\n  #endif\n  vec3 objSpecular = specularColor;\n  #if HAS_SPECULARTEXTURE\n    objSpecular = objSpecular * texture2D(specularTexture, fragTexCoord).rgb;\n  #endif\n  #if MAX_POINTLIGHTS > 0\n    for (int i=0; i<MAX_POINTLIGHTS; i++) {\n      vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\n      vec3 L = lPosition.xyz - fragVertexPosition;\n      float dist = length(L);\n      L = normalize(L);\n      vec3 R = normalize(reflect(L,fragNormal));\n      float atten = 1.0 / (pointLightAttenuation[i].x + pointLightAttenuation[i].y * dist + pointLightAttenuation[i].z * dist * dist);\n      vec3 Idiff = pointLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n      vec3 Ispec = pointLightIntensity[i] * objSpecular * pow(max(dot(R,fragEyeVector),0.0), shininess*128.0);\n      color = color + (atten*(Idiff + Ispec)) * pointLightVisibility[i];\n    }\n  #endif\n#if MAX_DIRECTIONALLIGHTS > 0\n  for (int i=0; i<MAX_DIRECTIONALLIGHTS; i++) {\n    vec4 lDirection = viewMatrix * vec4(directionalLightDirection[i], 0.0);\n    vec3 L =  normalize(-lDirection.xyz);\n    vec3 R = normalize(reflect(L,fragNormal));\n    vec3 Idiff = directionalLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    vec3 Ispec = directionalLightIntensity[i] * objSpecular * pow(max(dot(R,fragEyeVector),0.0), shininess*128.0);\n    color = color + ((Idiff + Ispec)) * directionalLightVisibility[i];\n  }\n#endif\n#if MAX_SPOTLIGHTS > 0\n  for (int i=0; i<MAX_SPOTLIGHTS; i++) {\n    vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\n    vec3 L = lPosition.xyz - fragVertexPosition;\n    float dist = length(L);\n    L = normalize(L);\n    vec3 R = normalize(reflect(L,fragNormal));\n    float atten = 1.0 / (spotLightAttenuation[i].x + spotLightAttenuation[i].y * dist + spotLightAttenuation[i].z * dist * dist);\n    vec3 Idiff = spotLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    vec3 Ispec = spotLightIntensity[i] * objSpecular * pow(max(dot(R,fragEyeVector),0.0), shininess*128.0);\n    float spot = 0.0;\n    vec4 lDirection = viewMatrix * vec4(spotLightDirection[i], 0.0);\n    vec3 D = normalize(lDirection.xyz);\n    float angle = dot(L, D);\n    if(angle > spotLightCosFalloffAngle[i]) {\n       float softness = 1.0;\n       if (angle < spotLightCosSoftFalloffAngle[i])\n           softness = (angle - spotLightCosFalloffAngle[i]) /  (spotLightCosSoftFalloffAngle[i] -  spotLightCosFalloffAngle[i]);\n       color += atten*softness*(Idiff + Ispec) * spotLightVisibility[i];\n    }\n  }\n#endif\n  gl_FragColor = vec4(color, alpha);\n}",
addDirectives:function(b,a,f){var d=a.directional?a.directional.length:0,e=a.spot?a.spot.length:0;b.push("MAX_POINTLIGHTS "+(a.point?a.point.length:0));b.push("MAX_DIRECTIONALLIGHTS "+d);b.push("MAX_SPOTLIGHTS "+e);b.push("HAS_DIFFUSETEXTURE "+("diffuseTexture"in f?"1":"0"));b.push("HAS_SPECULARTEXTURE "+("specularTexture"in f?"1":"0"));b.push("HAS_EMISSIVETEXTURE "+("emissiveTexture"in f?"1":"0"))},hasTransparency:function(b){return b.transparency&&0.001<b.transparency.getValue()[0]},uniforms:{diffuseColor:[1,
1,1],emissiveColor:[0,0,0],specularColor:[0,0,0],transparency:0,shininess:0.2,ambientIntensity:0,useVertexColor:!1},samplers:{diffuseTexture:null,emissiveTexture:null,specularTexture:null}});
XML3D.shaders.register("pickobjectid",{vertex:"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 id;\nvoid main(void) {\n    gl_FragColor = vec4(id, 0.0);\n}",uniforms:{}});
XML3D.shaders.register("pickedposition",{vertex:"attribute vec3 position;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 min;\nuniform vec3 max;\nvarying vec3 worldCoord;\nvoid main(void) {\n    worldCoord = (modelMatrix * vec4(position, 1.0)).xyz;\n    vec3 diff = max - min;\n    worldCoord = worldCoord - min;\n    worldCoord = worldCoord / diff;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec3 worldCoord;\nvoid main(void) {\n    gl_FragColor = vec4(worldCoord, 1.0);\n}",
uniforms:{}});
XML3D.shaders.register("pickedNormals",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat3 normalMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    fragNormal = normalize(normalMatrix * normal);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4((fragNormal+1.0)/2.0 * (254.0 / 255.0), 1.0);\n}",uniforms:{}});